(function(){var p,r,wt;try{var n=window.$MicrosoftMaps8,s=n.Internal,kt=n.BasicMapAnimation,si=s._Binding,hi=s._BoundsAccumulator,dt=s._ComponentNames,g=n.CompositeModeHelper,e=s._Debug,ci=s._Dispatcher,tt=s._Gimme,v=n.GlobalConfig,o=s._Helper,ot=n.ImageryMapLayer,ut=s._JSEvent,it=n.LocationRect,gt=s._LoggerConstants,st=s._LruCache,li=s._MapAuthentication,ai=s.MapHelper,vi=n.MapLayer,i=n.Location,f=n.MapMath,a=n.MapTypeId,b=n.MapView,y=n.Matrix2D,nt=s._Network,ht=s._Observable,yi=s._ObservableCollection,pi=s._ObservableObjectChangedArgs,l=n.Point,wi=n.PooledImage,ft=n.Rectangle,ni=n.SimplePointPrimitive,k=n.Size,ct=n.LabelVisibility,lt=n.VectorMapLayer,h=s._VectorMath,t=n.ZoomLevel,ti=s._Url,at=function(){function n(n,t,i,r){if(n<0)throw"Viewport.ctor - pixelWidth cannot be less than zero";if(t<0)throw"Viewport.ctor - pixelHeight cannot be less than zero";this.pixelWidth=n;this.pixelHeight=t;this.bounds=i;this.crs=r;var e=Math.abs((r.bounds[1]-r.bounds[3])/(i[1]-i[3]))*n,o=Math.abs((r.bounds[2]-r.bounds[0])/(i[2]-i[0]))*t,u=(e-n)/2,f=(o-t)/2;this._min_x=-u;this._max_x=n+u;this._min_y=-f;this._max_y=t+f}return n.fromIProjectedRegionId=function(t){return new n(t.pixelWidth,t.pixelHeight,t.bounds,t.crs)},n.prototype.toCrs=function(){return this.pixelWidth>0&&this.pixelHeight>0?new y((this.bounds[1]-this.bounds[3])/this.pixelWidth,0,0,(this.bounds[2]-this.bounds[0])/this.pixelHeight,this.bounds[3],this.bounds[0]):y.identity},n.prototype.fromCrs=function(){return this.toCrs().invert()},n.prototype.transform=function(n){var t=y.identity;return this.crs.id!==n.crs.id&&(t=n.crs.getMatrix(u.instance).invert().multiply(this.crs.getMatrix(u.instance))),n.fromCrs().multiply(t.multiply(this.toCrs()))},n.prototype.normalize=function(n){return(n.x<this._min_x||n.x>this._max_x)&&(n.x=h.wrap(n.x,this._min_x,this._max_x)),n},n}(),ii=function(){function n(n,t,i,r,f,o,s){this._dispatchRenderKey="CompositeMapModeRender";this.allowBoxZoom=!0;var h=s;if(!h||typeof h=="string")switch(h){case"Robinson":s=wt.instance;break;case"Mercator":default:s=u.instance}e.assertNotNull(n,"map");e.assertIsFunction(f,"tilePyramidFactory");e.assert(s&&s.bounds&&s.bounds.length===4&&s.bounds[0]===0&&s.bounds[1]===1&&s.bounds[2]===1&&s.bounds[3]===0,"Only supports cube based CRSs currently");this._map=n;this._dispatcher=o;this._allLayers=t;this._tilePlacement=i;this._hitTestController=r;this._tilePyramidFactory=f;this._crs=s;this._disposables=[];this._pyramidCache=new st(32);this._pyramidDisposables=[];this.mapModeType=0;this.onFrameRendered=new ut;this.onFrameFailed=new ut;this.onPaint=new ut;this._hitTestController.startHitTesting(this._map.getRootElement(),this._tilePlacement.getRootElement())}return n.prototype.getTilePyramid=function(){return this._tilePyramid},n.prototype.getDisplayName=function(){return this._crs.id},n.prototype.tryPointToLocation=function(n,r){r=r||this._map.getView();this._tilePyramid||this._updatePyramids(2);var u=this._tilePyramid.getCrs(),f=r.cameraLocation,v=t.fromLocation(f,!0),e=this._tilePyramid.getViewportSize(),y=(u.heading||0)-r.heading,o=new l(u.projectToX(f.latitude,f.longitude),u.projectToY(f.latitude,f.longitude)),s=Math.pow(2,v),p=s*this._tilePyramid.getTileWidth(),w=s*this._tilePyramid.getTileHeight(),b=(n.x-e.width/2)/p,k=(n.y-e.height/2)/w;n=h.rotatePoint(b,k,-h.degreesToRadians(y));var c=o.x+n.x,a=o.y+n.y,d=u.toLatitude(c,a),g=i.normalizeLongitude(u.toLongitude(c,a));return new i(d,g)},n.prototype.tryLocationToPoint=function(n,r){var w,b,k,d,a;r=r||this._map.getView();this._tilePyramid||(this._updatePyramids(2),e.assertNotNull(this._tilePyramid,"_tilePyramid"));var s=this._tilePyramid.getCrs(),c=r.cameraLocation,g=t.fromLocation(c,!0),nt=(s.heading||0)-r.heading,y=Math.pow(2,g),u=y*this._tilePyramid.getTileWidth(),tt=y*this._tilePyramid.getTileHeight(),v=new l(s.projectToX(c.latitude,c.longitude),s.projectToY(c.latitude,c.longitude)),p=v.x*u,f=(s.projectToX(n.latitude,n.longitude)-v.x)*u,it=(s.projectToY(n.latitude,n.longitude)-v.y)*tt,o=this._tilePyramid.getViewportSize();return p-o.width/2<0&&(w=new l(0,0),b=this.tryPointToLocation(w,r),i.normalizeLongitude(n.longitude)>b.longitude&&(f-=u)),p+o.width/2>u&&(k=new l(o.width,0),d=this.tryPointToLocation(k,r),i.normalizeLongitude(n.longitude)<d.longitude&&(f+=u)),o.width>u&&(f>u/2?f-=u:f<-u/2&&(f+=u)),a=h.rotatePoint(f,it,h.degreesToRadians(nt)),a.x+=o.width/2,a.y+=o.height/2,a},n.prototype.getMapViewForLocationsInView=function(n,t,i){var u;if(e.assertNotNull(this._tilePyramid,"this._tilePyramid"),!n)throw"The 'locations' parameter cannot be null or undefined.";var r=this._map.getViewportPadding(),t=t||{},f={left:r.left+(t.left||0),top:r.top+(t.top||0),right:r.right+(t.right||0),bottom:r.bottom+(t.bottom||0)};return i||(u=this._map.getViewport(),e.assertNotNull(u,"viewport"),i=new k(u.pixelWidth,u.pixelHeight)),g.getMapViewForLocationsInView(this._tilePyramid.getCrs(),this._tilePyramid.getTileWidth(),this._tilePyramid.getTileHeight(),i,f,n)},n.prototype.getMapViewWithBounds=function(n,t){var u;if(e.assertNotNull(this._tilePyramid,"this._tilePyramid"),!n)throw"The 'bounds' parameter cannot be null or undefined.";t=t||{};var i=this._map.getViewportPadding(),f={left:i.left+(t.left||0),top:i.top+(t.top||0),right:i.right+(t.right||0),bottom:i.bottom+(t.bottom||0)},r=this._map.getViewport();return e.assertNotNull(r,"viewport"),u=new k(r.pixelWidth,r.pixelHeight),g.getMapViewWithBounds(this._tilePyramid.getCrs(),this._tilePyramid.getTileWidth(),this._tilePyramid.getTileHeight(),u,f,n)},n.prototype.getMapViewZoomedAboutLocation=function(n,t,i,r){var u=this.tryLocationToPoint(t,n);return this.getMapViewZoomedAboutLocationAtPoint(n,t,u,i,r)},n.prototype.getMapViewZoomedAboutLocationAtPoint=function(n,r,u,e,o){var l=t.fromLocation(new i(r.latitude,r.longitude,n.cameraLocation.altitude),!0),s=f.roundToInterval(l+e,o),h=this._map.getMapType(),c;return s=Math.min(h.maxZoom,Math.max(s,h.minZoom)),c=this.getCameraForLocationToPoint(r,u,t.toAltitude(null,s,!0),0),new b(c,n.heading)},n.prototype.getCameraForLocationToPoint=function(n,t,r,u,f){var e=this._tilePyramid,s=e.getCrs(),h=e.getTileWidth(),c=e.getTileHeight(),o;return e.getHeading()===0&&(o=new b(new i(0,0,r,0)),d.enforceMinZoom(this._map,o)&&(r=o.cameraLocation.altitude)),g.getCameraForLocationToPoint(s,h,c,f?f:e.getViewportSize(),e.getHeading(),n,t,r,u)},n.prototype.getCurrentScenes=function(n){for(var i,e,u,f=[],o=t.fromLocation(n.cameraLocation,!0),s=t.toScale(n.cameraLocation,o,!0),r=0,h=this._allLayers.length;r<h;r++)i=this._allLayers[r],i instanceof ot&&i.getVisible()&&(e=i,u=e.getScene(null,n.cameraLocation,s,n.heading),u&&f.push(u));return f},n.prototype.getCopyrights=function(n){function i(t){s--;t&&t.length&&t.length!==0&&(t=t.filter(function(n){return u.indexOf(n)===-1}),Array.prototype.push.apply(u,t));s||n(u)}var r=this,u=[],f=this._map.getView(),e=t.fromLocation(f.cameraLocation,!0),o=this.getCurrentScenes(f),s=o.length;o.forEach(function(n){if(n.copyrightProvider){var t=null;n.crs instanceof c?r._map.getBirdseyeV2Manager().then(function(u){t=u.getUpdatedProductId(n.crs);t?n.copyrightProvider.getCopyrights(t,r._map.getBounds().bounds,e,n.crs.heading,i):t===""&&i([])}):n.copyrightProvider.getCopyrights(t,r._map.getBounds().bounds,e,n.crs.heading,i)}else i([])})},n.prototype._clearTileCache=function(n){this._tilePyramid&&this._tilePyramid.clearTileCache(n)},n.prototype.activated=function(){var t=this,n=this._map,i;this._renderQueued=!1;this._disposables.push(this._allLayers.changed.addThrottled(function(){return t._layersChanged()},5),n.boxZoomStarted.add(function(n){return t._boxZoomStarted(n)}),n.boxZoomContinued.add(function(n){return t._boxZoomContinued(n)}),n.boxZoomStopped.add(function(n){return t._boxZoomStopped(n)}),n.boxZoomCancelled.add(function(){return t._boxZoomCancelled()}),n.viewChanging.add(function(n){return t._onViewChanging(n)}),n.viewChanged.add(function(){return t._updatePyramids(2)}),n.constrainView.add(function(n){return t._constrainView(n)}),n.mapTypeChanged.add(function(){return t._clearTileCache()}));n.getLabelController()?this._subscribeToLabelControllerLabelsEnabledEvent():this._disposables.push(n.labelControllerLoaded.addOne(function(){t._subscribeToLabelControllerLabelsEnabledEvent()}));i=n.getFrameManager();i?this._attachFrameManagerEvents(i):n.frameManagerLoaded.addOne(function(){return t._attachFrameManagerEvents(n.getFrameManager())});this._disposables.push(n.changed.add(function(n){n.name==="actualSize"&&(t._updatePyramids(2),t._invalidateView(!1,!0,!0))}));e.groupCollapsed(null,"Map Mode Activated: Update Pyramid");this._updatePyramids(2);e.groupEnd();e.groupCollapsed(null,"Map Mode Activated: Composite mode Render");this._invalidateView(!1,!0,!0);e.groupEnd()},n.prototype._attachFrameManagerEvents=function(n){var t=this;this._disposables.push(n.frameSet.add(function(n){return t._onFrameSet(n)}),n.layerDataLoaded.add(function(n){return t._onLayerDataLoaded(n)}),n.frameRendered.add(function(){return t._onFrameManagerFrameRendered()}),n.mapReady.addOne(function(){return t._onMapReady()}))},n.prototype._subscribeToLabelControllerLabelsEnabledEvent=function(){var n=this;this._disposables.push(this._map.getLabelController().changed.add(function(t){var i,o,u;if(t.name==="isLabelsEnabled"&&(n._map.getMapType().id===a.birdseye||n._map.getMapType().id===a.aerial||n._map.getMapType().id===a.road)){n._clearTileCache(!0);var r=n._tilePyramid,s=n._pyramidCache,f=s.getInternalDictionary(),e=Object.keys(f);for(i=0,o=e.length;i<o;i++)u=f[e[i]].item,u!==r&&u.dispose();n._pyramidCache.clear();n._pyramidCache.addItem(r.getCrs().id,r);n._invalidateView(!1,!0,!0)}}))},n.prototype.deactivated=function(){this._clearTileCache();for(var n=this._disposables.length;n--;)this._disposables[n].dispose();this._disposables=[];this._dispatcher&&this._dispatcher.cancelDispatchWithKey(this._dispatchRenderKey)},n.prototype.dispose=function(){this.deactivated();this._tilePlacement&&(this._tilePlacement.dispose(),this._tilePlacement=null);this._hitTestController&&(this._hitTestController.dispose(),this._hitTestController=null);o._clearDisposables(this._pyramidDisposables);this._tilePyramid&&(this._tilePyramid.dispose(),this._tilePyramid=null);this._prevPyramid&&(this._prevPyramid.dispose(),this._prevPyramid=null);this._rootElement&&(this._leftMarginElement=null,this._rightMarginElement=null,this._topMarginElement=null,this._bottomMarginElement=null,this._rootElement.clear(),this._rootElement.removeFromParent(),this._rootElement=null);this._focusDiv&&(this._focusDiv.removeFromParent(),this._focusDiv=null);this._allLayers=null;this._pyramidCache.clear();this._map=null;this._dispatcher=null},n.prototype.invalidateLabels=function(){this._invalidateView(!1,!0,!1)},n.prototype.getRootElement=function(){var n=this,t;return this._rootElement||(this._rootElement=o._createElement("div"),this._rootElement.add_class("ms-composite"),this._rootElement.set_attr("tabindex","0"),this._rootElement.append(this._tilePlacement.getRootElement()),v.isMapsVertical||this._rootElement.set_attr("dir","ltr"),this._focusDiv||(this._rootElement.set_attr("tabindex","-1"),this._focusDiv=o._createElement("div"),v.isMapsAnswer||this._focusDiv.set_attr("tabindex","0"),this._focusDiv.set_attr("id","mapFocus"),this._focusDiv.set_attr("aria-label","Map"),t=this._map.getActualSize(),this._focusDiv.set_style({top:"1px",left:"1px","z-index":"0",position:"absolute",width:t.width-2,height:t.height-2}),this._focusDiv.add_event("focus",function(t){t.relatedTarget&&n._focusDiv[0].focus()}),this._map.actualSizeChanged.add(function(){var t=n._map.getActualSize();t&&n._focusDiv.set_style({width:t.width-2,height:t.height-2})}),this._rootElement.append(this._focusDiv))),this._rootElement},n.prototype.getMinAltitude=function(){var i=this._map.getMapType(),u=i&&i.maxZoom||n._maxZoom,r;return i&&i.id===a.birdseyeV2&&(r=this._tilePyramid&&this._tilePyramid.getCrs(),r&&r.sceneMetadata&&(u=Math.min(u,r.sceneMetadata.endingZoomLevel))),t.toAltitude(null,u,!0)},n.prototype._ensureLeftRightMarginElements=function(){this._rightMarginElement||(this._rightMarginElement=this._createLetterBoxElement());this._leftMarginElement||(this._leftMarginElement=this._createLetterBoxElement())},n.prototype._ensureTopBottomMarginElements=function(){this._topMarginElement||(this._topMarginElement=this._createLetterBoxElement());this._bottomMarginElement||(this._bottomMarginElement=this._createLetterBoxElement())},n.prototype._createLetterBoxElement=function(){var n=o._createElement("div");return n.add_class("letterbox"),n.set_style({position:"absolute","z-index":"10","background-color":this._map.getMapOptions().backgroundColor||"#EBE9E2",top:"0",left:"0"}),this.getRootElement().append(n),n},n.prototype._onViewChanging=function(n){e.groupCollapsed(null,"Composite mode: View changing event triggered");this._updatePyramids(1);this._invalidateView(n.isInAnimation,!0,!0);e.groupEnd()},n.prototype._layersChanged=function(){for(var i,n=0,t=0,r=this._allLayers.length;t<r;t++)i=this._allLayers[t],n=Math.max(n,i.hitTestingGraceRadius?i.hitTestingGraceRadius:0);this._hitTestController.graceRadiusForMouse=n;this._updatePyramids(2)},n.prototype._updatePyramids=function(n){function b(){for(var i,u,t,n=null,r=0,f=h._allLayers.length;r<f;r++)i=h._allLayers[r],i instanceof ot&&i.getVisible()&&(u=i,t=u.getScene(n,a,p,l.heading),t&&(n&&t.crs!==n?t=null:n=t.crs));return n||h._crs}var s=this,h=this,l=this._map.getView(),i,v,f;if(l){var a=l.cameraLocation,r=t.fromLocation(a,!0),p=t.toScale(a,r,!0);if(e.log(null,"Update pyramid to zoom: {0}",r.toString()),i=b(),v=i.version&&this._currentCrsVersion!==i.version,!this._tilePyramid||this._tilePyramid.getCrs()!==i||v){this._prevPyramid=this._tilePyramid;this._isFadingOutPrevTilePyramid=!1;var u=this._tilePyramid&&this._tilePyramid.getCrs(),w=u instanceof c&&i instanceof c,y=u!==i&&i instanceof c;y&&u instanceof c&&(i.metadataBeforeRotation=u.sceneMetadata);y&&i.reset();i.version&&(this._currentCrsVersion=i.version);this._tilePyramid&&this._tilePyramid.getCrs()===i&&i.getPreviousCrs&&i.getPreviousCrs()?(this._prevPyramid.setCrs(i.getPreviousCrs()),this._tilePyramid=null):this._tilePyramid=i instanceof c?null:this._pyramidCache.getItem(i.id);this._tilePyramid||(e.log(null,"Tile pyramid cache miss: {0}",i.id),f=i.tileInfo||{minZoom:1,maxZoom:21,tileWidth:et.tileSize,tileHeight:et.tileSize},f.wrapping||(f.wrapping={horizontal:!0,vertical:!1}),this._tilePyramid=this._tilePyramidFactory({info:f,crs:i}),o._isFeatureEnabled("bE2Transition")&&w||this._clearTileCache(),this._pyramidCache.addItem(i.id,this._tilePyramid));ht.cancelAnimation(this._tilePyramid,"opacity");this._tilePyramid.setOpacity(1);this._pyramidCache[i.id]=this._tilePyramid;o._clearDisposables(this._pyramidDisposables);this._pyramidDisposables.push(this._tilePyramid.renderInvalidated.add(function(){return s._invalidateView(!1,!1,!0)}),this._tilePyramid.onFrameRendered.add(function(n){return s.onFrameRendered.invoke(n)}),this._tilePyramid.onFrameFailed.add(function(n){return s.onFrameFailed.invoke(n)}))}e.assert(this._tilePyramid.getOpacity()===1,"Target grid's opacity should always be 1, only the previous grid should fade");this._positionPyramid(this._tilePyramid,n,r);this._positionPyramid(this._prevPyramid,n,r)}},n.prototype._positionPyramid=function(n,i,r){if(n){var f=n.getCrs(),e=this._map.getView(),u=e.cameraLocation;r||(r=t.fromLocation(u,!0));n.setCurrentUpdateReason(i);n.setViewportSize(this._map.getActualSize());n.setHeading((f.heading||0)-e.heading);n.setCenter(new l(f.projectToX(u.latitude,u.longitude),f.projectToY(u.latitude,u.longitude)));n.setZoom(r)}},n.prototype._onFrameManagerFrameRendered=function(){if(this._isInitialMapLoadingComplete){var n=this._map&&this._map.getMapOptions(),t=n&&n.disableBackgroundTiles;!t&&this._tilePyramid&&this._tilePyramid.prefetchBackgroundGrids()}},n.prototype._onMapReady=function(){var t=this;Microsoft.Maps.setTimeout(function(){t._isInitialMapLoadingComplete=!0;t._onFrameManagerFrameRendered()},n._delayLoadBackgroundTilesinMs)},n.prototype._onFrameSet=function(n){var t=this._tilePyramid.getCrs();t&&t instanceof c?this._updateCrs():this._updateElevation();this._tilePyramid.setFrame(n.frame)},n.prototype._onLayerDataLoaded=function(){this._updatePyramids(2);this._invalidateView(!1,!1,!0)},n.prototype._fadeOutPrevTilePyramid=function(){var n=this,t;this._prevPyramid&&!this._isFadingOutPrevTilePyramid&&(this._isFadingOutPrevTilePyramid=!0,t=this._prevPyramid.getCrs()instanceof c&&this._tilePyramid&&this._tilePyramid.getCrs()instanceof c,ht.animate(this._prevPyramid,"opacity",{to:0,duration:o._isFeatureEnabled("bE2Transition")&&t?500:null,frameCallback:function(){n._updateTiles=!0;n._render()},onComplete:function(){n._prevPyramid&&n._prevPyramid.getCrs()instanceof c&&n._prevPyramid.dispose();n._prevPyramid=null;n._isFadingOutPrevTilePyramid=!1;var t=n._tilePyramid&&n._tilePyramid.getCrs();t instanceof c&&(n._map.birdseyeV2SceneTransitioned.invoke(),n._map.setView(new b(n._map.getView().cameraLocation,t.heading),null,0,!0))}}))},n.prototype._invalidateView=function(n,t,i){var r=this;this._updateLabels=t||this._updateLabels;this._updateTiles=i||this._updateTiles;this._isInAnimation=n;this._renderQueued||(this._renderQueued=!0,e.logDebugData("Composite Map mode - invalidate()"),this._dispatcher&&this._dispatcher.dispatch(function(){return r._render()},this._dispatchRenderKey))},n.prototype._render=function(){this._renderQueued=!1;var i=this._tilePlacement,u=this._map._stats_compMap,t,r=this._updateLabels&&this._map&&this._map.getLabelController();r&&(t=this._calculateViewport(),r.setViewport(t));this._map&&this._map.getActualSize&&this._updateTiles&&(i.beginFrame(this._map.getActualSize()),e.logDebugData("Composite Map mode - _render()"),this._tilePyramid&&this._tilePyramid.render(i),this._prevPyramid&&this._prevPyramid.render(i),this._prevPyramid&&!this._isFadingOutPrevTilePyramid&&this._tilePyramid.getPercentLoaded()>=n.loadedPercentCutoff&&this._fadeOutPrevTilePyramid(),i.endFrame(),this._updateTiles=!1,this._updateLetterboxMargins());this._tilePyramid&&this.onPaint&&this.onPaint.hasHandlersRegistered()&&(t=t||this._calculateViewport(),this.onPaint.invoke({viewport:t,percentComplete:this._tilePyramid.getPercentLoaded(),labelsUpdated:this._updateLabels}));r&&(r.renderLabels(t,this._isInAnimation),this._updateLabels=!1);this._isInAnimation=!1},n.prototype._updateLetterboxMargins=function(){var t="px",u=!1,f=!1;if(this._tilePyramid&&this._tilePyramid.getHeading()===0){var i=this._tilePyramid.getViewportSize(),o=Math.pow(2,this._tilePyramid.getZoom()),e=o*this._tilePyramid.getTileWidth(),s=o*this._tilePyramid.getTileHeight(),r;e<i.width||e===0?(this._ensureLeftRightMarginElements(),u=!0,r=(i.width-e)/2,this._leftMarginElement.set_style({width:r+t,height:i.height+t}),this._rightMarginElement.set_style({left:i.width-r+t,width:r+t,height:i.height+t})):s<i.height&&(this._ensureTopBottomMarginElements(),f=!0,r=(i.height-s)/2,this._topMarginElement.set_style({height:r+t,width:i.width+t}),this._bottomMarginElement.set_style({top:i.height-r+t,height:r+t,width:i.width+t}))}n._showHideElement(this._leftMarginElement,u);n._showHideElement(this._rightMarginElement,u);n._showHideElement(this._topMarginElement,f);n._showHideElement(this._bottomMarginElement,f)},n._showHideElement=function(n,t){n&&n.set_style({display:t?"block":"none"})},n.prototype._constrainView=function(n){this._tilePyramid||(this._updatePyramids(2),e.assertNotNull(this._tilePyramid,"_tilePyramid"));d.constrainView(this._map,n)},n.prototype._calculateViewport=function(){var n=this._tilePyramid;if(n){var o=n.getTileWidth(),s=n.getTileHeight(),h=n.getZoom(),u=Math.pow(2,h),i=n.getViewportSize(),r=n.getCenter(),t=n.getCrs(),c=(t.bounds[1]-t.bounds[3])/(o*u),l=(t.bounds[2]-t.bounds[0])/(s*u),f=i.width*c,e=i.height*l,a=[r.y-e/2,r.x+f/2,r.y+e/2,r.x-f/2];return new at(i.width,i.height,a,t)}},n.prototype._calculateLatLongBoundingBox=function(){var n=this._tilePyramid.getViewportSize(),t=n.width,i=n.height,r=this.tryPointToLocation(new l(0,0)),u=this.tryPointToLocation(new l(t,i));return it.fromCorners(r,u)},n.prototype._updateElevation=function(){var n=this,t=this._tilePyramid.getCrs();t.getElevation&&t.getElevation(this._calculateLatLongBoundingBox(),function(){n._tilePyramid&&n._tilePyramid.getCrs()===t&&n._positionPyramid(n._tilePyramid,3)},function(){})},n.prototype._updateCrs=function(){var n=this,t=this._tilePyramid.getCrs(),i=null,r=null,u=null;t instanceof c&&(i=function(){n._tilePyramid&&n._tilePyramid.getCrs()===t&&(n._updatePyramids(4),o._isFeatureEnabled("bE2Transition")||rt.hideSDKLayersDuringTransition(n._map),rt.constrainViewOnUpdateCrs(n._map,t,!0),n._map.copyrightChanged.invoke(),n._positionPyramid(n._tilePyramid,4),n._prevPyramid&&n._prevPyramid.activateTargetGrid(),n._tilePyramid&&n._tilePyramid.activateTargetGrid())},r=function(){rt.constrainViewOnUpdateCrs(n._map,t,!!t.metadataBeforeRotation);n._positionPyramid(n._tilePyramid,4);n._tilePyramid&&n._tilePyramid.activateTargetGrid()},u=function(){var r=n._tilePyramid.getCrs().sceneMetadata,t,i;r?r.isLocationInsideScene(n._map.getView().cameraLocation)||(t=n._map.getNavigationBar(),i=t&&t.getHelper(),i&&i.showBirdseyeV2NotAvailableTip(!1)):n._map.getBirdseyeV2Manager().then(function(t){var i=n._map.getMapTypes()[t.previousMapState.mapTypeId||a.road];i&&n._map.setBaseLayers(i)})});t.update&&t.update(this._map,i,r,u)},n.prototype._boxZoomStarted=function(n){this._boxZoomCancelled();this._boxZoomStartArgs=n;this._boxZoomElement=o._createElement("div").add_class("boxZoom").set_style({position:"absolute"});this._rootElement.append(this._boxZoomElement)},n.prototype._boxZoomContinued=function(n){var i=this._boxZoomElement,r=this._boxZoomStartArgs,t;i&&r&&(t=ft.fromPoints(r.point,n.point),i.set_style({left:t.minPoint.x+"px",top:t.minPoint.y+"px",width:t.maxPoint.x-t.minPoint.x+"px",height:t.maxPoint.y-t.minPoint.y+"px"}))},n.prototype._boxZoomStopped=function(n){var o=this._boxZoomStartArgs,s,h,c,l;if(this._boxZoomCancelled(),o){var i=o.point,r=n.point,u=o.location,f=n.location;if(Math.abs(i.x-r.x)>2&&Math.abs(i.y-r.y)>2){i.y<r.y?(s=u.latitude,h=f.latitude):(s=f.latitude,h=u.latitude);i.x<r.x?(l=u.longitude,c=f.longitude):(l=f.longitude,c=u.longitude);var p=it.fromEdges(s,l,h,c),a=this._tilePyramid,y=this._map.getViewport(),e=g.getMapViewWithBounds(a.getCrs(),a.getTileWidth(),a.getTileHeight(),new k(y.pixelWidth,y.pixelHeight),this._map.getViewportPadding(),p),w=this._map,v=t.fromLocation(e.cameraLocation,!0);v=Math.floor(v);e.cameraLocation=t.toLocation(e.cameraLocation,v,!0);w.setView(e,kt.defaultAnimation,1)}}},n.prototype._boxZoomCancelled=function(){var n=this._boxZoomElement;n&&(n.removeFromParent(),this._boxZoomElement=null,this._boxZoomStartArgs=null)},n.prototype.getState=function(){var n=this._map,i=n.getView().cameraLocation,t=n.getNavigationBar();return{centerPoint:i,level:Microsoft.Maps.Internal.MapHelper.getMercatorZoomLevel(n),mode:this.mapModeType,style:n.getMapType().id,labelVisibility:n.getLabelController().getIsLabelsEnabled()?ct.visible:ct.hidden,direction:n.getView().heading,hasRequestedBE:t?t.getAerialBirdsEyeTransitionManager().hasRequestedBirdsEye():!1}},n.loadedPercentCutoff=.8,n._maxZoom=20,n._delayLoadBackgroundTilesinMs=2e3,n}(),d=function(){function f(){}return f.constrainView=function(n,i){var r=!1,e=i.view,o,l,w,b;(i.cause===0||i.cause===3)&&(o=t.fromLocation(i.view.cameraLocation,!0),o=Math.floor(o),i.view.cameraLocation=t.toLocation(i.view.cameraLocation,o,!0));var a=n.getMode(),u=n.getViewport(),d=n.getViewportPadding(),v=a.getTilePyramid(),s=v.getCrs(),y=v.getTileHeight(),p=v.getTileWidth(),h=n.getMapOptions().navigationOptions.minCameraAltitude;return h=typeof h=="number"?Math.max(a.getMinAltitude(),h):a.getMinAltitude(),l=n.getMapOptions().maxBounds,(e.heading===0||s instanceof c)&&(r=r||f.enforceMinZoom(n,i.view),r=r||f._enforceMinAltitude(s,e,u,d,p,y,h),f._checkConstrainBirdseyeV2View(n,s)&&n.getMapOptions().constrainBirdseyeView?r=r||f.constrainBirdseyeV2LatLong(n,s,new k(u.pixelWidth,u.pixelHeight),e):(w=f._enforceLatitudeBoundaries(e,new k(u.pixelWidth,u.pixelHeight),y,l),r=r||w,l&&(b=f._enforceLongitudeBoundaries(e,new k(u.pixelWidth,u.pixelHeight),p,l),r=r||b))),r},f.enforceMinZoom=function(n,r){var y=!1,k=n.getMode(),e=n.getViewport(),d=n.getViewportPadding(),o=k.getTilePyramid(),s=o.getCrs(),p=o.getTileHeight(),w=o.getTileWidth(),g=n.getMapOptions().navigationOptions.minZoomFraming,b=n.getMapOptions().navigationOptions.maxCameraAltitude,u=0,c=Math.ceil(h.log2(e.pixelWidth/w)),l=Math.ceil(h.log2(e.pixelHeight/p)),a,v;switch(g){case 0:u=Math.max(c,l);break;case 1:u=c;break;case 2:u=l;break;case 3:u=Math.min(c,l);break;case-1:u=3}return f._checkConstrainBirdseyeV2View(n,s)&&(u=Math.max(u,f.getBirdseyeV2MinZoom(e,s.sceneMetadata,n.getMapOptions().constrainBirdseyeView))),a=t.toAltitude(new i(0,0),u,!0),v=typeof b=="number"?Math.min(b,a):a,r.cameraLocation.altitude>v&&(f._setCameraAltitude(s,r,e,d,w,p,v),y=!0),y},f._enforceMinAltitude=function(n,t,i,r,u,e,o){var s=!1;return t.cameraLocation.altitude<o&&(f._setCameraAltitude(n,t,i,r,u,e,o),s=!0),s},f._setCameraAltitude=function(t,i,r,f,e,o,s){var v=new l(f.left+(r.pixelWidth-f.left-f.right)/2,f.top+(r.pixelHeight-f.top-f.bottom)/2),h=new k(r.pixelWidth,r.pixelHeight),a,y;try{i.cameraLocation=g.getCameraForLocationToPoint(t instanceof c?t:u.instance,e,o,h,0,i.cameraLocation,v,s,0)}catch(p){a=n.logger;a&&(y={feature:dt.MapControl,action:gt.Error,data:{errorMessage:"_setCameraAltitude exception: "+p.toString(),crs:t&&t.id||"",viewportSize:"[Size ("+h.width+", "+h.height+")]",viewportCenter:v.toString(),location:i.cameraLocation.toString(),altitude:s}},a.logCriticalError(null,y,!1))}},f._enforceLatitudeBoundaries=function(n,i,r,e){var o=!1,y=t.fromLocation(n.cameraLocation,!0),h=Math.pow(2,y)*r,c,l,s,a,v;return e&&(c=u.instance.projectToY(e.getNorth(),0),l=u.instance.projectToY(e.getSouth(),0),h*=l-c),s=e?e.center.latitude:0,i.height<h?n.cameraLocation.latitude>s?(a=e?e.getNorth():null,o=f._enforceNorthernBoundary(n,i,r,a)):(v=e?e.getSouth():null,o=f._enforceSouthernBoundary(n,i,r,v)):(n.cameraLocation.latitude=s,o=!0),o},f._enforceNorthernBoundary=function(n,i,r,f){var e=!1,h=t.fromLocation(n.cameraLocation,!0),c=i.height/2,o=c/(Math.pow(2,h)*r),s=u.instance.toLatitude(0,typeof f=="number"?o+u.instance.projectToY(f,0):o);return n.cameraLocation.latitude>s&&(n.cameraLocation.latitude=s,e=!0),e},f._enforceSouthernBoundary=function(n,i,r,f){var e=!1,h=t.fromLocation(n.cameraLocation,!0),c=i.height/2,o=c/(Math.pow(2,h)*r),s=u.instance.toLatitude(0,typeof f=="number"?u.instance.projectToY(f,0)-o:1-o);return n.cameraLocation.latitude<s&&(n.cameraLocation.latitude=s,e=!0),e},f._enforceLongitudeBoundaries=function(n,i,r,u){var e=!1;if(u){var s=t.fromLocation(n.cameraLocation,!0),h=Math.pow(2,s)*r*u.width/360,o=u.center.longitude;i.width<h?e=n.cameraLocation.longitude>o?f._enforceEasternBoundary(n,i,r,u.getEast()):f._enforceWesternBoundary(n,i,r,u.getWest()):(n.cameraLocation.longitude=o,e=!0)}return e},f._enforceEasternBoundary=function(n,i,r,f){var e=!1,s=t.fromLocation(n.cameraLocation,!0),h=i.width/2,c=h/(Math.pow(2,s)*r),o=u.instance.toLongitude(u.instance.projectToX(0,f)-c,0);return n.cameraLocation.longitude>o&&(n.cameraLocation.longitude=o,e=!0),e},f._enforceWesternBoundary=function(n,i,r,f){var e=!1,s=t.fromLocation(n.cameraLocation,!0),h=i.width/2,c=h/(Math.pow(2,s)*r),o=u.instance.toLongitude(u.instance.projectToX(0,f)+c,0);return n.cameraLocation.longitude<o&&(n.cameraLocation.longitude=o,e=!0),e},f._checkConstrainBirdseyeV2View=function(n,t){return n.getMapType().id===a.birdseyeV2&&t instanceof c&&!!t.sceneMetadata},f.getBirdseyeV2MinZoom=function(n,t,i){var f=r.imageryStartZoom,u,e;return t&&(u=i?Math.round:Math.ceil,e=Math.min(u(h.log2(t.width/n.pixelWidth)),u(h.log2(t.height/n.pixelHeight))),f=t.endingZoomLevel-e+1),f},f.constrainBirdseyeV2LatLong=function(n,i,u,f){var h=!1;if(i.sceneMetadata){var e=i.sceneMetadata,c=t.fromLocation(f.cameraLocation,!0),o=i.projectToX(f.cameraLocation.latitude,f.cameraLocation.longitude),s=i.projectToY(f.cameraLocation.latitude,f.cameraLocation.longitude),l=u.width/(2*Math.pow(2,c)*r.tileWidth),a=u.height/(2*Math.pow(2,c)*r.tileHeight),v=e.maxTileOffset/Math.pow(2,e.endingZoomLevel),k=(e.maxTileOffset+e.width/r.tileWidth)/Math.pow(2,e.endingZoomLevel),d=(e.maxTileOffset+e.height/r.tileHeight)/Math.pow(2,e.endingZoomLevel),y=v+l,p=k-l,w=v+a,b=d-a;(o<y||o>p||s<w||s>b)&&(o=Math.min(Math.max(y,o),p),s=Math.min(Math.max(w,s),b),f.cameraLocation.latitude=i.toLatitude(o,s),f.cameraLocation.longitude=i.toLongitude(o,s),h=!0)}return h},f}(),g=function(){function n(){}return n.getMapViewForLocationsInView=function(r,u,f,o,s,h){if(e.assertNotNull(h,"locations"),!h||h.length===0)return new b(new i(0,0,t.toAltitude(new i(0,0),1,!0),0),0);if(h.length===1)return new b(new i(h[0].latitude,h[0].longitude,t.toAltitude(h[0],20,!0),0),0);var c=it.fromLocations(h);return n.getMapViewWithBounds(r,u,f,o,s,c)},n.getMapViewWithBounds=function(r,o,s,h,c,a){e.assertNotNull(r,"crs");e.assertNotNull(c,"viewportPadding");e.assertNotNull(a,"bounds");var p=new l(c.left,c.top),it=new l(h.width-c.right,h.height-c.bottom),rt=it.x-p.x,ut=it.y-p.y,ft=new l(p.x+rt/2,p.y+ut/2),k=a.getNorth(),d=a.getSouth(),v=a.getEast(),w=a.getWest();w>v&&(v+=360);var g=f.greatCircleDistance(a.getNorthwest(),new i(k,v)),nt=f.greatCircleDistance(new i(d,w),a.getSoutheast()),y=null;k>0&&d<0&&(y=f.greatCircleDistance(new i(0,w),new i(0,v)));v-w>180&&(g=f.earthCircumference-g,nt=f.earthCircumference-nt,y!==null&&(y=f.earthCircumference-y));var et=Math.max(g,nt,y||0),ot=f.greatCircleDistance(new i(k,0),new i(d,0)),st=et/rt,ht=ot/ut,ct=Math.max(st,ht),tt=u.getCenter(a),lt=t.fromScale(tt,ct,!1),at=t.toAltitude(tt,lt,!0),vt=n.getCameraForLocationToPoint(r,o,s,h,0,tt,ft,at,0);return new b(vt,0)},n.getCameraForLocationToPoint=function(n,r,u,f,e,o,s,c,l){var y=Math.pow(2,t.fromLocation(new i(o.latitude,o.longitude,c),!0)),p=y*r,w=y*u,b=n.projectToX(o.latitude,o.longitude),k=n.projectToY(o.latitude,o.longitude),a,v;return s=h.rotatePoint(s.x-f.width/2,s.y-f.height/2,-h.degreesToRadians(e)),a=b-s.x/p,v=k-s.y/w,new i(n.toLatitude(a,v),n.toLongitude(a,v),c,l)},n}(),ri=function(){function n(n,t){this.boundingBox=n;this._url=t}return n.prototype.send=function(n,t,i){var r=Math.max(this.boundingBox.getNorth(),this.boundingBox.getSouth()),u=Math.min(this.boundingBox.getNorth(),this.boundingBox.getSouth()),f=Math.min(this.boundingBox.getWest(),this.boundingBox.getEast()),e=Math.max(this.boundingBox.getWest(),this.boundingBox.getEast()),o=this._url.replace("{north}",r.toString()).replace("{west}",f.toString()).replace("{south}",u.toString()).replace("{east}",e.toString());nt.downloadJsonp(o,"elev",n,t,null,null,i)},n}(),ui=function(){function n(n,t){this._mostRecentElevationRequest=0;var i=""+n;this.id="EnhancedBirdseye"+n;this.bounds=[0,1,1,0];this._elevationServiceUrl=t;this.heading=n;this.tileInfo={tileWidth:256,tileHeight:180,minZoom:1,maxZoom:23}}return n.prototype.toLatitude=function(t,i){var r=u.instance;switch(this.heading){case 0:return r.toLatitude(t,i)-n._elevationInDegreesLatitude;case 90:return r.toLatitude(1-i,t);case 180:return r.toLatitude(1-t,1-i)+n._elevationInDegreesLatitude;case 270:return r.toLatitude(i,1-t);default:throw"invalid operation - unsupported heading";}},n.prototype.toLongitude=function(t,i){var r=u.instance;switch(this.heading){case 0:return r.toLongitude(t,i);case 90:return r.toLongitude(1-i,t)-n._elevationInDegreesLongitude;case 180:return r.toLongitude(1-t,1-i);case 270:return r.toLongitude(i,1-t)+n._elevationInDegreesLongitude;default:throw"invalid operation - unsupported heading";}},n.prototype.projectToX=function(t,i){var r=u.instance;switch(this.heading){case 0:return r.projectToX(t+n._elevationInDegreesLatitude,i);case 90:return r.projectToY(t,i+n._elevationInDegreesLongitude);case 180:return 1-r.projectToX(t-n._elevationInDegreesLatitude,i);case 270:return 1-r.projectToY(t,i-n._elevationInDegreesLongitude);default:throw"invalid operation - unsupported heading";}},n.prototype.projectToY=function(t,i){var r=u.instance;switch(this.heading){case 0:return r.projectToY(t+n._elevationInDegreesLatitude,i);case 90:return 1-r.projectToX(t,i+n._elevationInDegreesLongitude);case 180:return 1-r.projectToY(t-n._elevationInDegreesLatitude,i);case 270:return r.projectToX(t,i-n._elevationInDegreesLongitude);default:throw"invalid operation - unsupported heading";}},n.prototype.getScale=function(n){return u.instance.getScale(n)},n.prototype.getMatrix=function(t){var r=t===u.instance;if(r||t instanceof n){var i=y.identity,f=y.identity,e=Math.round(h.wrap(this.heading-(t.heading||0),0,360)),o=e*Math.PI/180;r&&(f=y.identity.translate(-n._elevationInMercatorX*Math.sin(o),n._elevationInMercatorY*Math.cos(o)));switch(e){case 0:break;case 90:i=n._m90;break;case 180:i=n._m180;break;case 270:i=n._m270;break;default:throw"invalid operation - unsupported heading";}return f.multiply(i)}return null},n.prototype.getElevation=function(t,i,r,u){var f=this,e=new ri(t,this._elevationServiceUrl);e.send(function(e,o){var s,h,l,c;if(o===f._mostRecentElevationRequest){if(s=null,e=e,e&&(h=e.alt,h&&h.length>0)){for(l=h.length,s=0,c=0;c<l;c++)s+=(l-c)/l*h[c];if(isFinite(s)){n.setElevation(s,t.center.latitude);i&&i(s,u);return}}r&&r(u)}},function(n){n===f._mostRecentElevationRequest&&r&&r(u)},++this._mostRecentElevationRequest)},n.setElevation=function(t,i){n._elevationInDegreesLatitude=t/f.getMetersPerDegreeOfLatitude(i);n._elevationInDegreesLongitude=t/f.getMetersPerDegreeOfLongitude(i);n._elevationInMercatorY=n._elevationInDegreesLatitude*u.getMercatorUnitsPerDegreeOfLatitude(i);n._elevationInMercatorX=n._elevationInDegreesLongitude*u.getMercatorUnitsPerDegreeOfLongitude()},n._m90=new y(0,-1,1,0,0,1).invert(),n._m180=new y(-1,0,0,-1,1,1).invert(),n._m270=new y(0,1,-1,0,1,0).invert(),n._elevationInDegreesLatitude=0,n._elevationInDegreesLongitude=0,n._elevationInMercatorY=0,n._elevationInMercatorX=0,n}(),c=function(){function f(t,i,r){var e,f,u;this._queryLatLongRange=.1;this._unconstrainedViewPaddingRatio=.15;this._locationUpdatedPrecision=1e-6;this._locationQueriedPrecision=.0001;e=n.Internal._CoreConfig();this._sceneMetadataUrl=o._updateTfeUrlDomain(i);this.id="BirdseyeV2_"+t.toString();this.bounds=[0,1,1,0];this.tileInfo={tileWidth:512,tileHeight:512,minZoom:1,maxZoom:23};this.heading=t;r&&(this._unconstrainedViewPaddingRatio=Math.max(Math.min(r,.5),0));f=o._getUrlParam(window.location,"bev2transitionpadding");u=f&&parseFloat(f);typeof u!="number"||isNaN(u)||(this._unconstrainedViewPaddingRatio=Math.max(Math.min(u,.5),0))}return f.prototype.toLatitude=function(n,t){var i,f,e;return this.sceneMetadata?(f=(n*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset)*r.tileWidth,e=(t*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset)*r.tileHeight,i=this.sceneMetadata.projectToLatLong(f,e)[0]):i=u.instance.toLatitude(n,t),i},f.prototype.toLongitude=function(n,t){var i,f,e;return this.sceneMetadata?(f=(n*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset)*r.tileWidth,e=(t*Math.pow(2,this.sceneMetadata.endingZoomLevel)-this.sceneMetadata.maxTileOffset)*r.tileHeight,i=this.sceneMetadata.projectToLatLong(f,e)[1]):i=u.instance.toLongitude(n,t),i},f.prototype.projectToX=function(n,t){var i,f;return this.sceneMetadata?(f=this.sceneMetadata.projectToXY(n,t)[0],i=(f+this.sceneMetadata.maxTileOffset*r.tileWidth)/(r.tileWidth*Math.pow(2,this.sceneMetadata.endingZoomLevel))):i=u.instance.projectToX(n,t),i},f.prototype.projectToY=function(n,t){var i,f;return this.sceneMetadata?(f=this.sceneMetadata.projectToXY(n,t)[1],i=(f+this.sceneMetadata.maxTileOffset*r.tileHeight)/(r.tileWidth*Math.pow(2,this.sceneMetadata.endingZoomLevel))):i=u.instance.projectToY(n,t),i},f.prototype.getMatrix=function(n){var t=y.identity,i=Math.round(h.wrap(this.heading-(n.heading||0),0,360));return t.rotate(i*Math.PI/180)},f.prototype.getScale=function(n){var t,i;return this.sceneMetadata?(i=n.zoom,t=this.sceneMetadata.minScale*Math.pow(2,this.sceneMetadata.endingZoomLevel-i)):t=u.instance.getScale(n),t},f.prototype.update=function(n,t,i,r,u){var f=n.getView().cameraLocation,e=!1,o=n.getMapOptions().constrainBirdseyeView,h=o&&this._getSceneBoundaryHitArgs(n),s={originalMetadata:this.sceneMetadata,viewport:n.getViewport(),constrainView:o,boundaryHitArgs:h};this._shouldUpdateScene(f,n.isPanning(),s)&&(this._lastUpdatedLocation=f,e=!0,this.updateLocation(f,s,t,i,r,u));!e&&i&&i()},f.prototype.updateLocation=function(n,t,r,u,e,o){var s=this,c=t.boundaryHitArgs&&t.boundaryHitArgs.transformedCheckLocation||n,h=this._selectSceneFromCache(n,t);h?(this._deletePendingMetadataCall(),Microsoft.Maps.setTimeout(function(){s._prevSceneMetadata=s.sceneMetadata;s.sceneMetadata=h;s.version=s.sceneMetadata.sceneId.toString();r&&r()},1)):i.areEqual(f.lastQueriedLocation,c,!0,this._locationQueriedPrecision)?e&&e():this._requestNewScenes(n,t,r,u,e,o)},f.prototype.getPreviousCrs=function(){var n=new f(this.heading,this._sceneMetadataUrl);return n.sceneMetadata=this._prevSceneMetadata,n.version=this._prevSceneMetadata&&this._prevSceneMetadata.sceneId.toString(),n},f.prototype.getEffectiveZoomForTransition=function(n){var i=t.fromLocation(n,!0);return this.sceneMetadata&&(i+=r.getDeltaZoomBetweenScenes(this._prevSceneMetadata,this.sceneMetadata),this.metadataBeforeRotation&&(i+=r.getDeltaZoomBetweenScenes(this.metadataBeforeRotation,this.sceneMetadata),this.metadataBeforeRotation=null),i=Math.max(Math.min(i,this.sceneMetadata.endingZoomLevel),r.imageryStartZoom)),i},f.prototype.getThumbnailSceneFromCache=function(n,t){for(var i,c=null,l=null,a=f.metadataCache.getInternalDictionary(),v=Object.keys(a),y=Number.MAX_VALUE,p=0,e=0;e<v.length;e++)if(i=a[v[e]].item,i&&i.cLook===this.heading&&i.isLocationInsideScene(n)){var w=i.projectToXY(n.latitude,n.longitude),o=w[0],s=w[1],tt=Math.max(Math.min(i.endingZoomLevel,t),r.imageryStartZoom),h=Math.pow(2,i.endingZoomLevel-t),u=r.tileWidth*h,b=i.width%u>0&&o+u>u*Math.ceil(i.maxNumXTiles/h),k=i.height%u>0&&s+u>u*Math.ceil(i.maxNumYTiles/h),d=b||k,g=Math.pow(Math.abs(u/2-o%u),2)+Math.pow(Math.abs(u/2-s%u),2),nt=Math.pow(b?i.width-o:u,2)+Math.pow(k?i.height-s:u,2);!d&&g<y?(y=g,c=i):d&&nt>p&&(p=nt,l=i)}return c||l},f.prototype.reset=function(){this.sceneMetadata=null;this._prevSceneMetadata=null;this._lastUpdatedLocation=null},f.prototype._deletePendingMetadataCall=function(){this._requestId&&nt.abortRequest(this._requestId);this._requestId=null;this._sceneSelectionArgs=null},f.prototype._selectSceneFromCache=function(n,u){for(var e,h=[],o=[],c=[],w=t.fromLocation(n,!0),s=u.originalMetadata||this.metadataBeforeRotation,a=f.metadataCache.getInternalDictionary(),v=Object.keys(a),l=0;l<v.length;l++)if(e=a[v[l]].item,this._isCachedSceneValid(n,e,u))if(s){var y=r.getDeltaZoomBetweenScenes(s,e),p=w+y,b=d.getBirdseyeV2MinZoom(u.viewport,e,!1);p>=b&&p<=e.endingZoomLevel&&y<0?h.push(e):Math.abs(s.minScale-e.minScale)<.02?o.push(e):c.push(e)}else!s&&Math.abs(f.averageCachedMinScale-e.minScale)<.05?o.push(e):c.push(e);var k=u.boundaryHitArgs&&u.boundaryHitArgs.transformedCheckLocation||n,g=!i.areEqual(f.lastQueriedLocation,k,!0,this._locationQueriedPrecision),nt=h.length>0||g?h:o.length>0?o:c;return this._selectMaxPannableScene(n,nt,u)},f.prototype._requestNewScenes=function(n,t,i,u,e,o){var s=this,c=t.boundaryHitArgs&&t.boundaryHitArgs.transformedCheckLocation||n,l=c.latitude,a=c.longitude,y=l+this._queryLatLongRange,p=l-this._queryLatLongRange,w=a+this._queryLatLongRange,b=a-this._queryLatLongRange,h;this._deletePendingMetadataCall();h=nt.downloadJson(this._sceneMetadataUrl.replace("{subdomain}",Math.floor(Math.random()*4).toString()).replace("{genId}",v.dynamicProperties.birdseyeV2MetadataGenerationId).replace("{north}",y.toString()).replace("{south}",p.toString()).replace("{east}",w.toString()).replace("{west}",b.toString()),"birdseyeV2Metadata",function(t){var o,l;if(t.length>1){for(o=t.length-1;o>0;o--)l=new r(t[o]),f.metadataCache.addItem(l.sceneId.toString(),l);s._calculateAvgCachedMinScale();f.lastQueriedLocation=c;s._postSceneDownload(n,c,h,i,u,e)}else h===s._requestId&&e&&e()},function(){h===s._requestId&&(s._deletePendingMetadataCall(),o&&o())},null,null,null,!1);this._requestId=h;this._sceneSelectionArgs=t},f.prototype._postSceneDownload=function(n,t,i,r,u,f){if(i===this._requestId){var e=this._selectSceneFromCache(n,this._sceneSelectionArgs);this._deletePendingMetadataCall();e&&(!this.sceneMetadata||e.sceneId!==this.sceneMetadata.sceneId)?(this._prevSceneMetadata=this.sceneMetadata,this.sceneMetadata=e,this.version=this.sceneMetadata.sceneId.toString(),r&&r()):e?u&&u():f&&f()}},f.prototype._selectMaxPannableScene=function(n,t,i){var c=null,u=i.boundaryHitArgs,l,e,f,a,v;if(!i.constrainView||u.top&&u.right&&u.bottom&&u.left){for(l=Number.MAX_VALUE,e=null,f=0;f<t.length;f++){var r=t[f],o=r.projectToXY(n.latitude,n.longitude),s=o[0],h=o[1],y=Math.pow(Math.abs(s-r.width/2),2)+Math.pow(Math.abs(h-r.height/2),2);y<l&&(l=y,e=r)}c=e}else{for(a=-1,e=null,f=0;f<t.length;f++)r=t[f],o=r.projectToXY(n.latitude,n.longitude),s=o[0],h=o[1],v=Math.pow(u.left?s:0,2)+Math.pow(u.right?r.width-s:0,2)+Math.pow(u.top?h:0,2)+Math.pow(u.bottom?r.height-h:0,2),v>a&&(a=v,e=r);c=e}return c},f.prototype._canPositionLocationInNewScene=function(n,i,u,f,e){var h=u.projectToXY(n.latitude,n.longitude),o=t.fromLocation(n,!0);o=o+r.getDeltaZoomBetweenScenes(i,u);o=Math.max(Math.min(o,u.endingZoomLevel),d.getBirdseyeV2MinZoom(f,u,!1));var c=Math.pow(2,u.endingZoomLevel-o),s=e?0:this._unconstrainedViewPaddingRatio;return u.canCoverViewportWithLocation(n,e,f,s,o)},f.prototype._shouldUpdateScene=function(n,t,r){var f=!1,e=r.constrainView,u=r.boundaryHitArgs;return t||i.areEqual(n,this._lastUpdatedLocation,!0,this._locationUpdatedPrecision)||(f=e?u.top||u.bottom||u.left||u.right:!this.sceneMetadata||!this.sceneMetadata.canCoverViewportWithLocation(n,e,r.viewport,this._unconstrainedViewPaddingRatio)),f},f.prototype._isCachedSceneValid=function(n,i,r){var e=r.originalMetadata,o=r.boundaryHitArgs,s=r.constrainView,v=r.viewport,w=s?0:this._unconstrainedViewPaddingRatio,u=i.cLook===this.heading,a;if(u&&(a=e||this.metadataBeforeRotation,u=a?this._canPositionLocationInNewScene(n,a,i,v,s):i.canCoverViewportWithLocation(n,s,v,this._unconstrainedViewPaddingRatio)),u&&e&&s){var y=t.fromLocation(n,!0),p=Math.pow(2,this.sceneMetadata.endingZoomLevel-y),h=f.boundaryCheckThreshold*p,c=e.projectToXY(n.latitude,n.longitude),l=i.projectToXY(n.latitude,n.longitude);u&&o.left?u=l[0]-c[0]>h:u&&o.right&&(u=i.width-l[0]-(e.width-c[0])>h);u&&o.top?u=l[1]-c[1]>h:u&&o.bottom&&(u=i.height-l[1]-(e.height-c[1])>h)}return u},f.prototype._calculateAvgCachedMinScale=function(){for(var i=f.metadataCache.getInternalDictionary(),n=Object.keys(i),r=0,t=0;t<n.length;t++)r+=i[n[t]].item.minScale;f.averageCachedMinScale=r/n.length},f.prototype._getSceneBoundaryHitArgs=function(n){var e={top:!0,bottom:!0,left:!0,right:!0},r,a;if(this.sceneMetadata){var v=n.getViewport(),c=n.getView().cameraLocation,y=c.latitude,p=c.longitude,w=t.fromLocation(c,!0),l=Math.pow(2,this.sceneMetadata.endingZoomLevel-w),o=v.pixelWidth/2*l,s=v.pixelHeight/2*l,h=f.boundaryCheckThreshold*l,u=this.sceneMetadata.projectToXY(y,p),b=u[0]-o-h,k=this.sceneMetadata.width-(u[0]+o+h),d=u[1]-s-h,g=this.sceneMetadata.height-(u[1]+s+h);e={top:d<0,bottom:g<0,left:b<0,right:k<0};r=[u[0],u[1]];e.left?r[0]-=o/2:e.right&&(r[0]+=o/2);e.top?r[1]-=s/2:e.bottom&&(r[1]+=s/2);(u[0]!==r[0]||u[1]!==r[1])&&(a=this.sceneMetadata.projectToLatLong(r[0],r[1]),e.transformedCheckLocation=new i(a[0],a[1]))}return e},f.boundaryCheckThreshold=10,f.metadataCache=new st(100),f.averageCachedMinScale=null,f.lastQueriedLocation=null,f}(),rt=function(){function i(n){var t=this;this._map=n;this._disposables=[];this._disposables.push(this._map.mapTypeChanged.add(function(n){t.onMapTypeChanged(n)}));(v.isMapsVertical||v.isMapsAnswer)&&this._disposables.push(this._map.getLayers().changed.add(function(n){t._map.getMapType().id===a.birdseyeV2&&n.added&&n.added.length>0&&t._hideMapLayers()}));this._activated=!1;this._tempHiddenLayers=[];this.previousMapState={mapTypeId:null,altitude:null,birdseyeV2Heading:null}}return i.prototype.dispose=function(){c.lastQueriedLocation=null;c.metadataCache.clear();this._savedTransientLensActionList=null;for(var n=0;n<this._disposables.length;n++)this._disposables[n].dispose();this._tempHiddenLayers=[]},i.prototype.onMapTypeChanged=function(n){n.newMapTypeId===a.birdseyeV2?this._onActivated(n.oldMapTypeId):n.oldMapTypeId===a.birdseyeV2&&this._onDeactivated(n.newMapTypeId)},i.prototype.addContextPoi=function(n,t,r){var u=this,o={id:"BirdseyeV2ContextPoi",title:t,collisionBehavior:2},f=new ni(n,o),e;f.bucket="999998";f.taskDisplayState={activationState:1,colorIndex:r,prominence:1};f.viewState=2;this._contextLayer?(e=this._contextLayer.getDataSource(),e.clear(),e.addPrimitive(f),this._map.getLayers().indexOf(this._contextLayer)<0&&this._map.getLayers().insert(this._contextLayer)):this._map.getContainer().instanceAsync("ListDataSource",function(n){n.addPrimitive(f);u._map.getContainer().instanceAsync("XsrPoiTemplateSelector",function(t){u._map.getLayers().remove(u._contextLayer);u._contextLayer=new lt(i._contextLayerId,n,t,1e4);u._map.getLayers().insert(u._contextLayer)})})},i.prototype._onActivated=function(t){var i=this,u,r;this._activated||(this._activated=!0,this._lastProductId=null,u=this._map.getView(),t!==a.streetside&&(this.previousMapState.mapTypeId=t,this.previousMapState.altitude=u.cameraLocation.altitude,r=this._map.getNavigationBar(),r?r.getHelper().updateNavBarForBirdseyeV2(!0):this._map.navigationBarLoaded.addOne(function(){i._map.getMapType().id===a.birdseyeV2&&i._map.getNavigationBar().getHelper().updateNavBarForBirdseyeV2(!0)}),v.isMapsVertical&&(this._map.getContainer().instanceAsync("TransientLens",function(t){if(i._map.getMapType().id===a.birdseyeV2){i._savedTransientLensActionList=t.getViewModel().actionList;var r=n&&n.Internal&&n.Internal.TransientLensActions;r&&(t.getViewModel().actionList=[r.Streetside])}}),this._map.getContainer().instanceAsync("TaskBar",function(n){if(i._map.getMapType().id===a.birdseyeV2){var t=n.fullScreenEnabled?256:0;n.setActionsOptions(8|t)}}),tt(".MicrosoftMap .taskLayoutContainer").add_class("hideTaskLayout"),tt(".toggleButton").add_class("hideTaskLayout"),this._hideMapLayers(),sj_evt.fire("HideContextualTaskbar"))))},i.prototype._onDeactivated=function(n){var u=this,i,f,r;this._activated&&(i=this._map.getView(),n!==a.streetside?(this.previousMapState.altitude?i.cameraLocation.altitude=this.previousMapState.altitude:(f=t.toLocation(i.cameraLocation,this._map.getMercatorZoomLevel()-1,!0),i=new b(f,0)),this._map.setView(i,null,0,!0),r=this._map.getNavigationBar(),r?r.getHelper().updateNavBarForBirdseyeV2(!1):this._map.navigationBarLoaded.addOne(function(){u._map.getNavigationBar().getHelper().updateNavBarForBirdseyeV2(!1)}),v.isMapsVertical&&(this._savedTransientLensActionList&&this._map.getContainer().instanceAsync("TransientLens",function(n){n.getViewModel().actionList=u._savedTransientLensActionList}),this._map.getContainer().instanceAsync("TaskBar",function(t){var i=t.fullScreenEnabled?256:0;t.setActionsOptions(n===a.streetside?24|i:511)}),tt(".MicrosoftMap .taskLayoutContainer").remove_class("hideTaskLayout"),tt(".toggleButton").remove_class("hideTaskLayout"),this._showMapLayers(),this._map.getLayers().remove(this._contextLayer),sj_evt.fire("ShowContextualTaskbar"))):this.previousMapState.birdseyeV2Heading=i.heading,this._activated=!1)},i.prototype._hideMapLayers=function(){for(var n,r=this._map.getLayers(),t=r.length-1;t>=0;t--)n=r[t],n instanceof lt&&n.getId()!==i._contextLayerId&&(this._map.getLayers().remove(n),this._tempHiddenLayers.indexOf(n)<0&&this._tempHiddenLayers.push(n))},i.prototype._showMapLayers=function(){for(var t,n=this._tempHiddenLayers.length-1;n>=0;n--)t=this._tempHiddenLayers[n],this._map.getLayers().indexOf(t)<0&&this._map.getLayers().insert(t);this._tempHiddenLayers=[]},i.prototype.getUpdatedProductId=function(n){var t=null,i=n.sceneMetadata;return i&&i.productId!==this._lastProductId&&(t=i.productId,this._lastProductId=t),t},i.hideLayersForSDKMap=function(n){for(var t,u,r=n.hiddenLayerArgsInBEv2||[],f=Microsoft.Maps.TileLayer,e=Microsoft.Maps.DataBinningLayer,o=Microsoft.Maps.CustomOverlay,i=n.layers.length-1;i>=0;i--)t=n.layers[i],o&&t instanceof o&&!t.getOptions().showInBirdseye?(u=t.getAnimationState&&t.getAnimationState(),u===1&&t.pause&&t.pause(),r.push({layer:t,index:i,animationState:u}),n.layers.remove(t)):(f&&t instanceof f||e&&t instanceof e)&&t.getVisible()&&(r.push({layer:t,index:-1}),t.setVisible(!1));n.hiddenLayerArgsInBEv2=r},i.showLayersForSDKMap=function(n){for(var i=n.hiddenLayerArgsInBEv2||[],r=function(t){var r=i[t],u=r.index,f,e;u>=0?(f=n.layers.length,e=u>f?f:u,Microsoft.Maps.setTimeout(function(){n.layers.insert(r.layer,e);r.animationState===1&&r.layer.play()},1)):r.layer.setVisible(!0)},t=i.length-1;t>=0;t--)r(t);n.hiddenLayerArgsInBEv2=null},i.hideSDKLayersDuringTransition=function(n){var u=n.getLayers(),f=Microsoft.Maps.Layer,r=[],i,t;if(f)for(i=0;i<u.length;i++)t=u[i],t instanceof f&&t.getVisible()&&(t.setVisible(!1),r.push(t));r.length>0&&n.birdseyeV2SceneTransitioned.addOne(function(){r.forEach(function(n){n.setVisible(!0)})})},i.constrainViewOnUpdateCrs=function(n,i,r){var e=n.getViewport(),f=n.getView(),u=f.cameraLocation,o=u.altitude;r&&(u.altitude=t.toAltitude(u,i.getEffectiveZoomForTransition(u),!0));(d.enforceMinZoom(n,f)||o!==u.altitude)&&n.mapZoomChanged.invoke();n.getMapOptions().constrainBirdseyeView&&d.constrainBirdseyeV2LatLong(n,i,new k(e.pixelWidth,e.pixelHeight),f)},i.getIsBirdseyeV2Available=function(n,t,i,u,f){if(n.birdseyeV2MetadataUrl){var e=r.normalizeHeading(i),o=new c(e,n.birdseyeV2MetadataUrl),s={originalMetadata:null,viewport:f,constrainView:!1,boundaryHitArgs:{top:!0,bottom:!0,left:!0,right:!0}};o.updateLocation(t,s,function(){u&&u(!0)},function(){u&&u(!1)},function(){u&&u(!1)},function(){u&&u(!1)})}else u&&u(!1)},i.getBirdseyeV2Thumbnail=function(n,t,u,f,e,o){var s=null,h;n.birdseyeV2MetadataUrl?(h=r.normalizeHeading(e),i.getIsBirdseyeV2Available(n,t,h,function(r){var v,e,o,l,y;r&&(v=new c(h,n.birdseyeV2MetadataUrl),e=n.mapTypeDefinitions.filter(function(n){return n.mapType===a.birdseyeV2}),e.length>0&&e[0].data&&e[0].data[0]&&(o=e[0].data[0],l=o.imageryScenes&&o.imageryScenes.length>0&&o.imageryScenes[0],l&&(y=v.getThumbnailSceneFromCache(t,u),s=i._getThumbnailUrl(t,y,u,l))));f&&f(s)},o)):f&&f(s)},i._getThumbnailUrl=function(n,t,i,u){var a=t.projectToXY(n.latitude,n.longitude),p=Math.max(Math.min(a[0],t.width),0),w=Math.max(Math.min(a[1],t.height),0),c=Math.max(Math.min(t.endingZoomLevel,i),r.imageryStartZoom),l=r.tileWidth*Math.pow(2,t.endingZoomLevel-c),e=Math.floor(p/l),s,f,h,y;return e===Math.ceil(t.width/l)-1&&t.width%l!=0&&(e=Math.max(e-1,0)),s=r.tileHeight*Math.pow(2,t.endingZoomLevel-c),f=Math.floor(w/s),f===Math.ceil(t.height/s)-1&&t.height%s!=0&&(f=Math.max(f-1,0)),h=pt.positionToQuadkey(e,f,c),y=o._updateTfeUrlDomain(u.tileUrl).replace("{subdomain}",h.charAt(h.length-1)).replace("{tileUrlParam}",u.tileUrlParam).replace("{genId}",v.dynamicProperties.birdseyeV2ImageryGenerationId).replace("{base4SceneId}",t.base4SceneId).replace("{birdseyeV2Quadkey}",h),y},i._contextLayerId="BirdseyeV2ContextLayer",i}(),vt=function(){function n(){}return n.prototype.reset=function(t,i){var r,u;for(this._height=(i/n.cellSize|0)+1,this._width=(t/n.cellSize|0)+1,this._index=new Array(this._height),r=0;r<this._height;r++)for(this._index[r]=new Array(this._width),u=0;u<this._width;u++)this._index[r][u]=[]},n.prototype.add=function(t,i){for(var r,f=Math.max(i.minPoint.y/n.cellSize|0,0),e=Math.min(i.maxPoint.y/n.cellSize|0,this._height-1),o=Math.max(i.minPoint.x/n.cellSize|0,0),s=Math.min(i.maxPoint.x/n.cellSize|0,this._width-1),u=f;u<=e;u++)for(r=o;r<=s;r++)this._index[u][r].push(t)},n.prototype.getOverlappingRegions=function(t){for(var i,f=Math.max(t.minPoint.y/n.cellSize|0,0),e=Math.min(t.maxPoint.y/n.cellSize|0,this._height-1),o=Math.max(t.minPoint.x/n.cellSize|0,0),s=Math.min(t.maxPoint.x/n.cellSize|0,this._width-1),u=[],r=f;r<=e;r++)for(i=o;i<=s;i++)Array.prototype.push.apply(u,this._index[r][i]);return u},n.prototype.getRegionsAtPixel=function(t,i){var r=o._clamp(t/n.cellSize|0,0,this._width-1),u=o._clamp(i/n.cellSize|0,0,this._height-1);return this._index[u][r]},n.prototype.getRegions=function(n,t){return this._index[n][t]},n.prototype.getHeight=function(){return this._height},n.prototype.getWidth=function(){return this._width},n.cellSize=64,n}(),fi=function(){function n(){this._index=new vt}return n.prototype.reset=function(n,t){this._index.reset(n,t)},n.prototype.addEllipse=function(n,t,i,r,u){var f={key:n,shape:1,bounds:ft.fromSides(t-r/2,t+r/2,i-u/2,i+u/2),center:{x:t,y:i}};this._index.add(f,f.bounds)},n.prototype.addRectangle=function(n,t,i,r,u){var f={key:n,shape:0,bounds:ft.fromSides(t,t+r,i,i+u)};this._index.add(f,f.bounds)},n.prototype.hitTest=function(n){for(var i,r=this._index.getRegionsAtPixel(n.x,n.y),u=null,t=r.length-1;t>=0;t--)if(i=r[t],this._pointInRegion(n,i)){u=i.key;break}return u},n.prototype._pointInRegion=function(n,t){var u=t.bounds,i,r;return u.pointInRect(n)?t.shape===1?(i=t.center,r=u.minPoint,(n.x-i.x)*(n.x-i.x)/(i.x-r.x)/(i.x-r.x)+(n.y-i.y)*(n.y-i.y)/(i.y-r.y)/(i.y-r.y)<=1):!0:!1},n}(),ei=function(){function n(n){var t=this;this.graceRadiusForMouse=0;this._mapEvents=[];this._registeredJsEvents={};this._enableHitTesting=!0;this._hitTestComponents=[];this._mapEvents.push(n.mapPanStarted.add(function(){return t._enableHitTesting=!1}));this._mapEvents.push(n.mapPanStopped.add(function(){return t._enableHitTesting=!0}));this._mapEvents.push(n.mapZoomStarted.add(function(){return t._enableHitTesting=!1}));this._mapEvents.push(n.mapZoomStopped.add(function(){return t._enableHitTesting=!0}))}return n.prototype.dispose=function(){this._eventRoot&&(this.stopHitTesting(),this._hitTestComponents=[],this._eventRoot=null,this._hitTestRoot=null);o._clearDisposables(this._mapEvents);o._nullifyClass(this)},n.prototype.addComponent=function(n){o._orderedInsert(this._hitTestComponents,n,"hitTestPriority")},n.prototype.removeComponent=function(n){o._orderedDelete(this._hitTestComponents,n,"hitTestPriority")},n.prototype.startHitTesting=function(n,t){var f=this,e=this._eventRoot=n,i;this._hitTestRoot=t;var s={argBuilder:function(n,t){return f._performHitTestingForMouseEvent(n,t)}},h={argBuilder:function(n,t){return f._performHitTestingForTouchEvent(n,t)}},r=["mousemove","mousedown","mouseup","click","dblclick","contextmenu"],u=["touchmove","touchstart","touchend"];for(i=0;i<r.length;i++)this._registeredJsEvents[r[i]]=o._defineJSEventForDomEvent(e,r[i],s);for(i=0;i<u.length;i++)this._registeredJsEvents[u[i]]=o._defineJSEventForDomEvent(e,u[i],h)},n.prototype.stopHitTesting=function(){var t=this._eventRoot;for(var n in this._registeredJsEvents)o._undefineJSEventForDomEvent(t,n,this._registeredJsEvents[n].id),this._registeredJsEvents[n].dispose()},n.prototype._performHitTestingForMouseEvent=function(n,t){this._performHitTestingWithSpiraling(n.point,t,this.graceRadiusForMouse)},n.prototype._performHitTestingForTouchEvent=function(n,t){var r,i;if(n&&t)if(t.changedTouches)for(r=t.changedTouches,i=0;i<r.length;i++){var u=r[i],f=this._hitTestRoot.get_absolute_pos(),e=new l(u.pageX-f.x,u.pageY-f.y);this._performHitTestingForTouchPoint(e,u)}else this._performHitTestingForTouchPoint(n.point,t)},n.prototype._performHitTestingForTouchPoint=function(t,i){this._performHitTestingWithSpiraling(t,i,n._graceRadiusForTouch)},n.prototype._performHitTestingWithSpiraling=function(n,t,i){if(this._performHitTesting(t,n),!t.primitive)for(var r=1;r<i;r++){if(this._performHitTesting(t,new l(n.x+r,n.y)),t.primitive)break;if(this._performHitTesting(t,new l(n.x,n.y+r)),t.primitive)break;if(this._performHitTesting(t,new l(n.x-r,n.y)),t.primitive)break;if(this._performHitTesting(t,new l(n.x,n.y-r)),t.primitive)break}},n.prototype._performHitTesting=function(n,t){var r,i,u;if(this._enableHitTesting)for(r=this._hitTestComponents,i=0,u=r.length;i<u;i++)if(r[i].performHitTesting(n,t),n.primitive||n.exclusiveHitTest)break},n._graceRadiusForTouch=20,n}(),u=function(){function n(){if(n.instance)return n.instance;this.id="Mercator";this.bounds=[0,1,1,0]}return n.prototype.toLatitude=function(t,i){return n._yToLatitude(i)},n.prototype.toLongitude=function(n){return(n-.5)*360},n.prototype.projectToX=function(n,t,r){return r===void 0&&(r=!0),r&&(t=i.normalizeLongitude(t)),t/360+.5},n.prototype.projectToY=function(t){return n._latitudeToY(t)},n.prototype.getScale=function(n){e.assert(n&&n.bounds&&n.bounds.length===4,"Invalid region");var i=Math.abs(n.bounds[1]-n.bounds[3]),r=Math.abs(n.bounds[0]-n.bounds[2]),u=h.log2(1/Math.max(i,r));return t.toScale(null,u,!0)},n.getCenter=function(t){var r=t&&t.center;return r?new i(n._yToLatitude((n._latitudeToY(t.getNorth())+n._latitudeToY(t.getSouth()))/2),r.longitude,r.altitude,r.altitudeReference):null},n.prototype.getMatrix=function(n){if(n.id===this.id)return y.identity;if(n.getMatrix){var t=n.getMatrix(this);if(t)return t.invert()}throw"don't know how to convert from "+this.id+" to "+n.id;},n.getMercatorUnitsPerDegreeOfLatitude=function(t){var r=n._latitudeToY(t),i=Math.exp(Math.PI*(2*r-1));return(i*i+1)/(720*i)},n.getMercatorUnitsPerDegreeOfLongitude=function(){return 1/360},n._yToLatitude=function(n){return 90-2*Math.atan(Math.exp((n*2-1)*Math.PI))*h.degreesPerRadian},n._latitudeToY=function(t){if(t>=n._latitudeLimit)return 0;if(t<=-n._latitudeLimit)return 1;var i=Math.sin(t*h.radiansPerDegree);return.5-Math.log((1+i)/(1-i))*n._invFourPi},n.instance=new n,n._latitudeLimit=85.051128,n._invFourPi=1/(4*Math.PI),n._unitsPerMeterAtEquator=1/f.earthCircumference,n}(),et=function(){function n(){}return n.clip=function(n,t,i){return Math.max(Math.min(n,i),t)},n.pixelXYToLocation=function(t,r,u){var f=n.tileSize*Math.pow(2,u),e=n.clip(t,0,f-1)/f-.5,o=.5-n.clip(r,0,f-1)/f,s=90-360*Math.atan(Math.exp(-o*2*Math.PI))/Math.PI,h=360*e;return new i(s,h)},n.latitudeToPixelY=function(t,i){var f=n.tileSize*Math.pow(2,i),r,u;return t=n.clip(t,n.minLatitude,n.maxLatitude),r=Math.sin(t*Math.PI/180),u=.5-Math.log((1+r)/(1-r))/(4*Math.PI),u*f+.5},n.longitudeToPixelX=function(t,i){var u=n.tileSize*Math.pow(2,i),r;return t=n.clip(t,n.minLongitude,n.maxLongitude),r=(t+180)/360,r*u+.5},n.locationToPixelXY=function(t,i){return new l(n.longitudeToPixelX(t.longitude,i),n.latitudeToPixelY(t.latitude,i))},n.tileSize=256,n.enhancedBirdEyeTileHeight=180,n.minLatitude=-85.05112878,n.maxLatitude=85.05112878,n.minLongitude=-180,n.maxLongitude=180,n}(),yt=function(){function r(n,t,i,r,u,f,e,o,s){var h=this;this._map=n;this.nativeView=t;this.crs=i;this.imageryId=r;this.copyrightProvider=f;this._tileUrlTemplate=u;this._customMapStyleManager=o;this.downloadTimeOut=s;this._disposables=[];n&&e&&(n.getLabelController()?this._subscribeToLabelControllerLabelsEnabledEvent(n,this._tileUrlTemplate,e):n.labelControllerLoaded.addOne(function(){h._subscribeToLabelControllerLabelsEnabledEvent(n,h._tileUrlTemplate,e)}))}return r.prototype._subscribeToLabelControllerLabelsEnabledEvent=function(n,t,i){var r=this;this._disposables.push(n.getLabelController().changed.add(function(n){r._tileUrlTemplate=n.name==="isLabelsEnabled"&&n.newValue==!1?i:t}))},r.prototype._updateTileUrl=function(){if(typeof this._tileUrlTemplate=="string"){var n=ti.fromString(this._tileUrlTemplate);n.queryStringParameters&&this._customMapStyleManager&&n.queryStringParameters.st!==this._customMapStyleManager.styleString&&(n.queryStringParameters.st?(n.queryStringParameters.st=this._customMapStyleManager&&this._customMapStyleManager.styleString!==null?this._customMapStyleManager.styleString:null,this._tileUrlTemplate=n.toString(!0)):this._tileUrlTemplate+="&st="+this._customMapStyleManager.styleString)}},r.prototype.getTile=function(t,i,r,u,f,e,s){var b=this,c=t,y=c.quadKey,p="",h,l,a,w;return this._map&&typeof this._map.getAuthKey=="function"&&(p=this._map.getAuthKey()),this._customMapStyleManager&&this._customMapStyleManager.customMapStyleVersion!==this._customMapStyleVersionSynced&&((this._customMapStyleManager.styleString||this._tileUrlTemplate.indexOf("&st=")>=0)&&this._updateTileUrl(),this._customMapStyleVersionSynced=this._customMapStyleManager.customMapStyleVersion),typeof this._tileUrlTemplate=="string"?(h=this._tileUrlTemplate.replace("{x}",c.x.toString()).replace("{y}",c.y.toString()).replace("{zoom}",c.zoom.toString()).replace("{quadkey}",y).replace("{bbox}",this._getWMSBoundsString(t)).replace("{subdomain}",o._getTileSubDomain(y)).replace("{odmgenid}",v.dynamicProperties.compositionHandlerGenerationId).replace("{synthviewgenid}",v.dynamicProperties.synthViewGenerationId).replace("{mkt}",v.dynamicProperties.uiLanguage).replace("{credentials}",p).replace("{shading}",this._customMapStyleManager&&this._customMapStyleManager.settingHasValue("shadedReliefVisible",!1)?"flat":"hill"),l=v.dynamicProperties.userRegion,h=l&&v.dynamicProperties.isGeopolUserRegion?h.replace(/{ur}/,l):h.replace(/&ur={ur}/,""),a=n&&n.Internal&&n.Internal._VenueMapHelper,a&&(h=a.getModifiedVenueMapTileUrl(this._map,t,h))):(w=this._tileUrlTemplate,h=w(t)),nt.downloadImage(h,"raster",function(n){i(!0,n,c)},function(n,t){var o=t!==4&&r&&c.getParent();o?b.getTile(o,i,r,u,f,e,s):i(!1,null)},null,u,f,e,s)},r.prototype.dispose=function(){o._clearDisposables(this._disposables);this._map=null;this.nativeView=null;this.copyrightProvider=null},r.createMercatorImageryScene=function(n,f,e,o,s,h){return new r(o,new b(t.toLocation(new i(0,0),0,!0)),u.instance,n,f,e,s,h)},r.prototype._getWMSBoundsString=function(n){var t=it.fromRegionId(n);return t.getWest()+","+t.getSouth()+","+t.getEast()+","+t.getNorth()},r}(),oi=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),pt=function(n){function t(t,i,r,u,f,e,o,s,h){var c=n.call(this,t,i,r,u,f,e,o,s,h)||this;return c._placeholderTileUrl=c._map.getConfig().birdseyeV2PlaceHolderTileUrl,c._map.getMapOptions().constrainBirdseyeView||c._instantiateBorderReplacementImage(),c}return oi(t,n),t.prototype.getTile=function(n,i,u,f,e){var k=this._placeholderTileUrl,o=n,c=o&&o.zoom,s=this.crs&&this.crs.sceneMetadata,b;if(c&&s&&c<=s.endingZoomLevel&&c>=r.imageryStartZoom){var l=Math.pow(2,s.endingZoomLevel-c),a=Math.ceil(s.maxNumXTiles/l),y=Math.ceil(s.maxNumYTiles/l),d=Math.pow(2,c-r.imageryStartZoom+1),h=Math.ceil((Math.pow(2,c)-d)/2),p=o.x,w=o.y;p>=h&&p<h+a&&w>=h&&w<h+y&&(b=t.positionToQuadkey(p-h,w-h,c),k=this._tileUrlTemplate.replace("{subdomain}",b.charAt(b.length-1)).replace("{genId}",v.dynamicProperties.birdseyeV2ImageryGenerationId).replace("{base4SceneId}",s.base4SceneId).replace("{birdseyeV2Quadkey}",b).replace("{credentials}",this._map.getAuthKey()));this._map.getMapOptions().constrainBirdseyeView||(p===h+a-1&&s.width/l<a*o.pixelWidth&&(o.imageryWidth=s.width/l-(a-1)*o.pixelWidth),w===h+y-1&&s.height/l<y*o.pixelHeight&&(o.imageryHeight=s.height/l-(y-1)*o.pixelHeight))}return nt.downloadImage(k,"birdseyeV2Raster",function(n){i(!0,n)},function(n){i(!1,n)},null,f,e)},t.prototype.getSecondaryTile=function(){return t._borderReplacementImage},t.prototype.dispose=function(){t._brImageTimeoutId&&(window.clearTimeout(t._brImageTimeoutId),t._brImageTimeoutId=null);t._borderReplacementImage=null;n.prototype.dispose.call(this)},t.positionToQuadkey=function(n,t,i){for(var e,u="",f=0;f<=i-r.imageryStartZoom;f++)e=(n&1)+(t&1)*2,u=e+u,n>>=1,t>>=1;return u},t.prototype._instantiateBorderReplacementImage=function(){if(!t._borderReplacementImage){var n=document.createElement("img"),i=function(i){i&&(n.onload=null,window.clearTimeout(t._brImageTimeoutId),t._brImageTimeoutId=null,t._borderReplacementImage=n)};t._brImageTimeoutId||(t._brImageTimeoutId=Microsoft.Maps.setTimeout(function(){return i(!1)},5e3),n.onload=function(){i(!0)},n.src=this._placeholderTileUrl)}},t._borderReplacementImage=null,t}(yt),w;(function(n){n[n.north=0]="north";n[n.east=90]="east";n[n.south=180]="south";n[n.west=270]="west";n[n.North=0]="North";n[n.East=90]="East";n[n.South=180]="South";n[n.West=270]="West"})(w||(w={})),function(n){n[n.V1=0]="V1";n[n.V2=1]="V2"}(p||(p={}));r=function(){function n(t){this.cameraLocation=new i(0,0,0);this.width=0;this.height=0;this.originalWidth=0;this.originalHeight=0;this.imageScaleFactor=1;this.topLeftCorner=new i(0,0,0);this.topRightCorner=new i(0,0,0);this.bottomLeftCorner=new i(0,0,0);this.bottomRightCorner=new i(0,0,0);this.gtpMatrix=[0,0,0,0,0,0,0,0,0];this.ptgMatrix=[0,0,0,0,0,0,0,0,0];this.ecc=new l(0,0,0);switch(t.ver){case 0:this.version=p.V1;break;case 1:default:this.version=p.V2}this.sceneId=t.id;var r=this.sceneId.toString(4);this.base4SceneId=n._base4SceneIdTemplate.substr(0,n._base4SceneIdTemplate.length-r.length)+r;this.productId=t.pids&&t.pids.join(",")||"";this.version===p.V2&&(this.cameraType=this._getCameraType(t.cam),t.camlla&&t.camlla.length===3&&(this.cameraLocation=new i(t.camlla[0],t.camlla[1],t.camlla[2])));this.cLook=this._getHeading(t.clook);this.look=t.look;this.focalLength=t.fl;this.frameNumber=t.fra;t.size&&t.size.length===2&&t.osize&&t.osize.length===2&&(this.width=t.size[0],this.height=t.size[1],this.originalWidth=t.osize[0],this.originalHeight=t.osize[1],this.imageScaleFactor=this.width/this.originalWidth);this.endingZoomLevel=Math.min(n._imageryMaxZoom,n.imageryStartZoom+Math.ceil(h.log2(Math.max(this.width/n.tileWidth,this.height/n.tileHeight)))-1);this.maxNumXTiles=Math.ceil(this.width/n.tileWidth);this.maxNumYTiles=Math.ceil(this.height/n.tileHeight);t.ullla&&t.ullla.length===3&&t.urlla&&t.urlla.length===3&&t.lllla&&t.lllla.length===3&&t.lrlla&&t.lrlla.length===3&&(this.topLeftCorner=new i(t.ullla[0],t.ullla[1],t.ullla[2]),this.topRightCorner=new i(t.urlla[0],t.urlla[1],t.urlla[2]),this.bottomLeftCorner=new i(t.lllla[0],t.lllla[1],t.lllla[2]),this.bottomRightCorner=new i(t.lrlla[0],t.lrlla[1],t.lrlla[2]));this.avgAltitude=(this.topLeftCorner.altitude+this.topRightCorner.altitude+this.bottomLeftCorner.altitude+this.bottomRightCorner.altitude)/4;this.centerLocation=new i(t.la,t.lo,t.al);this.gtpMatrix=t.gtp;this.ptgMatrix=t.ptg;t.ecc&&t.ecc.length===3&&(this.ecc=new l(t.ecc[0],t.ecc[1],t.ecc[2]));this.maxTileOffset=(Math.pow(2,this.endingZoomLevel)-Math.pow(2,this.endingZoomLevel-n.imageryStartZoom+1))/2;this.minScale=this._calculateMinScale();this.version===p.V2&&(this.altitudeScaleFactor=this.ecc.z/this.cameraLocation.altitude,this.rawSceneWidth=this.originalWidth,this.sceneWidthOffset=0,this.cameraType!==5&&this.cameraType!==6&&this.originalWidth===n._expectedABSceneChildWidth&&(this.rawSceneWidth=n._expectedABSceneWidth,(this.cameraType===2||this.cameraType===3)&&(this.sceneWidthOffset=this.rawSceneWidth-this.originalWidth)));this._v1PixelOffsetX=0;this._v1PixelOffsetY=0;this._calculatePixelOffset()}return n.prototype.projectToXY=function(n,t){var s=[],f,r,i=this.gtpMatrix,l,e;if(this.version===p.V2){var c=this._latLongtoEcc(n,t),u=[-(c[0]-this.ecc.x),c[1]-this.ecc.y,c[2]-this.ecc.z],o=[i[0]*u[2]+i[1]*u[0]+i[2]*u[1],i[3]*u[2]+i[4]*u[0]+i[5]*u[1],i[6]*u[2]+i[7]*u[0]+i[8]*u[1]];f=o[0]/o[1]*this.focalLength;r=-(o[2]/o[1]*this.focalLength);f=this.rawSceneWidth/2+f-this.sceneWidthOffset;r=this.originalHeight/2+r;f*=this.imageScaleFactor;r*=this.imageScaleFactor;r=this.height-r;s=[f,r]}else this.version===p.V1&&(l=[[t],[n],[1]],e=h.matrixMultiply([[i[0],i[1],i[2]],[i[3],i[4],i[5]],[i[6],i[7],i[8]]],l),f=e[0][0]/e[2][0],r=e[1][0]/e[2][0],s=[f+this._v1PixelOffsetX,r+this._v1PixelOffsetY]);return s},n.prototype.projectToLatLong=function(n,t){var l=[];if(this.version===p.V2){t=this.height-t;n/=this.imageScaleFactor;t/=this.imageScaleFactor;n=n+this.sceneWidthOffset-this.rawSceneWidth/2;t=t-this.originalHeight/2;var e=n,o=t,r=this.focalLength,i=this.gtpMatrix,u=this.ecc,d=this.avgAltitude*this.altitudeScaleFactor,s=d-u.z,a=r*i[1]-e*i[4],v=e*i[5]-r*i[2],b=r*s*i[0]+r*i[1]*u.x-r*i[2]*u.y-e*s*i[3]-e*u.x*i[4]+e*u.y*i[5],y=-o*i[4]-r*i[7],w=o*i[5]+r*i[8],k=r*i[8]*u.y-r*s*i[6]-r*i[7]*u.x+o*i[5]*u.y-s*i[3]*o-o*i[4]*u.x,g=(b*w-v*k)/(a*w-v*y),nt=(b*y-a*k)/(v*y-a*w);l=this._eccToLatLong(g,nt)}else if(this.version===p.V1){var tt=[[n-this._v1PixelOffsetX],[t-this._v1PixelOffsetY],[1]],f=this.ptgMatrix,c=h.matrixMultiply([[f[0],f[1],f[2]],[f[3],f[4],f[5]],[f[6],f[7],f[8]]],tt),it=c[0][0]/c[2][0],rt=c[1][0]/c[2][0];l=[rt,it]}return l},n.prototype.isLocationInsideScene=function(n){var t=this.projectToXY(n.latitude,n.longitude),i=!1;return t[0]>0&&t[0]<this.width&&t[1]>0&&t[1]<this.height&&(i=!0),i},n.prototype.canCoverViewportWithLocation=function(n,i,r,u,f){var o=!1,e,s;if(r){e=f;e||(s=d.getBirdseyeV2MinZoom(r,this,i),e=Math.max(Math.min(this.endingZoomLevel,t.fromLocation(n,!0)),s));var h=Math.pow(2,this.endingZoomLevel-e),c=this.projectToXY(n.latitude,n.longitude),l=c[0],a=c[1],v=r.pixelWidth*(.5-u)*h,y=r.pixelHeight*(.5-u)*h;o=l>v&&l<this.width-v&&a>y&&a<this.height-y}else o=this.isLocationInsideScene(n);return o},n.getDeltaZoomBetweenScenes=function(n,t){var i=0;return n&&t&&(i=Math.round(h.log2(t.minScale/n.minScale))),i},n.normalizeHeading=function(n){var t=(n||0)%360;return t<0&&(t+=360),t},n.prototype._calculatePixelOffset=function(){if(this.version===p.V1){var n=0,t=0,i=this.projectToXY(this.topLeftCorner.latitude,this.topLeftCorner.longitude),r=this.projectToXY(this.topRightCorner.latitude,this.topRightCorner.longitude),u=this.projectToXY(this.bottomLeftCorner.latitude,this.bottomLeftCorner.longitude),f=this.projectToXY(this.bottomRightCorner.latitude,this.bottomRightCorner.longitude);n+=2*this.width-(i[0]+r[0]+u[0]+f[0]);t+=2*this.height-(i[1]+r[1]+u[1]+f[1]);this._v1PixelOffsetX=n/4;this._v1PixelOffsetY=t/4}},n.prototype._latLongtoEcc=function(t,i){var u=(i+180)/360*256*Math.pow(2,n._eccLod),r=Math.sin(t*Math.PI/180),f=(.5-Math.log((1+r)/(1-r))/(4*Math.PI))*256*Math.pow(2,n._eccLod);return[u,f,this.avgAltitude*this.altitudeScaleFactor]},n.prototype._eccToLatLong=function(t,i){var u=360*t/(256*Math.pow(2,n._eccLod))-180,r=Math.pow(Math.E,(.5-i/(256*Math.pow(2,n._eccLod)))*4*Math.PI),f=(r-1)/(r+1),e=Math.asin(f)*180/Math.PI;return[e,u]},n.prototype._calculateMinScale=function(){var i=this.cLook===w.north||this.cLook===w.south,n=i?this.height:this.width,t=i?this.width:this.height,r,u,e,o;return i?(r=Math.abs(f.latitudeDegreesToMeters(this.topLeftCorner.latitude)-f.latitudeDegreesToMeters(this.bottomLeftCorner.latitude))/n,u=Math.abs(f.latitudeDegreesToMeters(this.topRightCorner.latitude)-f.latitudeDegreesToMeters(this.bottomRightCorner.latitude))/n,e=Math.abs(f.longitudeDegreesToMeters(this.topLeftCorner.longitude)-f.longitudeDegreesToMeters(this.topRightCorner.longitude))/t,o=Math.abs(f.longitudeDegreesToMeters(this.bottomLeftCorner.longitude)-f.longitudeDegreesToMeters(this.bottomRightCorner.longitude))/t):(r=Math.abs(f.latitudeDegreesToMeters(this.topRightCorner.latitude)-f.latitudeDegreesToMeters(this.topLeftCorner.latitude))/n,u=Math.abs(f.latitudeDegreesToMeters(this.bottomRightCorner.latitude)-f.latitudeDegreesToMeters(this.bottomLeftCorner.latitude))/n,e=Math.abs(f.longitudeDegreesToMeters(this.bottomRightCorner.longitude)-f.longitudeDegreesToMeters(this.topRightCorner.longitude))/t,o=Math.abs(f.longitudeDegreesToMeters(this.bottomLeftCorner.longitude)-f.longitudeDegreesToMeters(this.topLeftCorner.longitude))/t),(r+u+e+o)/4},n.prototype._getHeading=function(n){var t;switch(n){case"E":t=w.east;break;case"S":t=w.south;break;case"W":t=w.west;break;case"N":default:t=w.north}return t},n.prototype._getCameraType=function(n){var t;switch(n){case 2:t=1;break;case 3:t=2;break;case 4:t=3;break;case 5:t=4;break;case 6:t=5;break;case 7:t=6;break;case 0:default:t=0}return t},n.tileWidth=512,n.tileHeight=512,n.imageryStartZoom=18,n._expectedABSceneChildWidth=6870,n._expectedABSceneWidth=13450,n._base4SceneIdTemplate="000000000000000",n._eccLod=23,n._imageryMaxZoom=22,n}();wt=function(){function n(){if(n.instance)return n.instance;this.id="Robinson";this.bounds=[0,1,1,0];this.tileInfo={tileWidth:256,tileHeight:128,minZoom:1,maxZoom:23};this._latitudeLengths=[1,.9986,.9954,.99,.9822,.973,.96,.9427,.9216,.8962,.8679,.835,.7986,.7597,.7186,.6732,.6213,.5722,.5322];this._latitudeOffsets=[0,.062,.124,.186,.248,.31,.372,.434,.4958,.5571,.6176,.6769,.7346,.7903,.8435,.8936,.9394,.9761,1];for(var t=0,i=this._latitudeOffsets.length;t<i;t++)this._latitudeOffsets[t]*=.5072}return n.prototype.toLatitude=function(n,t){return this._getLatitude(t)},n.prototype.toLongitude=function(n,t){var i=this._getLatitudeLength(this.toLatitude(n,t));return Math.max(-180,Math.min((n-.5)/i*360,180))},n.prototype.projectToX=function(n,t){var i=this._getLatitudeLength(n);return t*i/360+.5},n.prototype.projectToY=function(n){var t=this._getLatitudeOffset(n);return.5+t},n.prototype.getScale=function(n){e.assert(n&&n.bounds&&n.bounds.length===4,"Invalid region");var i=h.log2(1/(n.bounds[1]-n.bounds[3]));return t.toScale(null,i,!0)},n.prototype._getLatitudeLength=function(n){return this._interpolate(n,this._latitudeLengths)},n.prototype._getLatitudeOffset=function(n){var t=this._interpolate(n,this._latitudeOffsets);return n>=0?-t:t},n.prototype._getLatitude=function(n){var i,t,r,u,f,e;if(n===.5)return 0;if(i=n<.5,n=Math.abs(n-.5),n>=this._latitudeOffsets[this._latitudeOffsets.length-1])return i?90:-90;for(t=1,r=this._latitudeOffsets.length;t<r;t++)if(u=this._latitudeOffsets[t],u>=n||t===r-1)return f=this._latitudeOffsets[t-1],e=(t-1)*5+(n-f)/(u-f)*5,i?e:-e},n.prototype._interpolate=function(n,t){if(n=Math.abs(n),n%5==0)return t[n/5];n=n/5;var i=Math.floor(n),r=t[i],u=t[i+1];return r+(u-r)*(n-i)},n.instance=new n,n}();n.CompositeMapMode=ii;n.EnhancedBirdseyeCrs=ui;n.Heading=w;n.BirdseyeV2Crs=c;n.BirdseyeV2Manager=rt;n.BirdseyeV2Metadata=r;n.MercatorCubeCrs=u;s._MercatorTileUtility=et;s.RegionIndex=vt;s.HitTestIndex=fi;s.HitTestController=ei;n.RasterImageryScene=yt;n.BirdseyeV2ImageryScene=pt;n.Viewport=at}catch(bt){if(n.logger)n.logger.logCriticalError(bt);else throw bt;}}).call(window)