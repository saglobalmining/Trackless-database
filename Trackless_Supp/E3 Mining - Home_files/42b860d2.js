(function(){try{(function(){var n={L_Link_Generating_Text:"Creating the link â€¦",L_Link_GenerationFailed_Text:"There was a problem creating the link. Try again.",L_Permalink_Prompt:"Share this map",L_TaskBar_Label_SearchBox:"Search Term",L_TaskBar_Label_Clear:"Clear Search Term",L_TaskBar_Label_Search:"Search",L_TaskBar_Label_Directions:"Directions",L_TaskBar_Label_Traffic:"Traffic",L_TaskBar_Label_Favorites:"My Places",L_TaskBar_Label_More:"More",L_SearchNearbyTransit:"Nearby Transit",L_SearchNearbyParking:"Parking",L_Permalink_Email_Button_Tooltip:"Email link",L_Print_Submit:"Print",L_PrintPreview:"Print Preview",L_PrintMapAndText:"Map & Text",L_PrintMapOnly:"Map only",L_PrintTextOnly:"Text only",L_PermalinkCopy_Text:"Copy",L_PermalinkEmail_Text:"Email",L_Permalink_Email_Button_Text:"Email",L_PermalinkFacebook_Text:"Facebook",L_PermalinkTwitter_Text:"Twitter",L_Twitter_Tag_Text:"on #BingMaps",L_PermalinkHeaderPrompt_Text:"Share",L_PermalinkLink_Text:"Link",L_PermalinkPrompt_Text:"Select the cards above that you would like to share",L_Link_TooManyItemsSelected_Text:"Unable to share. Please unselect some items and try sharing in smaller groupings (5-10 items at a time).",L_Link_EmailTitleManyCards_Text:"Bing Maps session shared with you",L_Link_EmailFooter_Text:"Shared from Bing Maps",L_LengthenButton_Text:"Show full URL",L_ShortenButton_Text:"Shorten",L_EditMapDone_Text:"Done",L_EditMap_Text:"Move or zoom map",L_SlideOutMenu_MapType:"Map",L_SlideOutMenu_MapType_Road:"Road View",L_SlideOutMenu_MapType_Aerial:"Aerial View",L_SlideOutMenu_MapType_Birdseye:"Birds View",L_SlideOutMenu_SeeAllCards:"See all card",L_SlideOutMenu_BingHome:"Bing Home",L_SlideOutMenu_Feedback:"Feedback",L_SlideOutMenu_ExitPreview:"Exit preview",L_PrintNotes:"Notes",L_PrintNotesWatermark:"Type your notes here",L_PermalinkEmbed_Text:"Embed",L_Menu_Exit_Text:"Previous Version",L_Menu_Feedback_Text:"Feedback",L_TaskBar_Label_Print:"Print",L_TaskBar_Label_Share:"Share",L_Menu_Tips_Text:"Tips",L_TaskBar_Label_Fullscreen:"Full Screen",TaskBarLogoTitle:"Back to Bing search",BEV2DetailsInstruction:"1. In cards",BEV2Introduction:"New and crisp Bird's Eye imagery is available in many metropolitan areas.",BEV2TransientLensInstruction:"2. Right-click on the map",BEV2WelcomeText:"Bird's Eye has changed",BEV2ImageIntroduction:"There are two ways of viewing the new Bird's Eye.",BEV2TipNote:"Note: Bird's Eye may not be available in your area as outdated imagery is no longer available.",L_CategoryLayerDropdownButton:"All {0}",L_CategoryLayerDropdownTitle:"Show on map",L_CategoryLayer_Schools:"Schools",L_CategoryLayer_Transit:"Public Transport",L_CategoryLayer_Commutability:"Commute",ShareEmailToolTip:"Send in email",ShareFBToolTip:"Share to Facebook",ShareTwitterToolTip:"Post to Twitter",L_CmtControlTitleText:"Commute boundary",L_CmtControlAddLocationText:"Add location",L_CmtControlCommuteTime30Text:"30 min",L_CmtControlCommuteTime45Text:"45 min",L_CmtControlCommuteTime60Text:"1 hr",L_CmtControlCommuteTime15Text:"15 min",L_CmtControlCommutePeak_Text:"Peak",L_CmtControlCommuteOffPeak_Text:"Off Peak",L_CmtControlPushpinTitle:"A",L_CmtControlPushpinTwoTitle:"B",L_CmtEditText:"Edit",L_CmtDoneText:"Done",L_CmtTitle:"{time} min commute to {addresses} in {trafficCondition} traffic",L_CmtTitleAddresses:"{addr1} and {addr2}",ShareClose:"Close",ShareUrlLabel:"Copy URL",L_CategoryUserTip_Header:"Show on map",L_CategoryUserTip_Message1:"We've turned on the map layers you selected",L_CategoryUserTip_Message2:"Pan and Zoom to see more results",L_ZoomInUserTip_Message:"Zoom in or use filters to narrow your search"};window.$MicrosoftMaps8.ResourceManager?window.$MicrosoftMaps8.ResourceManager.init("InternalControls",n):window.$MicrosoftMaps8.ResourcesObject=n})();var t=window.$MicrosoftMaps8,r=t.Internal,fi=r.TaskData,wr=t.Anchor,br=t.GlobalConfig.features.autosuggest,ei=t.CommonControls.AutosuggestViewModel,oi=t.CommonControls.AutosuggestV2,kr=r._BaseMapTemplateSelector,dr=r.BaseTask,si=r.BaseTaskViewModel,gr=t.BitmapImageTemplate,pt=fi.CollectionActions,nt=r._ComponentNames,ot=r.Control,tt=r.ControlTemplate,u=t.DataHandlerKeys,nu=r._Debug,tu=t.DefaultTemplateSelector,hi=t.CommonControls.DropdownItem,h=r._EntryPoints,a=r._FeatureNames,iu=t.GlobalConfig.features.feedback,ru=t.FiltersBarModuleViewModel,uu=t.FiltersBar,fu=t.FiltersBarItem,eu=t.FiltersBarItemData,ou=r.GeolocationProvider,n=r._Gimme,c=t.GlobalConfig,f=t.GlobalDataEventHandler,v=r._Helper,su=t.CommonControls.IDropDownListData,hu=t.ImageFromCssHelper,ct=t.ImageryMapLayer,o=r._JSEvent,ci=t.Layer,li=t.LocationRect,k=r._LoggerConstants,cu=r.MapInteractionBehavior,it=r.MapHelper,wt=t.Location,lu=t.MapsFeedback,g=t.MapTypeId,bt=t.MapView,lt=t.CommonControls.ModalDialogViewModel,au=t.MoveableSimplePointPrimitive,ai=r._Network,vu=t.GlobalConfig.features.notification,vi=r._ObservableObject,kt=r._ObservableCollection,yu=r._OverlayEntity,yi=r._Overlay,pi=t.Point,wi=t.CommonControls.PopOutButtonViewModel,dt=c.features.parking,y=r.Permalink,pu=t.PrimitiveOverlayHelper,d=t.GlobalConfig.features.print,bi=r.PrintContent,ki=t.Pushpin,i=t.ResourceManager.InternalControls,di=r.ReverseGeocoder,gi=t.CommonControls.SearchBoxAutosuggestDataModel,wu=r.SDKPrimitiveTemplateSelector,bu=t.SimplePointPrimitive,gt=t.Size,p=t.GlobalConfig.features.sharing,ut=r.SharingInstrumentationAction,ni=t.LabelVisibility,ku=r._StreetsidePerfConstants,du=t.GlobalConfig.features.streetside,e=t.GlobalConfig.features.taskBar,gu=r._TaskDataHandlerHelper,nr=t.CommonControls.TaskBarDropdownViewModel,s=t.TaskTypes,nf=c.features.traffic,tf=t.MouseEventArgs,at=t.VectorMapLayer,rf=t.VenueMaps,ti=r.TaskData.Waypoint,st=t.ZoomLevel,ht='<div class="{Binding className}" role="search" aria-label="{Binding resources.L_Landmark_TaskBar_Aria_Label}" data-tag="TaskBar">        <ul>            <li class="sbElement">                <a href="/" class="b_logoArea" alt="{Binding resources.TaskBarLogoTitle}" title="{Binding resources.TaskBarLogoTitle}">                    <h1 class="b_logo b_taskLogo"><\/h1>                <\/a>            <\/li>            <li class="inputbox">                <div id="maps_sb_container" data-tag="maps_sb_container">                    <div class="searchbox">                        <input id="maps_sb" type="search" role="combobox" title="{Binding resources.L_TaskBar_Label_SearchBox}" length="20" maxlength="1000" value="{Binding searchTerm Mode=TwoWay}" autocomplete="off" aria-haspopup="true" aria-expanded="{Binding asExpanded}" aria-controls="as_container" aria-owns="as_container" aria-autocomplete="both" aria-activedescendant="{Binding selectedSuggestionId}" data-tag="TaskBar.SearchBox"><\/input>                        <div class="searchButton">                            <a href="#" class="searchIcon" tabindex="-1" data-instrumentation="{Binding searchInstData}" title="{Binding resources.L_TaskBar_Label_Search}" role="button" event:click="invokeLocalSearchHandler" data-tag="TaskBar.SearchButton" />                        <\/div>                    <\/div>                <\/div>            <\/li>        <\/ul>    <ItemsControl ItemsSource="{Binding taskBarItems}">        <ItemsControl.Template>            <DataTemplate>                <ul class="actions"><ItemsPresenter /><\/ul>            <\/DataTemplate>        <\/ItemsControl.Template>        <ItemsControl.ItemTemplate>            <DataTemplate>                <li style:display="{Binding isActive Converter=boolToDisplay}" class="action">                    <a href="#" class="{Binding cssClass}" data-task="{Binding taskOption Converter=stringify}" data-instrumentation="{Binding instrumentationData}" event:click="clickHandler" event:touchend="clickHandler" event:mouseover="mouseoverHandler" event:mouseout="mouseoutHandler" event:keydown="keydownHandler" title="{Binding name}" role="button" data-tag="{Binding dataTag}">                        <span style:display="{Binding showLabel Converter=boolToDisplay}" class="actionLabel">                            <TextBlock Text="{Binding name}" />                        <\/span>                    <\/a>                <\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <div class="clear"><\/div>    <div class="bm_contextualAndShowMe">        <!-- Container for contextual taskbar -->        <div id="bm_contextualTaskbarContainer">        <\/div>        <!-- Container for the category layer dropdown -->        <div id="bm_categoryLayerDropdownContainer">        <\/div>    <\/div>    <!-- The following is the close button for local overlay on serp -->    <div class="overlayCloseBtn">        <a role="button" class="overlayCloseLink" title="{StaticBinding resources.L_CloseTask_Text}" event:click="onOverlayCloseButtonClicked">            <div class="icon svg"><\/div>        <\/a>    <\/div><\/div>',w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),rt=function(t){function r(u,f,s,h,l){var a=this,y={},p;return a=t.call(this,y,h,s)||this,y.defineProperty("searchTerm"),y.defineProperty("className"),y.defineProperty("asExpanded"),y.defineProperty("selectedSuggestionId"),y.defineProperty("isOnVertical"),a._isMapsAnswer=Microsoft&&Microsoft.Maps&&Microsoft.Maps.GlobalConfig&&Microsoft.Maps.GlobalConfig.isMapsAnswer,e.fullScreen=a._isMapsAnswer?!1:e.fullScreen,a._minimumActionButtonsWidth=e.minimumActionButtonsWidth,a._minNavButtonWidth=e.minimumNavButtonWidth,a._searchBoxWidth=e.searchBoxWidth,a._navButtonWidth=e.navButtonWidth,a._minSearchBoxWidth=e.minSearchBoxWidth,a._searchButtonWidth=e.searchButtonWidth,a._noTextBuffer=e.taskbarTextBuffer,a._resizeBuffer=e.taskBarResizeBuffer,a._maxActionButtonsWidth=e.maximumActionButtonsWidth,a._searchBoxLeftBuffer=e.taskbarLeftBuffer,a._rightTaskbarBuffer=e.taskbarRightBuffer,a._smallSearchControlsWidth=a._minSearchBoxWidth,a._fullSearchControlsWidth=a._searchBoxWidth,a.setClassName("taskBar"),a.setSearchTerm(""),a._taskManager=l,a.taskBarItems=[],r._taskItems=[],a.createTaskItems(),a._map=f,r._staticMap=f,e.alwaysShowHomeWork&&a.setUpAlwaysOnPoi(),a._container=u,a.launchFeedbackMenu=new o,a.hideFeedbackMenu=new o,a.focusFeedback=new o,a.exitFullScreen=new o,a.exitFullScreen.add(function(){return r.exitFullScreen()}),a._map&&(a.disposables.push(a._map.viewChanged.add(function(){return a.mapInteractedEvent()})),a.disposables.push(a._map.mapTapped.add(function(){return a.mapInteractedEvent()})),a.disposables.push(a._map.mapZoomStarted.add(function(){return a.mapInteractedEvent()})),a.disposables.push(a._map.primitiveTapped.add(function(){return a.mapInteractedEvent()}))),a.disposables.push(a._taskManager.stackFocused.add(function(){r.enableDirectionsSearch=!1})),a._menuList=[],a._touchByPassMouseout=!1,(a._trafficItem||a.isFeatureEnabled("traffic"))&&a._container.instanceAsync("TrafficLayerV2",function(n){a._trafficLayer=n;n&&(a._showTrafficLayerAfterInstantiation&&n.show(1),a._setTrafficButtonSelected(n.getIsShowing()),a.disposables.push(a._trafficLayer.changed.add(function(n){n.name==="isShowing"&&a._setTrafficButtonSelected(n.newValue)})))}),a.resources=i,a.searchInstData=a.createInstrumentationData(r._searchFeatureName),f&&(a.disposables.push(l.stackRemoved.add(function(){l.getStacks().length===0&&(a.setSearchTerm(""),a._searchBox&&a._searchBox.focus())})),a.disposables.push(f.mapTypeChanged.add(function(n){n.newMapTypeId===g.birdseye?(a._trafficItem&&a._trafficItem.setCssClass("trafficIcon realign disabled"),a._trafficIsDisabled=!0):n.oldMapTypeId===g.birdseye&&(a._trafficIsDisabled=!1,a._trafficLayer&&a._setTrafficButtonSelected(a._trafficLayer.getIsShowing()));a._setTextAlignment(a.taskBarItems)}))),a._isMapsAnswer||a._setTextAlignment(a.taskBarItems),e.showTaskBarLabels&&(n(window).add_event("resize",function(n){a._onResizeHandler(n)}),e.fullScreen&&n(window).add_event("fullscreenChange,webkitfullscreenChange,mozfullscreenChange,msfullscreenchange,msfullscreenChange,MSFullscreenChange",function(n){a._onResizeHandler(n)})),v._isTravelOverlayShownOnSerp()&&(n("#id_h")[0].style.display="none"),p=e.isEnabled?"block":"none",v._isSmallMapShownOnSerp()&&(p="none"),a.getControl().set_style({display:p}),a.setIsOnVertical(c.isMapsVertical),a._isMapsAnswer&&(a.disposables.push(f.actualSizeChanged.addOne(function(){var i=n(".actions")[0],t;if(i&&(a.actionBarSize=i.getBoundingClientRect().width),t=n(".b_searchboxForm")[0],t){var r=n(".searchButton")[0],u=r?r.getBoundingClientRect().width:40,f=t.getBoundingClientRect().width-u;a._setSearchControlsWidth(n(".inputbox",a.getControl()[0])[0],f)}a._setTextAlignment(a.taskBarItems)})),a.disposables.push(f.actualSizeChanged.add(function(){a._setTextAlignment(a.taskBarItems)}))),a}return w(r,t),r.prototype.setSearchBox=function(t){var i=this;this._searchBox=t;n(this._searchBox).add_event("keydown",function(n){i._onSearchBoxEnter(n)})},r.prototype.dispose=function(){n(window).remove_event("keyup",this._windowEventHandler);n(window).remove_event("keyup",this.onEscapeEvent);n(window).remove_event("keydown",this._firefoxEscapeEventHandler);n(window).remove_event("fullscreenChange,webkitfullscreenChange,mozfullscreenchange,msfullscreenChange,MSFullscreenChange,msfullscreenchange",this._onResizeHandler)},r.prototype.setActionsOptions=function(t){for(var e,o,s,f=this.taskBarItems,u=0;u<f.length;u++)t===511&&(f[u].action===8||f[u].action===256)?f[u].setIsActive(!1):(f[u].setIsActive((t&f[u].action)!=0),r.isFullScreen&&f[u].name===i.L_TaskBar_Label_Fullscreen&&(e=r._getTaskbarFullScreenButton(null),e.add_class("selected"),o=r.getMenuItem(i.L_TaskBar_Label_Fullscreen),s=n(".fullscreenIcon",o),s.add_class("selected")))},r.prototype.setActionsState=function(n,t){for(var i,o,u,e=this.taskBarItems,s=this.getControl(),f=0;f<e.length;f++)i=e[f],(n&i.action)!=0&&(o=i.getDataTag(),u=s.select('*[data-tag="'+o+'"]'),t==1?u.remove_class(r._pressedButtonClass):t==2&&u.add_class(r._pressedButtonClass),i.setCssClass(u.get_attr("class")))},r.prototype.stringify=function(t){return n.Internals.stringify(t)},r.prototype.setSearchBoxFocus=function(){if(this._searchBox)if(this._searchBox.focus(),r.enableDirectionsSearch=!0,typeof this._searchBox.selectionStart=="number")this._searchBox.selectionStart=this._searchBox.selectionEnd=this._searchBox.value.length;else if(typeof this._searchBox.createTextRange!="undefined"){var n=this._searchBox.createTextRange();n.collapse(!1);n.select()}},r.prototype.mapInteractedEvent=function(){r.enableDirectionsSearch=!1;this.hideMenu()},r.prototype.hideMenu=function(){var t=this;window.clearTimeout(r._mouseOverDelayHandle);r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){var i=n(".dropdownEntry",t._taskBarPopOutElement[0]),f,u,r;if(i&&i.length>0&&i[0].blur(),f=!1,u=n(".popOutTemplate",t._taskBarPopOutElement[0]),u&&u.length>0){if(u[0].querySelector(":focus")||u[0].querySelector(":hover")||u[0].querySelector(":active"))f=!0;else for(r=0;r<i.length;r++)if(i[r].parentElement.querySelector(":hover")||i[r].parentElement.querySelector(":active")||i[r].parentElement.querySelector(":focus")||i[r].querySelector(":focus")||i[r].querySelector(":hover")||i[r].querySelector(":active")){f=!0;break}f&&u.get_style("display")!=="none"||t.clearMenuElements()}},r._mouseTimeout*2)},r.prototype.mouseoverMenuHandler=function(t){var i=this;window.clearTimeout(r._mouseOverDelayHandle);r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){i._setMoreTaskItemClass(!0);n(".taskBarPopout",i._map.getRootElement().getParent()[0]).set_style({display:"block"});i._initializeMenu(t)},r._mouseTimeout-100);t&&t.preventDefault&&t.preventDefault()},r.prototype.onFullScreenClick=function(t){var e=this;this._windowEventHandler||(this._windowEventHandler=function(n){return e.onEscapeEvent(n)},document.addEventListener("mozfullscreenchange",this.onEscapeEvent),document.addEventListener("webkitfullscreenchange",this.onEscapeEvent),document.addEventListener("msfullscreenChange",this.onEscapeEvent),document.addEventListener("MSFullscreenChange",this.onEscapeEvent),document.addEventListener("msfullscreenchange",this.onEscapeEvent),document.addEventListener("fullscreenchange",this.onEscapeEvent),n(window).add_event("keyup",this.onEscapeEvent));r.enableDirectionsSearch=!1;var u=r._getTaskbarFullScreenButton(t),o=r.getMenuItem(i.L_TaskBar_Label_Fullscreen),f=n(".fullscreenIcon",o),s=n("#container");u&&(u.has_class("selected")?(n(u).exit_full_screen(),u.remove_class("selected"),f.remove_class("selected"),r.isFullScreen=!1):(n(u).set_full_screen(s[0]),u.add_class("selected"),f.add_class("selected"),r.isFullScreen=!0,r._logFullScreen(!0)),r._adjustContainerTop());t&&t.preventDefault()},r.getMenuItem=function(t){var e=n(".taskBarPopout",r._staticMap.getRootElement().getParent()[0])[0],f=n(".popOutInner",e)[0],u,i;if(f&&f.childElementCount>0)for(u=f.children,i=0;i<u.length;i++)if(u[i].innerHTML.indexOf(t)>-1)return u[i];return null},r.prototype.clearMenuElements=function(){this.hideFeedbackMenu.invoke();this._taskbarPopOutButtonViewModel&&this._taskbarPopOutButtonViewModel.setIsDisplayed(!1);n(".taskBarPopout",this._map.getRootElement().getParent()[0]).set_style({display:"none"});this._setMoreTaskItemClass(!1)},r.prototype._setMoreTaskItemClass=function(n){for(var i,t=r._taskItems.length-1;t>0;t--)if(r._taskItems[t].getCssClass().indexOf("moreIcon")>-1){i=r._taskItems[t];break}r._handleSelectedClass(i,n)},r._handleSelectedClass=function(t,i){if(t)if(i)t.getCssClass().indexOf("selected")===-1&&t.setCssClass(t.getCssClass()+" selected");else while(t.getCssClass().indexOf("selected")>-1)t.setCssClass(t.getCssClass().replace(" selected","")),n(".moreIcon").fireEvent("blur")},r.prototype.mouseoutMenuHandler=function(n){var t=this;this._touchByPassMouseout||(window.clearTimeout(r._mouseOverDelayHandle),r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){t.hideFeedbackMenu.invoke()},r._mouseTimeout));this._touchByPassMouseout=!1;n&&n.preventDefault&&n.preventDefault()},r.prototype.hoverFeedbackButton=function(){var t=n(".fullscreenMenuLink",this._taskBarPopOutElement[0]);t&&t.length>0&&t[0].parentElement.parentElement.focus()},r.prototype.boolToDisplay=function(n){return n?"":"none"},r.prototype.boolToHide=function(n){return n?"none":""},r.prototype.onEscapeEvent=function(n){var t=n,i=document.mozFullScreenElement||document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;(t&&t.key&&(t.key==="Escape"||t.key==="Esc")||t.keyCode&&t.keyCode===27||(n.type==="mozfullscreenchange"||n.type==="webkitfullscreenchange"||n.type==="fullscreenchange"||n.type==="msfullscreenchange"||n.type==="MSFullscreenChange"||n.type==="msfullscreenChange")&&!i)&&(r.exitFullScreen(),r._logFullScreen(!1));n.preventDefault()},r.prototype.onOverlayCloseButtonClicked=function(){c.dynamicProperties.mapsOverlayClosing=!0;v._isTravelOverlayShownOnSerp()&&n("#id_h").remove_attr("display");f.invokeHandler(u.taskDataHandlerKey,{action:"removeAllStacks"});ft.getInstance().clearCategories();var t={logData:{feature:nt.TaskBar,action:k.Clicked,data:{FN:r._featureNameToAction.Overlay,CN:"Close"}}};c.dynamicProperties.serpIG&&(t.impressionGuid=c.dynamicProperties.serpIG);f.invokeHandler(u.instrumentationDataHandlerKey,t)},r.exitFullScreen=function(){var t=this._getTaskbarFullScreenButton(null),u=r.getMenuItem(i.L_TaskBar_Label_Fullscreen),f=n(".fullscreenIcon",u);t.has_class("selected")&&(n("#container").exit_full_screen(),t.remove_class("selected"),f.remove_class("selected"));r.isFullScreen=!1;r._adjustContainerTop()},r.prototype.setIconClass=function(){var f=this._getShowTaskBarItemLabel(),u=n(".actions",this.getControl()[0])[0],t,i,r;if(u&&u.style&&u.style.display!="none")if(t=n(".action"),!f&&t&&t.length>0)for(i=0;i<t.length;i++)r=t[i].firstElementChild,r&&r.classList.contains("realign")&&r.classList.remove("realign");else if(t&&t.length>0)for(i=0;i<t.length;i++)r=t[i].firstElementChild,r&&!r.classList.contains("realign")&&r.classList.add("realign")},r._getTaskbarFullScreenButton=function(t){var i=t&&t.target;return i?i.className.indexOf("actionLabel")>-1?n(i.parentElement):i.className.indexOf("action")>-1?n(i.firstChild):n(i):n(".taskBar .fullScreenIcon")},r.prototype._onSearchBoxEnter=function(n){var t=n,e=t.keyCode||t.which,i;e===13&&(i=this._getInstData(r._searchFeatureName),f.invokeHandler(u.instrumentationDataHandlerKey,i))},r.prototype._createTaskItemWithTaskOption=function(n,t,i,r,u){var f=new vt;return f.setCssClass(n),f.taskOption=t,f.action=i,f.setIsActive(!0),f.setDataTag(u?u:""),f.setShowLabel(r),f},r.prototype.createTaskItemWithClickHandler=function(n,t,i,r,u){var f=new vt;return f.setCssClass(n),f.clickHandler=function(n){t(n);n.preventDefault()},f.action=i,f.setIsActive(!0),f.setDataTag(u?u:""),f.setShowLabel(r),f},r.prototype.createTaskItemWithMouseHandlers=function(n,t,i,u,f){var o=this,e=new vt;return e.setCssClass(n),e.mouseoverHandler=function(n){window.clearTimeout(r._mouseOverDelayHandle);r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){t(n)},r._mouseTimeout);n&&n.preventDefault&&n.preventDefault()},e.mouseoutHandler=function(n){o._touchByPassMouseout||(window.clearTimeout(r._mouseOverDelayHandle),r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){n.target.tagName==="A"&&(n&&n.preventDefault&&n.preventDefault(),o.hideMenu())},r._mouseTimeout));o._touchByPassMouseout=!1},e.clickHandler=function(n){(n.type==="touchend"||n.type==="pointerup")&&(o._touchByPassMouseout=!0);n&&n.preventDefault&&n.preventDefault();t(n);n.cancelBubble=!0;n.stopPropagation()},e.keydownHandler=function(n){var i=n,u=i.keyCode||i.which;u===40&&e.getCssClass().indexOf("selected")===-1&&(window.clearTimeout(r._mouseOverDelayHandle),r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){t(n)},r._mouseTimeout),n&&n.preventDefault&&n.preventDefault())},e.action=i,e.setIsActive(!0),e.setDataTag(f?f:""),e.setShowLabel(u),e.setPopoutClass("taskBarPopout"),e},r.prototype.createTaskItems=function(){var n=this._getShowTaskBarItemLabel();this.addDirectionsItem(n);this.addTrafficItem(n);this.addCollectionItem(n);this.addSharingItem(n);this.addMoreMenuItem(n);this.addfullScreenItem(n)},r.prototype.addCollectionItem=function(n){if(this.isFeatureEnabled("collections")){var t=this.createTaskItemWithClickHandler("placesIcon realign",function(n){if(n.type!=="pointerup"){r.enableDirectionsSearch=!1;var t={entryPoint:1,action:pt.GetAllCollections},i={type:s.collectionsTask,state:t};f.invokeHandler(u.taskDataHandlerKey,i);n.preventDefault()}},2,n,"TaskBar.CollectionsButton");t.name=i.L_TaskBar_Label_Favorites;t.instrumentationData=this.createInstrumentationData(s.collectionsTask);this.taskBarItems.push(t);r._taskItems.push(t)}},r.prototype.makeHomeWorkRequest=function(){var t={entryPoint:1,action:pt.ProcessCardlessPrimitives},i={type:s.collectionsTask,requestorType:"TaskBar",requestState:t,hiddenTask:!0},n=this._map.getFrameManager();n&&n.frameRendered&&n.frameRendered.addOne(function(){f.invokeHandler(u.taskProcessDataHandlerKey,i)})},r.prototype.setUpAlwaysOnPoi=function(){var t=this,n;v._isSmallMapShownOnSerp()?(n=function(){t.makeHomeWorkRequest();sj_evt.unbind("LargeMapShown",n)},sj_evt.bind("LargeMapShown",n)):this.makeHomeWorkRequest()},r.prototype.addSharingItem=function(n){var e=c.features.sharing,t;e&&e.isEnabled&&!e.disableOutboardSharing&&(t=this.createTaskItemWithClickHandler("shareIcon realign",function(n){n.type!=="pointerup"&&(r.enableDirectionsSearch=!1,f.invokeHandler(u.shareDataHandlerKey,{entryPoint:h.TaskBar}))},8,n,"TaskBar.ShareButton"),t.name=i.L_TaskBar_Label_Share,t.instrumentationData=this.createInstrumentationData(r._shareFeatureName),t.setIsActive(!1),this.taskBarItems.push(t),r._taskItems.push(t))},r.prototype.addMoreMenuItem=function(n){var u=this,t;t=this.createTaskItemWithMouseHandlers("moreIcon realign",function(n){u.mouseoverMenuHandler(n)},128,n,"Taskbar.MoreButton");t.name=i.L_TaskBar_Label_More;this.taskBarItems.push(t);r._taskItems.push(t)},r.prototype.addfullScreenItem=function(n){var u=this,t;e.fullScreen&&(t=this.createTaskItemWithClickHandler("fullScreenIcon",function(n){if(n.type!=="pointerup")u.onFullScreenClick(n)},256,n,"Taskbar.FullscreenButton"),t.name=i.L_TaskBar_Label_Fullscreen,t.setIsActive(!1),this.taskBarItems.push(t),r._taskItems.push(t))},r.prototype.addTrafficItem=function(n){var u=this,t;this.isFeatureEnabled("traffic")&&(this._trafficItem=t=this.createTaskItemWithClickHandler("trafficIcon",function(n){n.type!=="pointerup"&&(r.enableDirectionsSearch=!1,u._map.getMapType().id!==g.birdseye&&(u._trafficLayer?u._trafficLayer.toggle(1):u._showTrafficLayerAfterInstantiation=!0))},32,n,"TaskBar.TrafficButton"),t.name=i.L_TaskBar_Label_Traffic,t.instrumentationData=this.createInstrumentationData(r._trafficFeatureName),this.taskBarItems.push(t),r._taskItems.push(t))},r.prototype.addDirectionsItem=function(n,t){var u=this,r;this.isFeatureEnabled("directions")&&(t?r=this._createTaskItemWithTaskOption("directionsIcon realign",{type:s.directionsTask,state:t},1,n,"TaskBar.DirectionsButton"):(r=this.createTaskItemWithClickHandler("directionsIcon realign",function(n){if(n.type!="pointerup")u.onDirectionsClick(n)},1,n,"TaskBar.DirectionsButton"),r.name=i.L_TaskBar_Label_Directions,r.instrumentationData=this.createInstrumentationData(s.directionsTask)),this.taskBarItems.push(r))},r.prototype.isFeatureEnabled=function(n){return c&&c.features[n]&&c.features[n].isEnabled},r.prototype.createInstrumentationData=function(n){var t=this._getInstData(n);return this.stringify(t)},r.prototype.onDirectionsClick=function(n){var t=this._taskManager.getFocusedStack()?this._taskManager.getFocusedStack().getForegroundTask():null,i,e;t&&(t.type===s.localDetailsTask||t.type===s.polygonEntityDetailsTask)&&!r.enableDirectionsSearch?(this._logDirectionsSearch(),this._getCardDetailsForDirections(t.type)):r.enableDirectionsSearch&&this._searchBox.value.length>0?(this._logDirectionsSearch(),this._getDetailsForDirections()):(i={entryPoint:1},e={type:s.directionsTask,state:i},f.invokeHandler(u.taskDataHandlerKey,e));r.enableDirectionsSearch=!1;n.preventDefault()},r.prototype._getCardDetailsForDirections=function(n){var t={searchEntitiesRequested:!0,entryPoint:h.TaskBar},i={requestorType:"TaskBar",type:n,requestState:t,useActiveTasks:!0};f.invokeHandler(u.taskProcessDataHandlerKey,i)},r.prototype._getDetailsForDirections=function(){var n={disableTaskActivate:!0,query:this._searchBox.value,entryPoint:h.TaskBar},t={requestorType:"TaskBar",type:s.localDetailsTask,requestState:n,useActiveTasks:!1};f.invokeHandler(u.taskProcessDataHandlerKey,t)},r.prototype._logDirectionsSearch=function(){var n={logData:{feature:nt.TaskBar,action:k.Selected,data:{C:"DS"}}};f.invokeHandler(u.instrumentationDataHandlerKey,n)},r._logFullScreen=function(n){var t=n?"FSO":"FSE",i={logData:{feature:nt.TaskBar,action:"C",data:{FN:t}}};f.invokeHandler(u.instrumentationDataHandlerKey,i)},r.prototype._getInstData=function(n){return{logData:{feature:nt.TaskBar,action:k.Clicked,data:{FN:r._featureNameToAction[n]}}}},r.prototype._getMenuInstData=function(n){return{logData:{feature:nt.TaskBar,action:k.Clicked,data:{FN:n}}}},r.prototype._initializeMenu=function(t){var u=this,f,o,r,i;t&&t.preventDefault();f=n(".taskBarPopout",this._map.getRootElement().getParent()[0]);f&&f.length>0&&(o=n(".feedbackPopOut")[0],o&&this._map.getRootElement().getParent().insertBefore(o,this._map.getRootElement()));this._menuList.length===0&&(r=c.features.sharing,r&&r.isEnabled&&!r.disableOutboardSharing&&this._menuList.push(this._createShareMenuItem()),this.isFeatureEnabled("print")&&this._menuList.push(this._createPrintMenuItem()),this.isFeatureEnabled("feedback")&&this._menuList.push(this._createFeedbackMenuItem()),e.fullScreen&&this._menuList.push(this._createFullscreenMenuItem()));this._showDropdown(t);n(".feedbackMenuLink").add_event("touchend",function(t){var i=n(".feedbackMenuLink").parent(),r;u.launchFeedbackMenu.invoke(i);r=u._map.getMode();t&&t.preventDefault&&t.preventDefault();u._touchByPassMouseout=!0});i=this._taskBarPopOutElement.select(".dropdownEntry");(t.type==="click"||t.type==="keydown")&&i&&i.length>0&&(i[0].focus(),i[0].style.border="none")},r.prototype._createShareMenuItem=function(){var n=this;return{name:i.L_TaskBar_Label_Share,handler:function(){f.invokeHandler(u.shareDataHandlerKey,{entryPoint:h.TaskBar});n._setMoreTaskItemClass(!1)},mouseouthandler:function(t){n.hideMenu();t&&t.stopPropagation()&&t.preventDefault()},cssClass:"shareMenuLink",iconClass:"shareIcon menuLinkIcon",instData:this._getMenuInstData(a.Share)}},r.getCurrentActiveTask=function(n){var i="",t;return n&&(t=n.getFocusedStack(),t?t.getForegroundTask()&&(i=t.getForegroundTask().type):i="BaseMap"),i},r.prototype._createPrintMenuItem=function(){var n=this,t=this._taskManager;return{name:i.L_TaskBar_Label_Print,handler:function(){var i=r.getCurrentActiveTask(t);f.invokeHandler(u.printDataHandlerKey,{source:1,fullScreen:r.isFullScreen,taskType:i});n._setMoreTaskItemClass(!1)},mouseouthandler:function(t){n.hideMenu();t&&t.stopPropagation()&&t.preventDefault()},cssClass:"printMenuLink",iconClass:"printIcon menuLinkIcon",instData:this._getMenuInstData(a.Print)}},r.prototype._createFeedbackMenuItem=function(){var t=this;return{name:i.L_Menu_Feedback_Text,mouseoverhandler:function(){window.clearTimeout(r._submenuMouseOverDelayHandle);r._submenuMouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){var i=n(".feedbackMenuLink").parent();t.launchFeedbackMenu.invoke(i)},r._mouseTimeout)},handler:function(){var i=n(".feedbackMenuLink").parent();t.launchFeedbackMenu.invoke(i)},mouseouthandler:function(n){t._touchByPassMouseout||(window.clearTimeout(r._submenuMouseOverDelayHandle),r._submenuMouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){t.hideFeedbackMenu.invoke()},r._mouseTimeout*2));t._touchByPassMouseout=!1;n&&n.stopPropagation()&&n.preventDefault()},cssClass:"feedbackMenuLink",iconClass:"feedbackIcon menuLinkIcon",subMenu:!0,instData:this._getMenuInstData(a.Feedback)}},r.prototype._createFullscreenMenuItem=function(){var t=this,u=n(".fullScreenIcon.realign"),r="fullscreenIcon menuLinkIcon";return u.has_class("selected")&&(r+=" selected"),{name:i.L_TaskBar_Label_Fullscreen,handler:function(n){t.onFullScreenClick(n);t._setMoreTaskItemClass(!1)},mouseouthandler:function(n){t.hideMenu();n&&n.stopPropagation()&&n.preventDefault()},cssClass:"fullscreenMenuLink",iconClass:r,instData:this._getMenuInstData(a.Fullscreen)}},r.prototype._showDropdown=function(t){var e=this,i=t.target,u;i.className.indexOf("actionLabel")>-1?i=t.target.parentElement.parentElement:i.className.indexOf("Icon")>-1&&(i=i.parentElement);this._taskbarDropdownViewModel?this._taskbarPopOutButtonViewModel&&this._taskbarPopOutButtonViewModel.getIsDisplayed()===!0&&(this._taskbarPopOutButtonViewModel.setIsDisplayed(!1),this._taskbarDropdownViewModel.setDropdown(this._menuList),this._taskbarDropdownViewModel.setButtonElement(n(i)),this._taskbarPopOutButtonViewModel.setDropdown(this._taskbarDropdownViewModel)):(this._taskbarDropdownViewModel=new nr(this._menuList,n(i)),this._taskbarPopOutButtonViewModel=new wi(this._taskbarDropdownViewModel,null,this._taskbarDropdownViewModel.taskBarListDropDownTemplate),u=this._taskbarPopOutButtonViewModel.buildPopOut(),this._taskBarPopOutElement=n(".taskBarPopout",this._map.getRootElement().getParent()[0]),this._taskBarPopOutElement.append(u));var r=i.getBoundingClientRect(),o=r.height+10,f=n(window).get_scroll_pos().x,s=window.innerHeight/window.document.documentElement.offsetHeight*100<80,h=!(f===0||s);h?(this._taskBarPopOutElement.set_style({left:r.left+f+"px"}),this._taskBarPopOutElement.set_style({right:""})):(this._taskBarPopOutElement.set_style({left:r.left+"px"}),this._taskBarPopOutElement.set_style({right:""}));this._taskBarPopOutElement.set_style({top:o+"px"});n(".taskBarPopout").add_event("keydown",function(n){e._onMenuKeyDown(n)});this._taskbarPopOutButtonViewModel.setIsDisplayed(!0)},r.prototype._showIdControls=function(){var u=n("#b_header")[0],r,t,i;u&&(r=n("#id_h",u)[0],r&&(t=n("#id_l",r),i=n("#id_rh",r),window.innerWidth<e.taskbarButtonsShowTextWidth+100?(t&&!t.has_class("hide")&&t.add_class("hide"),i&&!i.has_class("hide")&&i.add_class("hide")):(t&&t.has_class("hide")&&t.remove_class("hide"),i&&i.has_class("hide")&&i.remove_class("hide"))))},r.prototype._setTextAlignment=function(n){for(var i=n,r=this._getShowTaskBarItemLabel(),t=0;t<i.length;t++)i[t].setShowLabel(r);this._adjustSearchBoxWidth();this._showIdControls()},r.prototype._adjustSearchBoxWidth=function(){var u=this.getControl()[0],t,i,f,r;if(u.clientWidth>0)if(t=n(".inputbox",u)[0],i=n("#taskbarPrimer")[0],i&&i.clientWidth>0)f=n(".inputbox",i)[0],this._setSearchControlsWidth(t,f.getBoundingClientRect().width);else if(this._isMapsAnswer&&this.actionBarSize<this._minimumActionButtonsWidth&&(this.actionBarSize=this._maxActionButtonsWidth),t){var o=this._rightTaskbarBuffer+this._searchBoxLeftBuffer+this._navButtonWidth+this._maxActionButtonsWidth,s=this._fullSearchControlsWidth-this._minSearchBoxWidth,e=window.innerWidth-(this._fullSearchControlsWidth+o);e>0?this._setSearchControlsWidth(t,this._searchBoxWidth):(r=s-Math.abs(e),r<0?this._setSearchControlsWidth(t,this._minSearchBoxWidth):this._setSearchControlsWidth(t,this._minSearchBoxWidth+r))}},r.prototype._setSearchControlsWidth=function(t,i){var u,f,r;t&&(u=38,f=n("#maps_sb",t)[0],t.setAttribute("style","width: "+i+"px"),r=n(".as_container_search",t),r&&r.get_style("visibility")==="visible"&&this._searchBox.value.length>-1&&r.set_style({width:i+"px"}))},r.prototype.insertPopoutInMap=function(){var t=n(".taskBarPopout",this._map.getRootElement().getParent()[0]);t&&t.length!==0||(this._taskBarPopOutElement=v._createElement("div"),this._taskBarPopOutElement.set_attr("class","taskBarPopout"),this._map.getRootElement().getParent().insertBefore(this._taskBarPopOutElement[0],this._map.getRootElement()))},r.prototype._onResizeHandler=function(){var c=this._getShowTaskBarItemLabel(),f,u,o,s,i,t,h,r;for(this._showIdControls(),this._setTextAlignment(this.taskBarItems),f=this.taskBarItems,u=0;u<f.length;u++)f[u].setShowLabel(c);if(this.setIconClass(),v._isLargeMapShownOnSerp()||v._isTravelOverlayShownOnSerp()){if(o=window.innerWidth,s=document.getElementById("b_header"),s)if(i=n(".id_button",s),o<=e.taskBarMapTypeTextMinWidth)for(t=0;t<i.length;t++)i[t].style.padding="0";else for(t=0;t<i.length;t++)i[t].removeAttribute("style");h=document.getElementsByTagName("html")[0];r=n(".b_footer.b_slimFoot.bm_oneMap")[0];o<=e.windowMinWidth?(h.style.overflowX="auto",r&&(r.style.zIndex="1001")):(h.style.overflowX="hidden",r&&r.removeAttribute("style"))}},r._adjustContainerTop=function(){var t=n("#container")[0];r.isFullScreen&&(t.style.top="0",t.style.bottom="0")},r.prototype._onMenuKeyDown=function(t){var s=this,o=t,u=o.keyCode||o.which,i,f,e;u===9?this.hideMenu():u===37?this.clearMenuElements():u===13||u===39?(i=t.target,i.className.indexOf("dropdownEntry")>-1&&(i=i.children[0],i&&(i=i.children[0])),i.className.indexOf("feedback")>-1&&this.launchFeedbackMenu.invoke(n(".feedbackMenuLink").parent()),window.clearTimeout(r._mouseOverDelayHandle),r._mouseOverDelayHandle=Microsoft.Maps.setTimeout(function(){s.focusFeedback.invoke()},r._mouseTimeout*2)):u===40?(f=t.target.nextElementSibling,f&&n(f)[0].focus()):u===38&&(e=t.target.previousElementSibling,e?n(e)[0].focus():this.clearMenuElements())},r.prototype._setTrafficButtonSelected=function(t){var i=n(".trafficIcon")[0];i&&(t&&!i.classList.contains("selected")?i.classList.add("selected"):!t&&i.classList.contains("selected")&&i.classList.remove("selected"));this._trafficIsSelected=t},r.prototype._getShowTaskBarItemLabel=function(){return this._searchBoxWidth==null?!1:e.showTaskBarLabels&&window.innerWidth>e.taskbarButtonsShowTextWidth+(v._isLargeMapShownOnSerp()?50:0)},r._shareFeatureName="Share",r._searchFeatureName="Search",r._trafficFeatureName="Traffic",r._fullscreenFeatureName="Fullscreen",r._overlayFeatureName="Overlay",r._taskbarStyleSet="",r._taskbarStyle="",r._mouseTimeout=150,r._featureNameToAction=function(){var n={};return n[s.collectionsTask]=a.Collections,n[s.directionsTask]=a.Directions,n[r._shareFeatureName]=a.Share,n[r._searchFeatureName]=a.Search,n[r._trafficFeatureName]=a.Traffic,n[r._fullscreenFeatureName]=a.Fullscreen,n[r._overlayFeatureName]=a.Overlay,n}(),r.hiddenStyle={visibility:"hidden"},r.visibleStyle={visibility:"visible"},r._pressedButtonClass="pressed",r._fullScreenModalDialogContentTemplate='<div class="fullscreenEscape"><p>{escText}<\/p><\/div>',r.isFullScreen=!1,r}(si),tr=function(){function t(t,i,r,u){var f=this,h,s,l;if(ht)this._taskManager=u,this._viewModel=this._CreateTaskBarViewModel(t,i,ht,r,this._taskManager),h=this._viewModel.getControl(),this._map=i,this._controlTemplateFactory=r,s=i.getRootElement(),this.feedbackInitialize=new o,this._viewModel.launchFeedbackMenu.add(function(n){f.feedbackInitialize.invoke(n)}),this.dismissMenu=new o,this.dismissMenu.add(function(){f._viewModel.hideMenu()}),this.dismissFeedbackMenu=new o,this.focusFeedbackMenu=new o,this._viewModel.focusFeedback.add(function(){f.focusFeedbackMenu.invoke()}),this._viewModel.hideFeedbackMenu.add(function(){f.dismissFeedbackMenu.invoke()}),this.hoverFeedbackButton=new o,this.hoverFeedbackButton.add(function(){f._viewModel.hoverFeedbackButton()}),this.exitFullScreen=new o,this.exitFullScreen.add(function(){f._viewModel.exitFullScreen.invoke()}),this._visibilityChangedEvent=new o,this._visibilityChangedEvent.add(function(n){f._viewModel.setAsExpanded(n)}),this._selectionChangedEvent=new o,this._selectionChangedEvent.add(function(n){f._viewModel.setSelectedSuggestionId(n)}),this._map.mapTapped.add(function(){f._searchBox.blur()}),s.getParent().insertBefore(h,s),l=n("#maps_sb"),this._viewModel.setIconClass(),this._viewModel._adjustSearchBoxWidth(),this._searchBox=l[0],this._viewModel.setSearchBox(this._searchBox),n(".searchIcon").add_event("click",function(n){f.handleSearchButtonEvents(n)}),c.features.autosuggest.isEnabled&&(this._suggestionItemSelected=new o,this._suggestionItemSelected.add(function(n){f._onSuggestionItemSelected(n)}),this._suggestionItemClicked=new o,this._suggestionItemClicked.add(function(n){f._onSuggestionItemClicked(n)}),this._onAutosuggestKeydown=new o,this._onAutosuggestKeydown.add(function(n){f.onAutosuggestKeydownFunction(n)}),this._clickHandler=new o,this._clickHandler.add(function(){f.handleClick()})),Feedback.Bootstrap.InitializeFeedback({structured:!0},"tdd_feedback",!1,!0,!1),Feedback.Bootstrap.InitializeFeedback({structured:!0},"tdd_exit",!1,!0,!1),this._viewModel.insertPopoutInMap(),this.fullScreenEnabled=e.fullScreen;else throw"Template is not defined!";this._clearSuggestions=!1;e.showCategoryLayers&&ft.getInstance().initialize()}return t.prototype.initializeAutosuggest=function(){var r=n("#maps_sb_container"),u=n("#maps_sb"),t=new gi,i;this._searchBoxAutosuggestDataModel=t;this._autosuggestViewModel=new ei(t,this._controlTemplateFactory,!0,"TaskBarSearch",this._visibilityChangedEvent,this._selectionChangedEvent);i="as_container_search";this._autosuggest=new oi(r,u,i,this._autosuggestViewModel,this._map);this._autosuggest.setAutosuggestKeydownHandler(this._onAutosuggestKeydown);this._autosuggest.setItemSelectionEventHandler(this._suggestionItemSelected);this._autosuggest.setItemClickEventHandler(this._suggestionItemClicked);this._autosuggest.setClickEventHandler(this._clickHandler)},t.prototype.handleSearchButtonEvents=function(n){rt.enableDirectionsSearch=!1;this._autosuggest&&this._autosuggest.instrumentSearchButtonClickEvent();var t=this._autosuggestViewModel&&this._autosuggestViewModel.getSelectedSuggestion();this._performSearch(h.SearchButton,t);n&&n.preventDefault&&n.preventDefault()},t.prototype.handleClick=function(){rt.enableDirectionsSearch=!0;this._autosuggest&&this._autosuggest.refreshAutosuggest();this._clearSuggestions&&(rt.enableDirectionsSearch=!1,this._clearSuggestions=!1,this._searchBox&&this._searchBox.removeAttribute("placeholder"),this._searchBoxAutosuggestDataModel.clearDefaultSuggestions())},t.prototype.onAutosuggestKeydownFunction=function(n){var r=n,u=r.keyCode||r.which,t,i;u==13&&(rt.enableDirectionsSearch=!1,i=h.SearchBox,this._autosuggestViewModel&&(t=this._autosuggestViewModel.getSelectedSuggestion()),t&&(i=h.Autosuggest),this._performSearch(i,t))},t.prototype.processCallback=function(n){var i,t,r,e;n&&n.inData&&n.processorType&&n.outData&&(n.processorType===s.localDetailsTask||n.processorType===s.polygonEntityDetailsTask)&&(i={entryPoint:1},t=n.inData.requestState,t&&(t.searchEntitiesRequested||t.disableTaskActivate)&&n.outData&&n.outData.length>0&&(r=this._getWaypoint(n.outData),r&&(i.waypoints=[r])),e={type:s.directionsTask,state:i},f.invokeHandler(u.taskDataHandlerKey,e))},t.prototype._getWaypoint=function(n){var i,r,u,f,t;if(n[0]&&n[0].data)if(i=null,n[0].processorId){for(r=0;r<n.length;r++)if(u=n[r],f=u.processorId,this._taskManager.getFocusedStack()&&this._taskManager.getFocusedStack().getForegroundTask().id===f&&(t=u.data.length>0?u.data[0]:null,t)){i=new ti(t.getAddress(),t.getLocation(),t.getTitle(),!1,null,t.id,null,null,null,2,5);break}}else n[0].data.entities&&n[0].data.entities.length>0&&(t=n[0].data.entities[0],t&&(i=new ti(t.getAddress(),t.getLocation(),t.getTitle(),!1,null,t.id,null,null,null,2,5)));return i},t.prototype._onSuggestionItemSelected=function(n){this.setSearchTerm(n.searchText)},t.prototype._onSuggestionItemClicked=function(n){this._performSearch(h.Autosuggest,n)},t.prototype._performSearch=function(n,t){var a=this,h=this._searchBox?this._searchBox.value.trim():this._viewModel.getSearchTerm().trim(),r,e,v,y,o,p,l,w,b;if(this._autosuggest&&this._autosuggest.stopAutosuggest(),r={},r.query=h,r.entryPoint=n,t&&(this.setSearchTerm(t.searchText),r.query=t.searchText,r.fullQuery=t.searchText,r.filterUrlParam=t.entityId,r.mapBounds=t.mapBounds,t.type==="Favorite"&&(!t.entityId&&t.location&&(r.query=t.location.latitude+","+t.location.longitude,r.fullQuery=r.query),r.taskTitle=t.alternateName||t.name)),e=this._map.getMode(),e&&(e.mapModeType===2||e.mapModeType===3)&&h?(v=e.getPreviousMapType(),this._map.setMapType(v),y=e.getPreviousMode(),this._map.setMode(y),this.setActionsOptions(511)):this._map.getMapType().id===g.birdseyeV2&&h&&this._map.getBirdseyeV2Manager().then(function(n){var t=a._map.getMapTypes()[n.previousMapState.mapTypeId||g.road];t&&a._map.setBaseLayers(t)}),o=c.features,t&&t.title===i.L_SearchNearbyTransit&&o&&o.transit&&o.transit.isEnabled){p={location:it.getMapCenter(this._map),title:this._nearbyLocationTitle,entryPoint:1};f.invokeHandler(u.taskDataHandlerKey,{state:p,type:s.nearbyTransitTask});return}if(dt.isEnabled&&t&&t.title===i.L_SearchNearbyParking&&(l=it.getMapCenter(this._map),w=this._isAddressInsideSupportedCityForNearbyParking(l),w)){b={location:l,title:this._nearbyLocationTitle,entryPoint:4};f.invokeHandler(u.taskDataHandlerKey,{type:s.nearbyParkingTask,state:b});return}f.invokeHandler(u.taskProcessDataHandlerKey,{requestState:r,type:s.localSearchTask})},t.prototype.setActionsOptions=function(n){this._viewModel.setActionsOptions(n)},t.prototype.setActionsState=function(n,t){this._viewModel.setActionsState(n,t)},t.prototype.setSearchTerm=function(n,t){this._viewModel.setSearchTerm(n);t&&f.invokeHandler(u.taskProcessDataHandlerKey,{type:s.localSearchTask,requestState:{query:n}})},t.prototype.getSearchTerm=function(){return this._viewModel.getSearchTerm()},t.prototype.setSearchBoxFocus=function(){this._viewModel.setSearchBoxFocus()},t.prototype.getSearchBox=function(){return n(this._searchBox)},t.prototype.setSearchBoxGhostText=function(n){this._searchBox&&(this.setSearchTerm(""),this._searchBox.setAttribute("placeholder",n),this.setSearchBoxFocus(),this._clearSuggestions=!0)},t.prototype.updateSearchBoxAutosuggestDefault=function(n,t){this._searchBoxAutosuggestDataModel.updateDefaultSuggestions(n,t);this._autosuggest.refreshAutosuggest()},t.prototype.setNearbyLocationTitle=function(n){this._nearbyLocationTitle=n},t.prototype._CreateTaskBarViewModel=function(n,t,i,r,u){return c.isMobile?new MobileTaskBarViewModel(n,t,ht,r,u):new rt(n,t,ht,r,u)},t.prototype._isAddressInsideSupportedCityForNearbyParking=function(n){for(var t,u,r=JSON.parse(dt.supportedCities),i=0;i<r.length;i++)if(t=r[i],u=li.fromEdges(t.top,t.left,t.bottom,t.right),u.contains(n))return!0;return!1},t}(),w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),vt=function(n){function t(){var i=this,t={};return i=n.call(this,t)||this,t.defineProperty("isActive"),t.defineProperty("cssClass"),t.defineProperty("dataTag"),t.defineProperty("showLabel"),t.defineProperty("popoutClass"),i}return w(t,n),t}(vi),ir='<div class="bm_categorySearchContainer" data-tag="ShowMeControls" >    <div class="recommendedCategoryContainer">        <ItemsControl ItemsSource="{TemplateBinding CategoryList}">            <ItemsControl.ItemTemplate>                <DataTemplate>                    <div>                        <a class="recommendedCategory" data-tag="recommendedCategory" style:display="{Binding Recommended Converter=boolToDisplay}" event:click="onItemClick" href="#">                            <span class="{Binding Checked Converter=itemCheckedClass}"><\/span>                            <span class="{Binding Icon}"><\/span>                            <span class="categoryName">                                <TextBlock Text="{Binding Name}" />                            <\/span>                        <\/a>                    <\/div>                <\/DataTemplate>            <\/ItemsControl.ItemTemplate>        <\/ItemsControl>    <\/div>    <div class="{TemplateBinding CheckCount Converter=countClassConverter}" data-tag="CategoryDropdown">        <MultiselectDropdown ItemList="{TemplateBinding CategoryList}" ButtonName="{TemplateBinding DropdownButtonName}" DropdownTitle="{TemplateBinding dropdownTitle}" ButtonIcon="moreIcon" />    <\/div><\/div>',rr='<div class="{TemplateBinding IsFaded Converter=boolToFadedClass}" data-tag="UserTip" style:display="{TemplateBinding IsHidden Converter=boolToNotDisplay}">    <div class="tooltipsText">        <div class="tooltipsHeader" style:display="{TemplateBinding Title Converter=nullToDisplayNone}">            <TextBlock Text="{TemplateBinding Title}" />        <\/div>        <ItemsControl ItemsSource="{TemplateBinding MessageLines}">            <ItemsControl.ItemTemplate>                <DataTemplate>                    <div class="tooltipsMessage">                        <TextBlock Text="{Binding $self$}" />                    <\/div>                <\/DataTemplate>            <\/ItemsControl.ItemTemplate>        <\/ItemsControl>    <\/div>    <a class="tooltipsClose" href="#" title="{TemplateBinding resources.L_Tooltip_Close_Text}" event:click="closeClicked" style:display="{TemplateBinding ShowClose Converter=boolToDisplay}">    <\/a><\/div>',w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ur=function(n){function t(t,r,u,f){var e=this,s={},h;return e=n.call(this,s)||this,s.defineProperty("title"),s.defineProperty("messageLines"),s.defineProperty("isFaded"),s.defineProperty("isHidden"),s.defineProperty("showClose"),e.setMessageLines(u),e.setTitle(r),e.setShowClose(!0),e.resources=i,e.tipRemoved=new o,e._map=t,e.setTemplate(new tt(rr,{boolToDisplay:function(n){return e._boolToDisplay(n)},boolToNotDisplay:function(n){return e._boolToDisplay(!n)},boolToFadedClass:function(n){return e._boolToFadedClass(n)},nullToDisplayNone:function(n){return e._nullToDisplayNone(n)},closeClicked:function(n){n.preventDefault();e.fadeTip()}})),e._tipElement=e.getRootElement(),h=function(){window.clearTimeout(e._fadeTimeout);e._tipElement&&e.fadeTip()},f||(e.disposables.push(e._map.mapPanStarted.addOne(h)),e.disposables.push(e._map.mapTapped.addOne(h)),e.disposables.push(e._map.mapZoomStarted.addOne(h)),e._fadeTimeout=Microsoft.Maps.setTimeout(function(){e._tipElement&&e.fadeTip()},8e3)),e}return w(t,n),t.prototype.fadeTip=function(){var n=this;this.setIsFaded(!0);Microsoft.Maps.setTimeout(function(){n._tipElement&&n._tipElement.removeFromParent();n._tipElement=null;n.tipRemoved&&n.tipRemoved.invoke();n.dispose()},3e3)},t.prototype._boolToDisplay=function(n){return n?"":"none"},t.prototype._boolToFadedClass=function(n){return"bm_tooltips"+(n?" reminderHiddenFade":"")},t.prototype._nullToDisplayNone=function(n){return n?"":"none"},t}(ot),w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),fr=function(n){function t(){var r=this,o={},u,s,f,h,t;if(r=n.call(this,o)||this,o.defineProperty("categoryList"),o.defineProperty("checkCount"),o.defineProperty("dropdownButtonName"),r.setCheckCount(0),u=e.categoryLayers,s=[],u)for(f=0,h=u.length;f<h;f++){switch(u[f]){case"school":t=new et(i.L_CategoryLayer_Schools,u[f]);t.setIcon("schoolsIcon");break;case"transit":t=new et(i.L_CategoryLayer_Transit,u[f]);t.setIcon("transitIcon");break;case"commutability":t=new et(i.L_CategoryLayer_Commutability,u[f]);t.setIcon("commuteIcon");break;case"coffee":t=new et("Coffee",u[f]);break;case"grocery":t=new et("Grocery Stores",u[f]);break;case"gasstation":t=new et("Gas Stations",u[f])}t&&(t.onCheckedChanged.add(function(n){r._updateCheckCount(n)}),s.push(t))}return r.setCategoryList(s),r.setDropdownButtonName(i.L_CategoryLayerDropdownButton.replace("{0}","")),r.dropdownTitle=i.L_CategoryLayerDropdownTitle,r.setTemplate(new tt(ir,{boolToDisplay:function(n){return r._boolToDisplay(n)},itemCheckedClass:function(n){return r._itemCheckedClass(n)},countClassConverter:function(n){return r._countClassConverter(n)}})),r}return w(t,n),t.prototype.setRecommendedCategories=function(n){for(var t,u,i,f=this.getCategoryList(),e=n.length,r=0,o=f.length;r<o;r++){for(t=f[r],u=!1,i=0;i<e;i++)if(t.getCategory()===n[i]){t.setRecommended(!0);u=!0;break}u||t.setRecommended(!1)}},t.prototype.clearCategories=function(){for(var t=this.getCategoryList(),n=0,i=t.length;n<i;n++)t[n].setChecked(!1);this.setCheckCount(0);f.invokeHandler(u.layerManagerDataHandlerKey,{action:"removeAllLayers"})},t.prototype._countClassConverter=function(n){return n>0?"someCategoriesPadding":"noCategoriesPadding"},t.prototype._boolToDisplay=function(n){return n?"":"none"},t.prototype._itemCheckedClass=function(n){return"multiselectCheckbox"+(n?" checked":"")},t.prototype._updateCheckCount=function(n){var t=this.getCheckCount();n?t++:t--;this.setCheckCount(t);this.setDropdownButtonName(i.L_CategoryLayerDropdownButton.replace("{0}",t===0?"":"("+t+")"))},t}(ot);tt.registerControl("CategoryDropdown",fr);var ft=function(){function t(){}return t.getInstance=function(){return t._instance||(t._instance=new t),t._instance},t.prototype.initialize=function(){if(!this.initialized){n(".bm_contextualAndShowMe").add_class("enabled");var t=n("#bm_categoryLayerDropdownContainer");this._categoryDropdownControl=tt.createControl("CategoryDropdown");t.append(this._categoryDropdownControl.getRootElement());this.initialized=!0;v._isSmallMapShownOnSerp()&&n("#MicrosoftNav").add_class("OnSerp")}},t.prototype.setRecommendedCategories=function(n){n&&n.length>0&&this.initialize();this._categoryDropdownControl&&this.initialized&&this._categoryDropdownControl.setRecommendedCategories(n)},t.prototype.clearCategories=function(){this._categoryDropdownControl&&this.initialized&&this._categoryDropdownControl.clearCategories()},t}(),w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),et=function(n){function t(t,i){var r=this,u={};return r=n.call(this,t,u)||this,u.defineProperty("category"),u.defineProperty("recommended"),r.setCategory(i),r.onCheckedChanged.add(function(n){r._onCheckedChanged(n)}),r}return w(t,n),t.prototype._onCheckedChanged=function(n){n?this._makeActivateLayerRequest(this.getCategory()):this._makeRemoveLayerRequest(this.getCategory())},t.prototype._makeActivateLayerRequest=function(n){f.invokeHandler(u.layerManagerDataHandlerKey,{action:"activateLayer",category:n,entryPoint:h.TaskBar,showTip:!0});var t={logData:{feature:nt.ShowMeCategoryLayers,action:k.Clicked,data:{Cat:n,S:!0}}};f.invokeHandler(u.instrumentationDataHandlerKey,t)},t.prototype._makeRemoveLayerRequest=function(n){f.invokeHandler(u.layerManagerDataHandlerKey,{action:"removeLayer",category:n,entryPoint:h.TaskBar});var t={logData:{feature:nt.ShowMeCategoryLayers,action:k.Clicked,data:{Cat:n,S:!1}}};f.invokeHandler(u.instrumentationDataHandlerKey,t)},t}(hi),er='<div class="printDialog" data-tag="printDialog">    <p class="printDlgHdr">        <div class="printPreviewTitle">            <TextBlock Text="{TemplateBinding resources.L_PrintPreview}" />        <\/div>        <div class="mapAndTextPrint">            <ul>                <li>                    <div class="printMapAndText mapTextOptions selected" data-tag="printMapAndText" event:click="onMapTextClick">                        <TextBlock Text="{TemplateBinding resources.L_PrintMapAndText}" />                    <\/div>                <\/li>                <li>                    <div class="printMapOnly mapTextOptions" data-tag="printMapOnly" event:click="onMapOnlyClick">                        <TextBlock Text="{TemplateBinding resources.L_PrintMapOnly}" />                    <\/div>                <\/li>                <li>                    <div class="printTextOnly mapTextOptions" data-tag="printTextOnly" event:click="onTextOnlyClick">                        <TextBlock Text="{TemplateBinding resources.L_PrintTextOnly}" />                    <\/div>                <\/li>            <\/ul>        <\/div>    <\/p>    <div>        <div class="printContent" data-tag="printContent" event:mousewheel="onMouseWheel">            <div class="printHeader" style:display="block">                <img class="bingMapsLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFcAAAATCAMAAADS32EkAAAAP1BMVEX///9RUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFBRUFAbX/lHAAAAFHRSTlMAECAwQFBgcHSAkKCwuMDQ4Obw8rSbhEIAAAGTSURBVHhe1ZLdjtwwCEY/DHbqn2KX8v7P2mGSrLKNVrPSqBc9F8jGcGQh4KMk/AP8gfznXi8IkIa85+WEK14RgH17z1t8bnz3vj+H5e6ryYc31QKAhMD8OFNkuVZhRiCQeOd9lVKORmKkshtypsO7+ROrCHzGeYO4QJc9yEB9FuhRsJrxXOoSD9oXQbTbsElINoYfXrJdfLR5JZ6enl6vRDbBrkL1LOhAsQ7UAcSnW4H4IJB21HrZB6rr4l0Aim9PrwHojuoJwDq8DKQIst+ROyTuKIbaL17kq7ch+urTG6nqGB4CPbxnIAW4T58KmYiEI+mU0yv6aQ59X7Krt33670dQJN8SysULbFbDW06rr4zADUBzvnqLF4D97o0RY+g5hyhAcrj/6H5Q6dy91ZYPXL00fXS/eyGLUCy8mlAsIxNo4fdP34n0gW7DrRFYGa0dv+BuVvXuRbc1s0K0u3kFmunM+HUZwWvWwB1KEUWRhBBwJPs5ghdkjtqCrxD9u8FiBC/xoOP7XqSM7yDbxvgabrjwB0awHHyuA7RgAAAAAElFTkSuQmCC" />            <\/div>            <div class="baseMapPrint" data-tag="baseMapPrint">                <div>                        <ul>                            <li data-tag="baseMapNotes" class="baseMapNotes">                                <table>                                    <tr>                                        <td>                                            <div>                                                <TextBlock Text="{TemplateBinding resources.L_PrintNotes}" />                                            <\/div>                                        <\/td>                                    <\/tr>                                    <tr>                                        <td>                                            <div class="baseMapTextArea screenNotes">                                                <textarea rows="9" cols="45" id="baseMapNotes" class="baseMapNotes" style:color="black" placeholder="{TemplateBinding resources.L_PrintNotesWatermark}" maxlength="{TemplateBinding notesMaxCharSize}"> <\/textarea>                                            <\/div>                                            <div class="printedNotes">                                                                                            <\/div>                                        <\/td>                                    <\/tr>                                <\/table>                            <\/li>                            <li data-tag="baseMapMiniMap" class="baseMapOverviewMap">                                <img src="{TemplateBinding overviewContextMap}" />                            <\/li>                        <\/ul>                        <div>                                <div class="printArea" data-tag="printArea">                                    <div class="printMap" data-tag="printMap">                                    <\/div>                                <\/div>                        <\/div>                <\/div>            <\/div>            <div class="taskPrintContent" data-tag="taskPrintContent">            <\/div>        <\/div>            <div class="printFooter" style:display="block">            <p class="printDlgFoot printButton">                <a class="textButton" event:click="onPrintClick" href="#" role="button" data-tag="printButton">                    <TextBlock Text="{TemplateBinding resources.L_Print_Submit}" />                <\/a>            <\/p>        <\/div>    <\/div><\/div>',l=function(){function n(){}return n.log=function(t,i,r){f.invokeHandler(u.instrumentationDataHandlerKey,{logData:{feature:n.Feature,action:t,data:i},flush:r})},n.Feature="PRT",n.Submit="S",n.Activate="A",n.Deactivate="D",n.TaskBar="T",n.Filter="FLTR",n.TaskCardHeader="H",n.TaskType="TYP",n.MapOnly="MO",n.TextOnly="TO",n.MapAndText="MAT",n}(),w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),or=function(r){function u(t){var u=this,e={},s=i,f={};return u=r.call(this,er,"PrintContainer",f,e,s)||this,u._poiLayers=[],u._map=t,u._window=n(window),u.resources=s,u._printMapReady=!1,u._printDisplayOption=0,u.onPrintDialogClose=new o,u.onPrintDialogOpen=new o,u.generateContextMapUrl(),f.onPrintClick=function(n){return u._onPrintClick(n)},f.onCloseClick=function(n){return u._onCloseClick(n)},f.onMouseWheel=function(n){return u._onMouseWheel(n)},f.onMapTextClick=function(){u._toggleMapAndText(!0,!0,u.getRootElement().select(".printMapAndText"))},f.onMapOnlyClick=function(){u._toggleMapAndText(!0,!1,u.getRootElement().select(".printMapOnly"))},f.onTextOnlyClick=function(){u._toggleMapAndText(!1,!0,u.getRootElement().select(".printTextOnly"))},u.notesMaxCharSize=d.notesMaxChars,e.defineProperty("printContentList"),u.setPrintContentList(new kt),u}return w(u,r),u.prototype.loadPrintMap=function(){var e=this,i,u,f;r.prototype.OpenDialog.call(this);i=this.getRootElement();u=i.getParent().select(".defaultPrintMessage");u.swap_class("showPrintErrorMessage","hidePrintErrorMessage");i.select(".PrintContainer").set_attr("data-tag","PrintContainer");this._hasPrintableTasks=this._getPrintTasksAvailable();this._hasPrintableTasks&&(n(".PrintContainer .baseMapPrint").removeFromParent(),this._addPrintPreviewContent());this._mapHolder=n(".PrintContainer .printMap");f={mapType:this._map.getMapType().id,zoom:this._map.getMercatorZoomLevel(),credentials:d.credentials,navigationOptions:{lockCameraAltitude:!1,lockCameraHeading:!0},enableInertia:!1,disableDiffFrame:!0,showLandmarks:!0,isPrintMode:!0,showLogo:!0,showLocateMeButton:!1,disableStreetside:!0,disableStreetsideAutoCoverage:!0,labelOptions:{labelVisibility:this._map.getLabelController().getIsLabelsEnabled()?ni.visible:ni.hidden},heading:this._map.getView().heading};t.loadMap({element:this._mapHolder,mapOptions:f},function(n){return e._finishPrintMapSetup(n)},!0)},u.prototype.addPrintContent=function(n){n&&this.getPrintContentList().insert(n)},u.prototype.setDialogSize=function(n){if(n.height&&n.width){var t=this.getRootElement();t.select(".printContent").set_style({height:(n.height>u.BaseMapHeaderFooterPadding?n.height-u.BaseMapHeaderFooterPadding:0)+"px"})}},u.prototype.onWindowResize=function(){this.setDialogSize(new gt(window.innerWidth,window.innerHeight))},u.prototype._onMouseWheel=function(n){this._mapEditOn&&n.preventDefault();n.stopPropagation()},u.prototype._toggleMapAndText=function(n,t,i){var r=this.getRootElement(),u;r.select(".isMap").swap_class(n?"hideMap":"showMap",n?"showMap":"hideMap");r.select(".isText").swap_class(t?"hideText":"showText",t?"showText":"hideText");u=n&&!t;r.select(".taskMapPrint").swap_class(u?"taskMapPrintPageBreak":"taskMapPrintNoPageBreak",u?"taskMapPrintNoPageBreak":"taskMapPrintPageBreak");this.getRootElement().select(".mapTextOptions").remove_class("selected");i.add_class("selected");this._printDisplayOption=n?t?0:1:2;l.log(l.Filter,{CLK:n?t?l.MapAndText:l.MapOnly:l.TextOnly})},u.prototype._finishPrintMapSetup=function(i){var r=this,o,u,f,e,s;this._printMiniMap=i;o=it.getMapCenter(this._map);u=it.getMercatorZoomLevel(this._map);this._map.getMapType().id!==g.birdseye&&(u=u>2&&this._hasPrintableTasks?u-1:u);this._printMiniMap=i;this.disposables.push(this._printMiniMap);this._printMiniMap.setDesiredSize({width:-1,height:-1});this._printMiniMap.setView(new bt(t.ZoomLevel.toLocation(o,u,!0),this._map.getView().heading),null);this._showMiniMapNavigationBar(!1);f=this.getRootElement();e=this._hasPrintableTasks?"taskMap":"baseMap";f.select(".printMap").add_class(e);f.select(".printArea").add_class(e);this.setDialogSize(new gt(window.innerWidth,window.innerHeight));this._windowSizeHandler=function(){return r.onWindowResize()};this._window.add_event("resize",this._windowSizeHandler);f.select(".printContent")[0].scrollTop=0;n(".mapAndTextPrint").set_style({display:this._hasPrintableTasks?"inline":"none"});s=i.getContainer();s.instanceAsync("MapInteraction",function(n){r._mapInteraction=n;n.setOptions({disableAllInteractions:!0});n.disableInteractionModes(704)});n(".taskPrintContent").add_event("click",function(n){n.preventDefault();n.stopPropagation();n.cancelBubble=!0});this._printMiniMap.overlayManagerLoaded.addOne(function(){var e,o,t,i,u,n,f;for(r._updateLandmarkClickBehavior(),e=r.getPrintContentList(),o=r.getRootElement().select(".taskPrintContent"),t=0;t<e.length;t++){for(i=e[t],r._hasPrintableTasks||r._addContentToDom(i,o,t),u=i.getLayers(),n=0;u&&n<u.length;n++)r._addLayer(u[n]);for(f=i.getLayerIds(),n=0;f&&n<f.length;n++)r.addLayerPois(f[n])}r.onPrintDialogOpen.invoke();r._printMapReady=!0;r._addEditButton();r._isPrinted=!1})},u.prototype.generateContextMapUrl=function(){var i=d.printImgOverviewMapUrlFormat,t=it.getMapCenter(this._map),r=d.credentials,n=it.getMercatorZoomLevel(this._map);n=n>4?n-2:2;this.overviewContextMap=i.replace("{credentials}",d.credentials).replace("{zoom}",n.toString()).replace("{lat}",t.latitude.toString()).replace("{lon}",t.longitude.toString()).replace("{culture}",c.dynamicProperties.market)},u.prototype._addEditButton=function(){var r=this,i=this.getRootElement().select(".printArea"),t,n;i&&(t=v._createElement("div"),t.add_class("bm_mapEditButton"),t.set_attr("data-tag","mapEditButton"),n=v._createElement("a"),n.add_class("textButton"),n.set_attr("href","#"),n.set_attr("role","button"),n.set_attr("data-tag","editButton"),n[0].innerHTML=this.resources.L_EditMap_Text,t.append(n),i.append(t),n.add_event("click",function(n){n.preventDefault();n.stopPropagation();n.cancelBubble=!0;r._toggleEditMap(n)}))},u.prototype._toggleEditMap=function(n){this._mapEditOn=n.target.innerHTML===this.resources.L_EditMap_Text;n.target.innerHTML=this._mapEditOn?this.resources.L_EditMapDone_Text:this.resources.L_EditMap_Text;this._mapInteraction.setOptions({disableAllInteractions:!this._mapEditOn});this._showMiniMapNavigationBar(this._mapEditOn)},u.prototype._addPrintPreviewContent=function(){for(var i=this.getPrintContentList(),r=this.getRootElement().select(".taskPrintContent"),t=0;t<i.length;t++)this._addContentToDom(i[t],r,t);n(".svg",this.getRootElement()[0]).inlineDataSvgs().remove_class("svg")},u.prototype._addContentToDom=function(n,t,i){var u=n&&n.getHtmlContent(),f=n&&n.getCssScope(),r;u&&(r=v._createElement("div"),r.add_class(i==0?"bm_firstTaskContent":"bm_taskContent"),r.set_attr("data-tag","taskContent-"+i),f&&r.add_class(f),r[0].innerHTML=u,t.append(r))},u.prototype._getPrintTasksAvailable=function(){for(var t=this.getPrintContentList(),n=0;n<t.length;n++)if(t[n].getHtmlContent()!=null)return!0;return!1},u.prototype._updateLandmarkClickBehavior=function(){this._printMiniMap.getLandmarksManager().then(function(n){n.removePrimitiveTapped();n.removePrimitiveHover()})},u.prototype._addLayer=function(n){if(n){var t=this._printMiniMap.getLayers();t.insert(n);this._poiLayers.push(n)}},u.prototype.addLayerPois=function(n){var r=this._printMiniMap.getLayers(),t=ii.getMapLayerById(n,this._map),s=t.getZIndex(),f,o,h,e,i;if(t.getVisible()&&n!=="Microsoft.Maps.StreetsideCoverage")if(t instanceof at){for(f=0;f<r.length;f++)if(o=r[f],o&&o.getId()===n)return;h=t;e=new at(u.PrintLayerPrefix+t.getId(),h.getDataSource(),t.getTemplateSelector(),s);e.setRenderTarget(t.getRenderTarget());r.insert(e);this._poiLayers.push(e)}else if(t instanceof ct){var a=t,c=this._map.getView(),l=a.getScene(null,it.getMapCenter(this._map),st.toScale(c.cameraLocation,st.fromLocation(c.cameraLocation,!0),!0),0);l!=null&&(i=new ct(u.PrintLayerPrefix+t.getId(),s),i.setRenderTarget(t.getRenderTarget()),i.addScene(10,l,0),r.insert(i),this._poiLayers.push(i))}},u.prototype._removeLayerPois=function(){for(var t=this._printMiniMap.getLayers(),n=this._poiLayers.pop();n;)t.remove(n),n.dispose(),n=this._poiLayers.pop()},u.prototype._showMiniMapNavigationBar=function(n){var i=this,t=this._printMiniMap.getNavigationBar();t?n?(t.setVisible(!0),t.setRotateButtonVisible(!1),t.setMapStyleSelectorControlVisible(!1),t.setLocateMeButtonVisible(!1)):t.setVisible(!1):this._printMiniMap.navigationBarLoaded.addOne(function(){return i._showMiniMapNavigationBar(n)})},u.prototype._onPrintClick=function(n){(n.preventDefault(),this._printMapReady)&&(this.prepareForPrint(),window.print(),l.log(l.Submit,{NUM_TASKS:this.getPrintContentList().length,FLTR:this._printDisplayOption==2?l.TextOnly:this._printDisplayOption==1?l.MapOnly:l.MapAndText}),d.dialogOpenAfterPrint?this._isPrinted=!0:(this.revertPrintSetup(),this._closeDialog()))},u.prototype._onCloseClick=function(n){if(n.preventDefault(),l.log(l.Deactivate),this._isPrinted&&d.dialogOpenAfterPrint&&(this._isPrinted=!1,this.revertPrintSetup()),d.dialogOpenAfterPrint){var t=document.getElementsByName("viewport")[0];t&&t.setAttribute("content","user-scalable=no, width=device-width, maximum-scale=1.0")}this._closeDialog()},u.prototype._closeDialog=function(){var n=this.getRootElement(),t=n.getParent().select(".defaultPrintMessage");t.swap_class("hidePrintErrorMessage","showPrintErrorMessage");this._mapInteraction.setOptions({disableAllInteractions:!1});n&&(n.select(".printMap").clear(),n.select(".taskPrintContent").clear());this.onPrintDialogClose.invoke();this.CloseDialog();this.dispose()},u.prototype.prepareForPrint=function(){var t=this.getRootElement(),i=t.select(".screenNotes textarea")[0],r=t.select(".printedNotes")[0];i&&r&&(r.innerHTML=n.Internals.HTMLEncode(i.value).replace(/\n/g,"<BR>"));this._printDisplayOption==2&&(this._removeLayerPois(),t.select(".isMap").removeFromParent());n("#bingLogo").inlineDataSvgs().remove_attr("height").remove_attr("width").set_attr("viewBox","50 0 92 92")},u.prototype.revertPrintSetup=function(){var t=this.getRootElement(),n=t.select(".printedNotes")[0];n&&(n.innerHTML="")},u.prototype.dispose=function(){this._removeLayerPois();this._windowSizeHandler&&(this._window.remove_event("resize",this._windowSizeHandler),this._windowSizeHandler=null);r.prototype.dispose.call(this)},u.BaseMapHeaderFooterPadding=136,u.PrintLayerPrefix="Print_",u}(lt),ii=function(){function n(t,i){this._map=t;this._taskManager=i;n.onPrintDialogClose=new o;n.onPrintDialogOpen=new o}return n.prototype.showPrintDialog=function(t){var u,r,i;t&&(rt.isFullScreen&&rt.exitFullScreen(),u=window.matchMedia("(orientation: portrait)"),d.dialogOpenAfterPrint&&u&&(r=document.getElementsByName("viewport")[0],r&&r.setAttribute("content","user-scalable=no, maximum-scale=1.0")),i=new or(this._map),i.onPrintDialogClose.addOne(function(){return n.onPrintDialogClose.invoke()}),i.onPrintDialogOpen.addOne(function(){return n.onPrintDialogOpen.invoke()}),this._createPrintContent(i,t),i.loadPrintMap(),l.log(l.Activate,{EP:t.source==1?l.TaskBar:l.TaskCardHeader,TYP:t.taskType?t.taskType:"",CD:t.data}))},n.getMapLayerById=function(n,t){for(var r=t.getLayers(),i=0;i<r.length;i++)if(n===r[i].getId())return r[i]},n.prototype._createPrintContent=function(n,t){var r,f,i;if(t.source==2&&t.taskId)r=this._taskManager.getTaskById(t.taskId),r&&r.hasPrintContent()&&n.addPrintContent(r.getPrintContent());else{var u=null,h=this._taskManager.getFocusedStack(),e=h&&h.getForegroundTask();e&&e.hasPrintContent()&&(u=e.getPrintContent(),n.addPrintContent(u));var o=new kt,c=this._map.getLayers(),s=u&&u.getLayerIds();for(f=0;f<c.length;f++)if(i=c[f],i instanceof at||i instanceof ct){if(s&&s.length>0&&s[0]===i.getId()||i.getId().indexOf("TrafficIncidents")>=0)continue;o.insert(i.getId())}o.length>0&&n.addPrintContent(new bi(null,o))}},n}(),sr='<div class="sharePrompt">    <TextBlock text="{TemplateBinding resources.L_Permalink_Prompt}" /><\/div><input class="shareUrlBox" data-tag="Share.UrlBox" type="text" value="{TemplateBinding permalinkString}" onclick="this.select();" readonly="readonly" /><a href="#" class="shareUrlShortenLink" data-tag="Share.ShortenButton" event:click="shortenClick"><TextBlock text="{TemplateBinding shortenButtonText}" /><\/a><a href="#" class="submitBtn padded" data-tag="Share.EmailButton" event:click="emailClick" role="button">    <TextBlock text="{TemplateBinding resources.L_Permalink_Email_Button_Text}" /><\/a>',w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),hr=function(t){function i(n,i,r,u){var f=this,e={};return f=t.call(this,sr,"shareContainer",{emailClick:function(n){return f._onEmailClick(n)},shortenClick:function(n){return f._onShortenClick(n)}},e)||this,e.defineProperty("permalinkString"),e.defineProperty("shortenButtonText"),f._permalink=u,f._map=n,f._taskManager=r,f.setPermalinkString(f.resources.L_Link_Generating_Text),f.setShortenButtonText(f.resources.L_ShortenButton_Text),f._isShortLinkDisplayed=!1,f.getRootElement().set_attr("data-tag","Share.Container"),f}return w(i,t),i.prototype._onPermalinkSuccess=function(t){p.isShorteningEnabled&&t.queryParameters?(n(".shareUrlShortenLink").add_class("visible"),this._permalinkResponse=t,this._makeShortenRequest(t)):this.setPermalinkString(t.permalink)},i.prototype._onPermalinkFail=function(){this.setPermalinkString(this.resources.L_Link_GenerationFailed_Text)},i.prototype._makeShortenRequest=function(n){var t=this,i=n.queryParameters,r;i.charAt(0)==="?"&&(i=n.queryParameters.substr(1));r=y.getShortenServiceUrl(i);ai.downloadJson(r,"sharedlg",function(n){t._shortPermalink=n.d;t._onShortenClick(null)},function(){t.setShortenButtonText(t.resources.L_ShortenButton_Text);t.setPermalinkString(t._permalinkResponse.permalink);t._isShortLinkDisplayed=!1})},i.prototype._onEmailClick=function(n){n&&n.preventDefault&&n.preventDefault();var t=this.getPermalinkString(),i={PL:t};window.location.href="mailto:?body="+encodeURIComponent(t);y.instLog(ut.EC,i)},i.prototype._onShortenClick=function(n){n&&n.preventDefault&&n.preventDefault();this._isShortLinkDisplayed?(this.setPermalinkString(this._permalinkResponse.permalink),this.setShortenButtonText(this.resources.L_ShortenButton_Text),this._isShortLinkDisplayed=!this._isShortLinkDisplayed):this._shortPermalink?(this.setPermalinkString(this._shortPermalink),this.setShortenButtonText(this.resources.L_LengthenButton_Text),this._isShortLinkDisplayed=!this._isShortLinkDisplayed):(this.setPermalinkString(this.resources.L_Link_Generating_Text),this._makeShortenRequest(this._permalinkResponse))},i.prototype.show=function(n){var t=this;this.OpenDialog();this._permalink.getGeneralPermalink(this._map,function(n){return t._onPermalinkSuccess(n)},function(){return t._onPermalinkFail()},n)},i}(lt),cr='<div class="bm_sharePanel" data-tag="Share.SharePanel">    <div class="header text" data-tag="Share.HeaderText">        <div class="shareTitleIcon" data-tag="shareTitleIcon"><\/div>        <div class="shareTitle">            <h2>                <TextBlock text="{StaticBinding resources.L_PermalinkHeaderPrompt_Text}" />            <\/h2>        <\/div>        <a href="#" class="panelClose" title="{StaticBinding resources.ShareClose}" data-tag="Share.CloseButton" data-share=\'{ "action": "closeShare" }\'><div class="icon svg"><\/div><\/a>    <\/div>    <div class="body">        <div class="textAndEmbed">            <div class="shareTextTitle">                <TextBlock text="{StaticBinding resources.L_PermalinkHeaderPrompt_Text}" />            <\/div>            <div class="text" style:display="{Binding hasAtLeastOneSharableStack Converter=boolToDisplay}">                <TextBlock text="{StaticBinding resources.L_PermalinkPrompt_Text}" />            <\/div>            <a href="#" class="commonButton embedButton" id="embedLink" style:display="{Binding enableEmbedPage Converter=boolToDisplay}" data-tag="Share.Embed" event:click="openEmbedPage" role="button">                <TextBlock text="{StaticBinding resources.L_PermalinkEmbed_Text}" />            <\/a>        <\/div>        <input class="text urlBox" data-tag="Share.UrlBox" type="text" value="{Binding permalinkString}" onclick="this.select();" aria-label="{StaticBinding resources.ShareUrlLabel}" />        <div class="linkBox">            <a href="#" class="{Binding sharingLinkAvailable Converter=availableToLinkClass}" id="linkStyleButton" style:display="{Binding errorMessage Converter=errorMessageToNotDisplay}" style:visibility="{Binding enableSharingVisibility}" data-tag="Share.ToggleLinkLength" event:click="toggleLinkLength" role="button">                <TextBlock text="{Binding isShortPermalinkDisplayed Converter=displayStateToLinkText}" />            <\/a>            <a href="#" class="{Binding sharingLinkAvailable Converter=availableToLinkClass}" id="copyButton" style:display="{Binding errorMessage Converter=errorMessageToNotDisplay}" style:visibility="{Binding enableSharingVisibility}" data-tag="Share.Copy" event:click="copyToClipboard" role="button">                <TextBlock text="{StaticBinding resources.L_PermalinkCopy_Text}" />            <\/a>        <\/div>        <div class="errorMessage" data-tag="Share.ErrorMessage" style:visibility="{Binding errorMessage Converter=errorMessageToVisibility}">            <TextBlock text="{Binding errorMessage}" />        <\/div>    <\/div>    <div class="footer" style:display="{Binding errorMessage Converter=errorMessageToNotDisplay}">        <a href="#" class="{Binding sharingLinkAvailable Converter=availableToShareButtonClass}" id="facebookIcon" style:visibility="{Binding enableSocialSharing}" data-tag="Share.Facebook" event:click="openFacebook" role="button" title="{StaticBinding resources.ShareFBToolTip}"><\/a>        <a href="#" class="{Binding sharingLinkAvailable Converter=availableToShareButtonClass}" id="twitterIcon" style:visibility="{Binding enableSocialSharing}" data-tag="Share.Twitter" event:click="openTwitter" role="button" title="{StaticBinding resources.ShareTwitterToolTip}"><\/a>        <a href="#" class="{Binding sharingLinkAvailable Converter=availableToShareButtonClass}" id="emailIcon" data-tag="Share.Email" event:click="openEmail" role="button" title="{StaticBinding resources.ShareEmailToolTip}"><\/a>    <\/div><\/div>',w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),lr=function(t){function r(){var r=this,u={};return r=t.call(this,u)||this,r._privates=u,u.defineProperty("sharingLinkAvailable",null,null,{defaultValue:!1,isPrivate:!0}),u.defineProperty("permalinkString",null,null,{defaultValue:i.L_Link_Generating_Text,isPrivate:!0}),u.defineProperty("isShortPermalinkDisplayed",null,null,{defaultValue:!1,isPrivate:!0}),u.defineProperty("errorMessage",null,null,{defaultValue:"",isPrivate:!0}),u.defineProperty("enableSharingVisibility",null,null,{defaultValue:p.isShorteningEnabled?"visible":"hidden",isPrivate:!0}),u.defineProperty("hasAtLeastOneSharableStack",null,null,{defaultValue:!1,isPrivate:!0}),u.defineProperty("enableEmbedPage",null,null,{defaultValue:p.enableEmbedPageLink?!0:!1,isPrivate:!0}),u.defineProperty("enableSocialSharing",null,null,{defaultValue:p.isShorteningEnabled?"visible":"hidden",isPrivate:!0}),r.controlUpdated=new o,r.setTemplate(new tt(cr,{availableToLinkClass:function(n){return n?"":"nonClickable"},availableToShareButtonClass:function(n){return n?"shareButton":"shareButton nonClickable"},availableToButtonClass:function(n){return n?"textButton":" textButton nonClickable"},displayStateToLinkText:function(n){return n?i.L_LengthenButton_Text:i.L_ShortenButton_Text},errorMessageToVisibility:function(n){return n&&n.length>0?"visible":"hidden"},errorMessageToNotDisplay:function(n){return n&&n.length>0?"none":""},boolToDisplay:function(n){return n?"":"none"},boolToNotDisplay:function(n){return n?"none":""},onDlgKeydown:function(n){var t=n,i=t.keyCode||t.which;i===27&&r._rootElement.select("*[data-tag='Share.CloseButton']")[0].click()},resources:i})),r._keydownEventHandler=function(n){return r._onKeydownEvent(n)},n(".taskLayoutContainer").add_event("keydown",r._keydownEventHandler),r.rendered.addOne(function(n){var i=n||r,t;r._rootElement=i.getRootElement();t=document.execCommand&&window.clipboardData;t||r._rootElement.select("a[data-tag='Share.Copy']").set_style({visibility:"hidden"})}),r.dataContext=r,r._lvlParam="",r._cpParam="",r}return w(r,t),r.prototype.toggleLinkLength=function(n){this._isDisposed||(n.preventDefault(),this.getIsShortPermalinkDisplayed()?this._updateLongPermalink():this._updateShortPermalink())},r.prototype.copyToClipboard=function(n){this._isDisposed||(n.preventDefault(),this._rootElement.select("input[data-tag='Share.UrlBox']")[0].select(),document.execCommand("Copy"))},r.prototype.openEmbedPage=function(n){if(!this._isDisposed){n.preventDefault();var t=p.embedPageUrl;this._lvlParam.length>0&&(t+="&"+this._lvlParam);this._cpParam.length>0&&(t+="&"+this._cpParam);t+="&form=LMLTEW";window.open(t,"EmbeddedMap");this._logEmbed(t)}},r.prototype.openEmail=function(n){var u=this,o,s,e,p,h,c,l,a;if(!this._isDisposed){n.preventDefault();o=i.L_Link_EmailTitleManyCards_Text;s=this._getOneCardShared();s!=null&&(o="Bing Maps: "+s.getTitle());var t="{0}\n",v=this._taskManager.getStacks(),f,r,y=0;for(e=0,p=v.length;e<p;e++)f=v[e],f&&f.getIsSelected()&&(r=f.getForegroundTask())&&(t+="{bullet}{0}\n".replace("{0}",r.getTitle()),(r.type==="LocalDetailsTask"||r.type==="PolygonEntityDetailsTask")&&(h=r.getOriginalName(),h&&(t+="{bullet}{0}\n".replace("{0}",h)),c=r.getNotes(),c&&(t+="{bullet}{0}\n".replace("{0}",c))),y++);t=t.replace(/{bullet}/g,y>1?" - ":"");t+="\n "+i.L_Link_EmailFooter_Text;l="mailto:?subject={0}&body={1}".replace("{0}",encodeURIComponent(o));a=function(){u._permalink.getCurrentLink(u._map,function(n){u._openEmail(n,l,t)},function(){window.console.log("Could not update permalink on the server, hence not showing email popup for stale content.")})};this.getIsShortPermalinkDisplayed()?this._permalink.shorten(function(n){u._openEmail(n,l,t)},a):a()}},r.prototype.openFacebook=function(n){n.preventDefault();var t=p.facebookShareUrl.replace("{facebookpage}",encodeURIComponent(p.facebookRedirectUrl));this._shareOnSocialMedia(1,t)},r.prototype.openTwitter=function(n){n.preventDefault();var t=p.twitterShareUrl.replace("{text}","").replace("{related}",encodeURIComponent("BingMaps,Bing"));this._shareOnSocialMedia(2,t)},r.prototype.setInitialData=function(n){n.container&&(this._container=n.container)},r.prototype.onSelectionChanged=function(n,t){if(!this._isDisposed&&this._selectedPermalinkParts&&this._selectedPermalinkParts[n]){if(this._selectedPermalinkParts[n].isEnabled=t,p.isShorteningEnabled){var i=this._permalink.isShorteningAvailable();this._privates.setEnableSharingVisibility(i?"visible":"hidden");this._privates.setEnableSocialSharing(i?"visible":"hidden")}this._updateLongPermalink()}},r.prototype.refresh=function(){var n=this;if(!this._container)throw"SharePanel cannot work without access to container";this._setState(1);this._permalink&&this._taskManager?this._recomputePanelDataAndUX():this._container.instanceAsyncAll([{name:"Permalink"},{name:"TaskManager"},{name:"Map"},{name:"ShareDataHandler"}],function(t){n._permalink=t.Permalink;n._taskManager=t.TaskManager;n._map=t.Map;n._currentSharingOptions=t.ShareDataHandler.currentSharingOptions;t.ShareDataHandler.currentSharingOptions=null;n._permalink.getGeneralPermalink(n._map,function(){return n._recomputePanelDataAndUX()},function(){n._resetSharePanelUX();n._setState(3)},n._currentSharingOptions.entryPoint)})},r.prototype._onKeydownEvent=function(t){var i=t,f=i.keyCode||i.which,r,u;f===9&&(r=this.getFirstTabbableChild(n(".taskLayoutContainer")[0]),u=this._rootElement.select("*[data-tag='Share.Email']")[0],i.target!==u||i.shiftKey?i.target===r&&i.shiftKey&&(u.focus(),i.preventDefault()):(r.focus(),i.preventDefault()))},r.prototype._trimEmailBodyIfNecessary=function(n,t,r){var u=t.replace("{0}",r),f=n.length+encodeURIComponent(u).length-3,e;return f>=y.maxIeUrlLength&&(e=f+i.L_Link_EmailFooter_Text.length+10-y.maxIeUrlLength,u=u.substr(0,u.length-e)+(" ...\n\n "+i.L_Link_EmailFooter_Text)),u},r.prototype._getOneCardShared=function(){for(var n,r=this._taskManager.getStacks(),t=null,i=0,u=r.length;i<u;i++)if(n=r[i],n&&n.getIsSelected()){if(t!=null)return null;t=n.getForegroundTask()}return t},r.prototype._recomputePanelDataAndUX=function(){var n=this;this._setState(1);this._recomputeDataModel(function(){n._resetSharePanelUX();p.isShorteningEnabled?n._updateShortPermalink():n._updateLongPermalink();var t=n._rootElement.select("*[data-tag='Share.UrlBox']")[0];t.focus();t.select()})},r.prototype.dispose=function(){t.prototype.dispose.call(this);n(".taskLayoutContainer").remove_event("keydown",this._keydownEventHandler);this._selectedPermalinkParts=null;this._taskManager=null;this._permalink=null;this._isDisposed=!0},r.prototype._recomputeDataModel=function(n){function h(n,t,i){n._permalink.getCurrentLink(n._map,function(u){var c,e,o,f,l,a,s;if(u&&u.length>=y.maxAllowedSharingLinkLength){c=n._findFarthestTaskId();n._selectedPermalinkParts[c].isEnabled=!1;h(n,!0,i);return}for(e=n._taskManager.getStacks(),o=n._taskManager.getFocusedStack(),f=0,l=e.length;f<l;f++)a=e[f].getForegroundTask().id,s=n._selectedPermalinkParts[a],e[f].setIsSelected(s&&s.isEnabled);o&&n._taskManager.focusTask(o.getForegroundTask().id);t==!0&&r.logError(u,3);i&&i()},function(){n._setState(3)})}var f,e,t,u,i,o;if(this._selectedPermalinkParts=this._permalink.getPermalinkParts(),this._currentSharingOptions&&this._currentSharingOptions.taskIds&&this._currentSharingOptions.taskIds.length>0)for(var s=Object.keys(this._selectedPermalinkParts),u=s.length,t=0;t<u;t++)f=s[t],this._currentSharingOptions.taskIds.indexOf(f)<0&&(this._selectedPermalinkParts[f].isEnabled=!1);for(e=this._taskManager.getStacks(),t=0,u=e.length;t<u;t++)i=e[t].getForegroundTask(),!i||i.isSharable()&&(i.type!=="CollectionsTask"||i.isPublicCollection())||(o=this._selectedPermalinkParts[i.id],o&&(o.isEnabled=!1));h(this,!1,n)},r.prototype._findFarthestTaskId=function(){for(var u,n=this._taskManager.getStacks(),o=this._taskManager.getFocusedStack(),e=0,t=0,s=n.length;t<s;t++)if(n[t]===o){e=t;break}for(var i=n.length-1,r=0,f=n[i].getForegroundTask().id;i>=e&&!this._selectedPermalinkParts[f]||!this._selectedPermalinkParts[f].isEnabled;)i--,f=n[i].getForegroundTask().id;for(u=n[r].getForegroundTask().id;r<=e&&!this._selectedPermalinkParts[u]||!this._selectedPermalinkParts[u].isEnabled;)r++,u=n[r].getForegroundTask().id;return t-r>i-t?u:f},r.prototype._resetSharePanelUX=function(){var i,r,t,f,u,e;if(this._privates.setHasAtLeastOneSharableStack(!1),this._rootElement.select(".svg").inlineDataSvgs().remove_class("svg"),this._setLightOrDark(this._map.getMode().mapModeType),i=this._map.getMode(),i.mapModeType===0){for(r=this._taskManager.getStacks(),t=0,f=r.length;t<f;t++)if(u=r[t],u&&(e=u.getForegroundTask())&&e.isSharable()){this._privates.setHasAtLeastOneSharableStack(!0);break}}else i.mapModeType===2&&this._privates.setEnableEmbedPage(!1);n(".taskLayoutContainer").select(".cardTitleText").set_attr("tabindex","-1")},r._getStackIndex=function(n,t,i){for(var u,r=0,f=t.length;r<f;r++)if(u=t[r],u&&(n!=null&&n==u.id||i!=null&&u.getForegroundTask().id==i))return r;return-1},r.prototype._updateLongPermalink=function(){var n=this,t;if(this._setState(1),this._selectedPermalinkParts==null){this.refresh();return}t=this._permalink.getCurrentLink(this._map,function(t){t.length>=y.maxAllowedSharingLinkLength?(n._setState(2),r.logError(t,2)):(n._privates.setPermalinkString(t),n._setTempParamValues(t),n._privates.setIsShortPermalinkDisplayed(!1),n._setState(0))},function(){n._setState(3);r.logError("",4)})},r.prototype._updateShortPermalink=function(){var n=this;this._currentState!=2&&(this._setState(1),this._permalink.shorten(function(t,i){n._privates.setEnableSharingVisibility("visible");n._privates.setIsShortPermalinkDisplayed(!0);n._privates.setPermalinkString(t);i&&n._setTempParamValues(i);n._setState(0)},function(){n._privates.setEnableSharingVisibility("hidden");n._updateLongPermalink();r.logError("",1)}))},r.prototype._setState=function(n){this._currentState=n;switch(n){case 0:this._privates.setErrorMessage("");this._privates.setSharingLinkAvailable(!0);this._privates.setEnableSocialSharing(p.isShorteningEnabled?"visible":"hidden");this._rootElement.select("input[data-tag='Share.UrlBox']")[0].select();break;case 1:this._privates.setErrorMessage("");this._privates.setSharingLinkAvailable(!1);this._privates.setPermalinkString(i.L_Link_Generating_Text);break;case 2:this._privates.setSharingLinkAvailable(!1);this._privates.setIsShortPermalinkDisplayed(!1);this._privates.setPermalinkString("");this._privates.setErrorMessage(i.L_Link_TooManyItemsSelected_Text);this._privates.setEnableSocialSharing("hidden");break;default:this._privates.setErrorMessage(i.L_Link_GenerationFailed_Text);this._privates.setIsShortPermalinkDisplayed(!1);this._privates.setSharingLinkAvailable(!1);this._privates.setPermalinkString("");this._privates.setEnableSocialSharing("hidden");this._rootElement.select("input[data-tag='Share.UrlBox']")[0].select()}this.controlUpdated.invoke({state:n,control:this})},r.prototype._logEmail=function(n){var t={PL:n};y.instLog(ut.EC,t)},r.prototype._logEmbed=function(n){var t={PL:n};y.instLog(ut.EMC,t)},r.prototype._logSocialMedia=function(n,t){var i={PL:n},r=t==1?ut.FB:ut.TW;y.instLog(r,i)},r.logError=function(n,t){var i={PL:n,ERR:t};y.instLog(ut.SEW,i)},r.prototype._setLightOrDark=function(n){var i=!0,r=this._rootElement.select(".header"),u="dark",t;n===0&&(t=this._map.getMapType().id,i=t===g.aerial||t===g.birdseye);i?r.add_class(u):r.remove_class(u)},r.prototype._setTempParamValues=function(n){var t=/lvl=([^&]*)/ig.exec(n),i=/cp=([^&]*)/ig.exec(n),r=/style=[o|b]&/ig.exec(n);t&&t.length&&(this._lvlParam=t[0]);i&&i.length&&(this._cpParam=i[0]);r&&r.length&&this._privates.setEnableEmbedPage(!1)},r.prototype._shareOnSocialMedia=function(n,t){var i=this;this._isDisposed||(p.isShorteningEnabled&&this._permalink.isShorteningAvailable()?this._permalink.shorten(function(r,u){var f=r&&r.length>0?r.trim():u.trim();t=t.replace("{url}",encodeURIComponent(f));i._openPopUp(t);i._logSocialMedia(r,n)},function(){var u=i.getPermalinkString().trim();u&&u.length>0&&(u=u.replace(/form=[a-z0-9]+/i,"form="+(n===1?y.facebookFormCode:y.twitterFormCode)),t=t.replace("{url}",encodeURIComponent(u)),i._openPopUp(t),i._logSocialMedia(u,n));r.logError("",5)},n):this._privates.setEnableSocialSharing("hidden"))},r.prototype._openPopUp=function(n){var t=(screen.availWidth-r._popupWidth)/2,i=(screen.availHeight-r._popupHeight)/2,u="width="+r._popupWidth+",height="+r._popupHeight+",screenX="+t+",screenY="+i+",left="+t+",top="+i+",status,scrollbars,resizable";window.open(n,"",u)},r.prototype._openEmail=function(n,t,i){i=this._trimEmailBodyIfNecessary(t,i,n);this._logEmail(n);window.location.href=t.replace("{1}",encodeURIComponent(i))},r._minEmbedHeight=530,r._minEmbedWidth=800,r._popupWidth=550,r._popupHeight=420,r}(ot);tt.registerControl("SharePanel",lr);var w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),ri=function(n){function t(){var t=this,r=i;return t=n.call(this,ar,"bm_BirdsEyeV2DialogContainer",{onCloseClick:function(n){return t._onCloseClick(n)}},{},r)||this}return w(t,n),t.prototype.showBEDialog=function(){this.OpenDialog()},t.prototype._onCloseClick=function(n){n&&n.preventDefault();this.CloseDialog();this.dispose()},t}(lt),ar='<div class="bm_BirdsEyeV2Dialog">    <div class="bm_BEMessageTitleContainer" data-tag="BEMessageTitleContainer">        <div class="BEV2TitleText" title="{TemplateBinding resources.BEV2WelcomeText}">            <TextBlock Text="{TemplateBinding resources.BEV2WelcomeText}" />        <\/div>    <\/div>    <div class="bm_BEMessageContainer" data-tag="BEMessageContainer">        <div class="bm_BEV2Introduction" title="{TemplateBinding resources.BEV2Introduction}">            <TextBlock Text="{TemplateBinding resources.BEV2Introduction}" />        <\/div>    <\/div>    <div class="bm_BEImageIntroContainer" data-tag="BEImageIntroContainer">        <div class="bm_ImageIntroText" title="{TemplateBinding resources.BEV2ImageIntroduction}">            <TextBlock Text="{TemplateBinding resources.BEV2ImageIntroduction}" />        <\/div>    <\/div>    <div class="bm_BEImagesContainer" data-tag="BEImagesContainer">        <div class="bm_DetailsImageContainer" data-tag="DetailsImageContainer">            <div class="bm_DetailsInstructionText" title="{TemplateBinding resources.BEV2DetailsInstruction}">                <TextBlock Text="{TemplateBinding resources.BEV2DetailsInstruction}" />            <\/div>            <img src="" class="bm_DetailsBEV2Image" data-tag="DetailsBEV2Image"/>        <\/div>        <div class="bm_TransientImageContainer" data-tag="TransientImageContainer">            <div class="bm_TransientInstructonText" title="{TemplateBinding resources.BEV2TransientLensInstruction}">                <TextBlock Text="{TemplateBinding resources.BEV2TransientLensInstruction}" />            <\/div>            <img src="" class="bm_TransientBEV2Image" data-tag="TransientBEV2Image" />        <\/div>    <\/div>    <div class="bm_BEv2TipNoteContainer" data-tag="BEv2TipNoteContainer">        <div class="bm_BEv2NoteText" title="TemplateBinding resources.BEV2TipNote">            <TextBlock Text="{TemplateBinding resources.BEV2TipNote}"/>        <\/div>    <\/div><\/div>',w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),vr=function(r){function u(n,f,e){var o=r.call(this,e)||this;return yt=yt.replace("{commuteControlTitle}",i.L_CmtControlTitleText).replace("{commuteAddLoc}",i.L_CmtControlAddLocationText).replace("{commuteTime30}",i.L_CmtControlCommuteTime30Text).replace("{commuteTime45}",i.L_CmtControlCommuteTime45Text).replace("{commuteTime60}",i.L_CmtControlCommuteTime60Text).replace("{commuteTime15}",i.L_CmtControlCommuteTime15Text).replace("{commutePeak}",i.L_CmtControlCommutePeak_Text).replace("{commuteOffPeak}",i.L_CmtControlCommuteOffPeak_Text).replace("{editText}",i.L_CmtEditText).replace("{doneText}",i.L_CmtDoneText),o.setTemplate(new tt(yt,{stopEvent:function(n){return o._stopEvent(n)},onAddLocClicked:function(){return o._onAddLocClicked()},onDeleteClicked:function(n){return o._onDeleteClicked(n)},onTimeClicked:function(n){return o._onTimeClicked(n)},onPeakClicked:function(n){return o._onPeakClicked(n)},onEditClicked:function(){return o._onEditClicked()},onDoneClicked:function(){return o._onDoneClicked()}})),o._map=n,o._cmtFeatureConfig=c.features.commutability,o.defineProperty("addressValue"),o.defineProperty("addressTwoValue"),o._secondAddrEnabled=!1,o._time=u._defaultSelectedTime,o._departureTime=o._cmtFeatureConfig.peakTime,o._location=o._map.getView().cameraLocation,o._pushpinLayer=new ci("Commutability_Layer"),o._pushpin=new t.Pushpin(o._location,{icon:u._iconSvg,draggable:!0,text:i.L_CmtControlPushpinTitle}),o._pushpinLayer.add(o._pushpin),t.Events.addHandler(o._pushpin,"dragend",function(n){return o._pushpinDragEnd(o._pushpin,n)}),o._isochroneOptions={intersectionOptions:{fillColor:o._cmtFeatureConfig.intersectFillColor},showIntersection:!!o._cmtFeatureConfig.showIntersection,showUnion:!!o._cmtFeatureConfig.showUnion,showIsochrones:!!o._cmtFeatureConfig.showIsochrones,applyCardinalSpline:typeof o._cmtFeatureConfig.applyCardinalSpline=="boolean"?o._cmtFeatureConfig.applyCardinalSpline:!1},o._isochroneLayer=f,o._isochroneLayer.attachMap(o._map),o._isochroneLayer.setOptions(o._isochroneOptions),o._updateCompleteHandler=function(){return o._updateIsochroneCompleted()},o._isochroneLayer.downloadCompleted.add(o._updateCompleteHandler),o._isochroneLayer.downloadCompleted.addOne(function(){return o._postInit()}),o._isochroneLayers=[],t.loadModule("Microsoft.Maps.AutoSuggest",function(){var r=o._cmtFeatureConfig.autoSuggestMaxResult||5,n={maxResults:r,map:o._map,serpOptions:{showMyLocation:!0,suggestionTypes:"place,business,address",selectFirstOnEnter:!0}},i=t.AutosuggestManager;o._asManagerOne=new i(n);o._asManagerOne.attachAutosuggest("#cmt_addressOne","#cmt_addressDivOne",function(n){o._processAutoSuggestResult(n.location,n.formattedSuggestion,!0);b.logAddressChange(h.Autosuggest,!1)});o._asManagerTwo=new i(n);o._asManagerTwo.attachAutosuggest("#cmt_addressTwo","#cmt_addressDivTwo",function(n){o._processAutoSuggestResult(n.location,n.formattedSuggestion,!1);b.logAddressChange(h.Autosuggest,!0)});o.disposables.push(o._asManagerOne,o._asManagerTwo)}),o}return w(u,r),u.prototype.attachIsochrone=function(){this._map.getLayers().insertAll([this._isochroneLayer,this._pushpinLayer]);this._updateIsochrone();b.logColtrolActivation()},u.prototype.detachIsochrone=function(){this._isochroneLayer.detachMap(this._map);this._map.getLayers().remove(this._isochroneLayer);this._map.getLayers().remove(this._pushpinLayer);b.logColtrolDeactivation()},u.prototype._postInit=function(){var f=this,e,r,i;for(this._cmtContainer=n("#cmt_container"),this._title=n("#cmt_title"),this._addAddressButton=n("#cmt_BtmArea"),this._addressesSection=n("#cmt_addresses"),this._address=n("#cmt_addressOne"),this._addressOneClose=n("#cmt_delete_1"),this._addressTwo=n("#cmt_addressTwo"),this._addressTwoContainer=n("#cmt_addressDivTwo"),this._editButton=n("#cmt_edit"),this._doneButton=n("#cmt_done"),this._peakButton=n("#cmt_peak"),this._loader=n("#cmt_loader"),this._currentSelectedTimeElement=n(".cmt_time.selected"),this._currentSelectedDepartureElement=n(".cmt_Depart .selected"),this._reverseGeocode(this._location,1),this._loader.add_class("hidden"),e=t.IsochroneLayer,r=0;r<u._times.length;r++){if(u._times[r]===this._time){this._isochroneLayers.push(this._isochroneLayer);this._isochroneLayer.downloadError.add(function(n){return f._handleIsochroneError(n)});continue}i=new e;i.setOptions(this._isochroneOptions);i.attachMap(this._map);i.downloadError.add(function(n){return f._handleIsochroneError(n)});this._isochroneLayers.push(i)}},u.prototype._stopEvent=function(n){n.stopPropagation()},u.prototype._onEditClicked=function(){var r=n("#cmt_body"),t,i;r.remove_class("hidden");this._cmtContainer.remove_class("collapsed");this._editButton.add_class("hidden");this._doneButton.remove_class("hidden");this._adjustAutosuggestWidth();t=this._map.getNavigationBar().getLocateMeControl();i=t&&t.getGeochainControl();i&&i.setIsCollapsed(!0);b.logButtonClick(this._editButton.get_attr("id"))},u.prototype._onDoneClicked=function(){var t=n("#cmt_body");t.add_class("hidden");this._cmtContainer.add_class("collapsed");this._doneButton.add_class("hidden");this._editButton.remove_class("hidden");b.logButtonClick(this._doneButton.get_attr("id"))},u.prototype._onAddLocClicked=function(){var n=this;this._downloadingIsochrone||this._addAddressButton.has_class("hidden")||(this._addAddressButton.add_class("hidden"),this._addressOneClose.remove_class("hidden"),this._addressTwoContainer.remove_class("hidden"),this._secondAddrEnabled=!0,this._locationTwo=this._map.getView().cameraLocation,this._pushpinTwo=new ki(this._locationTwo,{icon:u._iconSvg,draggable:!0,text:i.L_CmtControlPushpinTwoTitle}),this._pushpinLayer&&this._pushpinLayer.add(this._pushpinTwo),t.Events.addHandler(this._pushpinTwo,"dragend",function(t){return n._pushpinDragEnd(n._pushpinTwo,t)}),this._reverseGeocode(this._locationTwo,2),this._cmtContainer.add_class("expanded"),this._addressesSection.add_class("expanded"),this._updateMapView(),this._updateIsochrone(),this._adjustAutosuggestWidth(),b.logButtonClick(this._addAddressButton.get_attr("id")))},u.prototype._onDeleteClicked=function(n){if(!this._downloadingIsochrone){var t=n.target,i=t.id;i=="cmt_delete_1"&&(this._location=this._locationTwo,this._pushpin.setLocation(this._location),this.setAddressValue(this.getAddressTwoValue()));this.setAddressTwoValue("");this._addAddressButton.remove_class("hidden");this._addressOneClose.add_class("hidden");this._addressTwoContainer.add_class("hidden");this._cmtContainer.remove_class("expanded");this._addressesSection.remove_class("expanded");this._pushpinLayer.remove(this._pushpinTwo);this._secondAddrEnabled=!1;this._updateMapView();this._updateIsochrone();this._updateTitle();this._adjustAutosuggestWidth()}},u.prototype._onTimeClicked=function(t){var e=t.target,r=e.id,i,f;if(!this._downloadingIsochrone&&r!==this._currentSelectedTimeElement.get_attr("id")&&!n("#"+r).has_class("disabled")){if(i=u._timeButtonIds.indexOf(r),f=this._isochroneLayers[i],f.downloading||f.getIsochrones().length>0)this._changeSelectedTime(i);else while(i<u._timeButtonIds.length)this._enableTimeButton(i,!1),i++;b.logButtonClick(r)}},u.prototype._onPeakClicked=function(t){var r=t.target,i=r.id;this._downloadingIsochrone||i===this._currentSelectedDepartureElement.get_attr("id")||(this._departureTime=i==="cmt_peak"?this._cmtFeatureConfig.peakTime:this._cmtFeatureConfig.offPeakTime,this._currentSelectedDepartureElement.remove_class("selected"),this._currentSelectedDepartureElement=n("#"+i),this._currentSelectedDepartureElement.add_class("selected"),this._updateIsochrone(),this._updateTitle(),b.logButtonClick(i))},u.prototype._processAutoSuggestResult=function(n,t,i){var r=i?this._location:this._locationTwo;wt.areEqual(r,n,!0)||(i?(this._location=n,this.setAddressValue(t),this._pushpin.setLocation(n)):(this._locationTwo=n,this.setAddressTwoValue(t),this._pushpinTwo.setLocation(n)),this._updateMapView(),this._updateIsochrone(),this._updateTitle())},u.prototype._updateIsochrone=function(){var t,n,f;for(this._resetTimeButtons(),t=null,(!this._peakButton||this._peakButton.has_class("selected"))&&(t="timeWithTraffic"),n=0;n<u._times.length;n++){var i=u._times[n],e=this._buildRequest(i,t,1),r=[e];this._secondAddrEnabled&&(f=this._buildRequest(i,t,2),r.push(f));i===this._time?(this._setControlBusy(!0),this._isochroneLayer.setRequests(r)):this._isochroneLayers&&this._isochroneLayers.length>n&&this._isochroneLayers[n]&&this._isochroneLayers[n].setRequests(r)}},u.prototype._buildRequest=function(n,t,i){var u=this._location,f=this._cmtFeatureConfig.isochroneOneFillColor,r,e;return i===2&&(u=this._locationTwo,f=this._cmtFeatureConfig.isochroneTwoFillColor),r={maxTime:n,startPoint:u,departTime:this._departureTime,optimize:t,displayOptions:{fillColor:f,strokeColor:this._cmtFeatureConfig.isochroneStrokeColor}},e=v._isFeatureEnabled("commuteOutline"),e&&(r.displayOptions.strokeThickness=this._cmtFeatureConfig.isochroneStrokeThickness,r.displayOptions.secondaryStrokeColor=this._cmtFeatureConfig.isochroneSecondaryStrokeColor,r.displayOptions.secondaryStrokeThickness=this._cmtFeatureConfig.isochroneSecondaryStrokeThickness),r},u.prototype._updateMapView=function(){var t=this._map.getMercatorZoomLevel(),i=this._location,n,r,u;if(this._locationTwo&&!wt.areEqual(this._location,this._locationTwo)){if(n=this._map.getMode().getMapViewForLocationsInView([this._location,this._locationTwo]),r=st.fromLocation(n.cameraLocation,!1),r<=t){this._map.setView(n);return}i=n.cameraLocation}u=new bt(st.toLocation(i,t,!0));this._map.setView(u)},u.prototype._adjustAutosuggestWidth=function(){var n=this._address.get_size().width;this._asManagerOne.setOptions({serpOptions:{width:n}});this._asManagerTwo.setOptions({serpOptions:{width:n}})},u.prototype._pushpinDragEnd=function(n,t){n===this._pushpin?(this._location=t.location,this._reverseGeocode(t.location,1),b.logAddressChange(h.POI,!1)):n===this._pushpinTwo&&(this._locationTwo=t.location,this._reverseGeocode(t.location,2),b.logAddressChange(h.POI,!0));this._downloadingIsochrone?this._updateWhenDownloadFinish=!0:(this._updateIsochrone(),this._updateWhenDownloadFinish=!1)},u.prototype._updateIsochroneCompleted=function(){this._setControlBusy(!1);this._updateWhenDownloadFinish&&(this._updateIsochrone(),this._updateWhenDownloadFinish=!1)},u.prototype._updateTitle=function(){var n=this.getAddressValue().split(",")[0],r,t,u;this._secondAddrEnabled&&this.getAddressTwoValue()&&(r=this.getAddressTwoValue().split(",")[0],n!==r&&(n=i.L_CmtTitleAddresses.replace("{addr1}",n).replace("{addr2}",r)));t=this._peakButton.has_class("selected")?i.L_CmtControlCommutePeak_Text:i.L_CmtControlCommuteOffPeak_Text;t=t.toLowerCase();u=i.L_CmtTitle.replace("{time}",this._time).replace("{addresses}",n).replace("{trafficCondition}",t);this._title.set_text(u);var f=parseInt(this._title.get_style("height")),e=parseInt(this._title.get_style("lineHeight")),o=Math.round(f/e);o===1?this._title.set_style({padding:"9px 0px"}):this._title.set_style({padding:"0px"})},u.prototype._setControlBusy=function(n){this._downloadingIsochrone=n;n?(this._loader&&this._loader.remove_class("hidden"),this._cmtContainer&&this._cmtContainer.add_class("disabled")):(this._cmtContainer&&this._cmtContainer.remove_class("disabled"),this._loader&&this._loader.add_class("hidden"))},u.prototype._handleIsochroneError=function(t){var r=t.isochroneLayer;if(r){var i=this._isochroneLayers.indexOf(r),e=u._timeButtonIds[i],f=n("#"+e);if(f.has_class("selected")&&(this._setControlBusy(!1),this._changeSelectedTime(0)),!f.has_class("disabled"))while(i<u._timeButtonIds.length)this._enableTimeButton(i,!1),i++}},u.prototype._changeSelectedTime=function(n){this._selectTimeButton(n);this._isochroneLayer.downloadCompleted.remove(this._updateCompleteHandler);var t=this._map.getLayers();t.remove(this._isochroneLayer);this._isochroneLayer=this._isochroneLayers[n];this._isochroneLayer.downloadCompleted.add(this._updateCompleteHandler);t.insert(this._isochroneLayer);this._isochroneLayer.downloading&&this._setControlBusy(!0);this._updateTitle()},u.prototype._selectTimeButton=function(t){if(t>=0){this._currentSelectedTimeElement.remove_class("selected");var i=u._timeButtonIds[t];this._currentSelectedTimeElement=n("#"+i);this._currentSelectedTimeElement&&this._currentSelectedTimeElement.add_class("selected");this._time=u._times[t]}},u.prototype._resetTimeButtons=function(){for(var f,r,t=0,i=u._timeButtonIds;t<i.length;t++)f=i[t],r=n("#"+f),r&&r.remove_class("disabled")},u.prototype._enableTimeButton=function(t,i){var r=n("#"+u._timeButtonIds[t]);r&&(i?r.remove_class("disabled"):r.add_class("disabled"))},u.prototype._reverseGeocode=function(n,t){var i=this,r=new di;r.reverseGeocode(n,function(r){var u="";u=r&&r.success&&r.addressList&&r.addressList.length>0&&r.addressList[0].formattedAddress?r.addressList[0].formattedAddress:n.latitude.toFixed(4)+","+n.longitude.toFixed(4);t==1?(i._address.set_attr("value",u),i.setAddressValue(u)):(i._addressTwo.set_attr("value",u),i.setAddressTwoValue(u));i._updateTitle()})},u._timeButtonIds=["cmt_time15","cmt_time30","cmt_time45","cmt_time60"],u._defaultSelectedTime=15,u._times=[15,30,45,60],u._iconSvg='<svg width="24" height="31" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path d="M11 0C4.924 0 0 4.924 0 11c.011 1.666.708 3.474 1.68 5.348 1.668 3.173 4.223 6.517 6.125 8.822a91.61 91.61 0 0 0 2.517 2.898.906.906 0 0 0 1.35 0 91.509 91.509 0 0 0 2.516-2.898 76.508 76.508 0 0 0 2.587-3.306c1.278-1.734 2.561-3.648 3.54-5.516C21.292 14.474 21.99 12.667 22 11 22 4.924 17.076.002 11 0z" id="a"/><path id="b" d="M0 .25h12v7.008H0z"/><path id="d" d="M0 9.75h12V1H0z"/><\/defs><g fill="none" fill-rule="evenodd"><g transform="translate(1 1)" fill-rule="nonzero"><use fill="#111" fill-rule="evenodd" xlink:href="#a"/><path stroke="#FFF" d="M11-.5c6.352.002 11.5 5.149 11.5 11.503-.01 1.617-.6 3.386-1.742 5.577-.907 1.73-2.117 3.595-3.58 5.58a76.458 76.458 0 0 1-2.604 3.328c-.75.91-1.638 1.926-2.53 2.915a1.406 1.406 0 0 1-2.094 0 89.323 89.323 0 0 1-2.531-2.915c-2.55-3.09-4.732-6.15-6.184-8.91C.097 14.382-.489 12.618-.5 11-.5 4.648 4.648-.5 11-.5z"/><\/g><g transform="translate(6 7.75)"><mask id="c" fill="#fff"><use xlink:href="#b"/><\/mask><path d="M2.88 5.12a1.25 1.25 0 1 0-1.76 1.777A1.25 1.25 0 0 0 2.88 5.12zM10 3H1a1 1 0 0 0-1 1v1.39a2.09 2.09 0 0 1 3.48-.87c.396.391.619.923.62 1.48h2.8a2.1 2.1 0 1 1 4.2 0h.9V5a2 2 0 0 0-2-2zM8.11 5.11A1.25 1.25 0 1 0 9 4.75a1.25 1.25 0 0 0-.88.37l-.01-.01zM7.29.54a.997.997 0 0 0-.71-.29h-4a1 1 0 0 0-.89.55L1 2.25h8L7.29.54z" fill="#FFF" mask="url(#c)"/><\/g><\/g><\/svg>',u}(ot),w=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),yr=function(n){function t(t){var i=this;if(t){var r=t.getRootElement(),u=new pi(0,0);i=n.call(this,r,1,u)||this}return i}return w(t,n),t}(yi),b=function(){function n(){}return n.logAddressChange=function(t,i){var r={logData:{feature:a.Commutability,action:n.AddressChange,data:{METHOD:t,IS:i}}};f.invokeHandler(u.instrumentationDataHandlerKey,r)},n.logButtonClick=function(n){var t={logData:{feature:a.Commutability,action:k.Clicked,data:{BID:n}}};f.invokeHandler(u.instrumentationDataHandlerKey,t)},n.logColtrolActivation=function(){var n={logData:{feature:a.Commutability,action:k.Activated,data:{EP:h.ContextMenu}}};f.invokeHandler(u.instrumentationDataHandlerKey,n)},n.logColtrolDeactivation=function(){var n={logData:{feature:a.Commutability,action:k.Deactivated,data:{EP:h.ContextMenu}}};f.invokeHandler(u.instrumentationDataHandlerKey,n)},n}(),yt='<div id="cmt_container" class="cmt_container collapsed" event:click="stopEvent" event:mousedown="stopEvent" event:mouseup="stopEvent" event:mouseout="stopEvent" event:contextmenu="stopEvent" event:focus="stopEvent">    <div id="cmt_topArea" class="cmt_topArea">        <div id="cmt_titleWrapper" class="cmt_titleWrapper">            <div id="cmt_title" class="cmt_title">{commuteControlTitle}<\/div>        <\/div>        <button id="cmt_edit" class="cmt_button" event:click="onEditClicked">{editText}<\/button>        <button id="cmt_done" class="cmt_button hidden" event:click="onDoneClicked">{doneText}<\/button>    <\/div>    <div id="cmt_body" class="cmt_body hidden">        <div class="cmt_addresses" id="cmt_addresses">            <div class="cmt_addressDiv" id="cmt_addressDivOne">                <input type="text" class="cmt_address" id="cmt_addressOne" Value="{Binding addressValue Mode=TwoWay}" />                <div id="cmt_delete_1" class="cmt_delete hidden" event:click="onDeleteClicked"><\/div>            <\/div>            <div class="cmt_addressDiv hidden" id="cmt_addressDivTwo">                <input type="text" class="cmt_address" id="cmt_addressTwo" Value="{Binding addressTwoValue Mode=TwoWay}" />                <div id="cmt_delete_2" class="cmt_delete" event:click="onDeleteClicked"><\/div>            <\/div>        <\/div>        <div class="cmt_settings">            <div class="cmt_timeArea">                <button id="cmt_time15" class="cmt_button cmt_time selected" event:click="onTimeClicked">{commuteTime15}<\/button>                <button id="cmt_time30" class="cmt_button cmt_time" event:click="onTimeClicked">{commuteTime30}<\/button>                <button id="cmt_time45" class="cmt_button cmt_time" event:click="onTimeClicked">{commuteTime45}<\/button>                <button id="cmt_time60" class="cmt_button cmt_time" event:click="onTimeClicked">{commuteTime60}<\/button>            <\/div>            <div class="cmt_Depart">                <button id="cmt_peak" class="cmt_button selected" event:click="onPeakClicked">{commutePeak}<\/button>                <button id="cmt_offpeak" class="cmt_button" event:click="onPeakClicked">{commuteOffPeak}<\/button>            <\/div>        <\/div>        <div id="cmt_BtmArea" class="cmt_BtmArea" event:click="onAddLocClicked">            <div id="cmt_addIcon" class="cmt_addIcon"><\/div>            <div id="cmt_addAdr" class="cmt_addAddr">{commuteAddLoc}<\/div>        <\/div>    <\/div>    <div id="cmt_loader" class="cmt_loader">        <div id="cmt_spinner" class="cmt_spinner"><\/div>    <\/div><\/div>',pr=function(){function t(){this._contextualTaskBarId="bm_contextualTaskbar";this._taskIdToContextualTaskbarMapping={};this._taskIdToRecommendedLayers={}}return t.getInstance=function(){return t._instance||(t._instance=new t),t._instance},t.prototype.initialize=function(){this._initialized||(this._initialized=!0,this._subscribeToTaskFocusEvent())},t.prototype._subscribeToTaskFocusEvent=function(){var t=this;typeof sj_evt!="undefined"&&(sj_evt.bind("OnCardFocus",function(n){t._setTheContextualTaskbar(n&&n[1]);t._adjustElements();t._promoteMapLayersInTaskBar(n)}),sj_evt.bind("OnCardRefresh",function(n){delete t._taskIdToContextualTaskbarMapping[t._currentTaskId];delete t._taskIdToRecommendedLayers[t._currentTaskId];var i=n&&n[1];t._setTheContextualTaskbar(i,t._currentTaskId);t._adjustElements();t._promoteMapLayersInTaskBar(n,t._currentTaskId)}),sj_evt.bind("OnAllTaskStacksRemoved",function(){t._currentContextualTaskbar&&(t._currentContextualTaskbar.removeFromParent(),t._currentContextualTaskbar=null,t._adjustElements());t._currentTaskId=null;ft.getInstance().setRecommendedCategories([])}),sj_evt.bind("OnTaskStackRemoved",function(n){var i=n&&n[1];i&&i.id===t._currentTaskId&&(t._removeCurrentContextualTaskBar(),t._adjustElements())}),sj_evt.bind("HideContextualTaskbar",function(){n(".bm_contextualAndShowMe").set_style({display:"none"})}),sj_evt.bind("ShowContextualTaskbar",function(){n(".bm_contextualAndShowMe").set_style({display:""})}))},t.prototype._removeCurrentContextualTaskBar=function(){this._currentContextualTaskbar&&(delete this._taskIdToContextualTaskbarMapping[this._currentTaskId],delete this._taskIdToRecommendedLayers[this._currentTaskId],this._currentContextualTaskbar.removeFromParent(),this._currentContextualTaskbar=null,this._currentTaskId=null,ft.getInstance().setRecommendedCategories([]))},t.prototype._promoteMapLayersInTaskBar=function(n,t){var r=n&&n[1],u,i;r&&(u=t||r.get_attr("data-taskid"),i=this._taskIdToRecommendedLayers[u],i||(i=this._getMapLayers(r)||[]),ft.getInstance().setRecommendedCategories(i),this._taskIdToRecommendedLayers[u]=i)},t.prototype._getMapLayers=function(n){var r,u=Microsoft.Maps.GlobalConfig.features.localSearch.showLocalCardsOnOneMap,t,i;return(v._isLocalOrRealEstateScenarioOverlayShownOnSerp()||u)&&n&&(t=n.select("div[data-maplayers]"),t&&t.length&&(i=t.get_attr("data-maplayers"),i&&(r=i.split(",")))),r},t.prototype._setTheContextualTaskbar=function(t,i){if(this._contextualTaskbarContainer=this._contextualTaskbarContainer||n("#bm_contextualTaskbarContainer"),t){var e=i||t.get_attr("data-taskid"),f=t.select("#"+this._contextualTaskBarId),u=this._taskIdToContextualTaskbarMapping[e],r=void 0;u?u===f||f[0]===u[0]?r=u:u.length>0&&f.length===0?r=u:u[0]!==f[0]&&(r=f):r=f;this._taskIdToContextualTaskbarMapping[e]=r;r!==this._currentContextualTaskbar&&(this._currentContextualTaskbar&&this._currentContextualTaskbar.removeFromParent(),r&&(this._currentContextualTaskbar=r,this._currentTaskId=e,this._currentContextualTaskbar.getParent()!==this._contextualTaskbarContainer&&(this._currentContextualTaskbar.removeFromParent(),this._currentContextualTaskbar.set_attr("style","display:block")),this._contextualTaskbarContainer.append(this._currentContextualTaskbar),sj_evt.fire("filterattached")))}},t.prototype._adjustElements=function(){var t=this._currentContextualTaskbar&&this._currentContextualTaskbar.length!==0;t||ft.getInstance().initialized?(n(".taskLayoutContainer").add_class("WithContextualTaskBar"),n("#MicrosoftNav").add_class("WithContextualTaskBar")):(n(".taskLayoutContainer").remove_class("WithContextualTaskBar"),n("#MicrosoftNav").remove_class("WithContextualTaskBar"))},t}();pr.getInstance().initialize();t.TaskBar=tr;r.SharingDialogViewModel=hr;r.PrintManager=ii;r.SlideOutMenu=typeof SlideOutMenu!="undefined"?SlideOutMenu:undefined;r.BirdsEyeV2DialogViewModel=typeof ri!="undefined"?ri:undefined;r.CommutabilityControl=vr;r.CommutabilityControlOverlay=yr;r.UserTipControl=ur}catch(ui){if(t.logger)t.logger.logCriticalError(ui);else throw ui;}}).call(window)